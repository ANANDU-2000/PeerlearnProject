{% extends 'base.html' %}
{% load static %}
{% load users_filters %}

{% block title %}Advanced Profile - PeerLearn{% endblock %}

{% block extra_head %}
<style>
    .profile-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .profile-card {
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .tab-active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    .tab-inactive {
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
    }
    .tab-inactive:hover {
        background: #f8fafc;
        color: #374151;
        transform: translateY(-1px);
    }
    .activity-item {
        transition: all 0.3s ease;
    }
    .activity-item:hover {
        background: #f8fafc;
        transform: translateX(4px);
    }
    .image-upload-area {
        border: 2px dashed #cbd5e1;
        transition: all 0.3s ease;
    }
    .image-upload-area:hover {
        border-color: #667eea;
        background: #f8fafc;
    }
    .image-upload-area.dragover {
        border-color: #667eea;
        background: #e0e7ff;
    }
    .profile-image-preview {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }
    .stats-card {
        background: linear-gradient(45deg, #f8fafc, #e2e8f0);
        border-left: 4px solid #667eea;
        transition: transform 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="advancedProfile()" x-init="init()">
    <!-- Profile Header -->
    <div class="profile-gradient text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
                <!-- Profile Image -->
                <div class="relative">
                    {% if user.profile_image %}
                        <img src="{{ user.profile_image.url }}" alt="Profile" class="profile-image-preview">
                    {% else %}
                        <div class="profile-image-preview bg-white bg-opacity-20 flex items-center justify-center text-4xl font-bold text-white">
                            {{ user.avatar_letter }}
                        </div>
                    {% endif %}
                    
                    <!-- Online Status -->
                    <div class="absolute bottom-4 right-4 w-6 h-6 bg-green-500 rounded-full border-4 border-white"></div>
                    
                    <!-- Edit Button -->
                    <button @click="showImageUpload = true" 
                            class="absolute top-0 right-0 bg-white bg-opacity-90 text-gray-700 p-2 rounded-full hover:bg-opacity-100 transition-all duration-300">
                        <i class="fas fa-camera text-sm"></i>
                    </button>
                </div>
                
                <!-- Profile Info -->
                <div class="flex-1 text-center md:text-left">
                    <div class="flex items-center justify-center md:justify-start space-x-3 mb-2">
                        <h1 class="text-3xl font-bold">{{ user.get_full_name|default:user.username }}</h1>
                        {% if user.is_verified %}
                            <div class="bg-blue-500 p-1 rounded-full" title="Verified User">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                        {% endif %}
                        {% if user.is_premium %}
                            <div class="bg-yellow-500 p-1 rounded-full" title="Premium User">
                                <i class="fas fa-crown text-white text-xs"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="space-y-2 text-blue-100">
                        <p class="text-lg">{{ user.role|title }} at PeerLearn</p>
                        {% if user.bio %}
                            <p class="text-sm">{{ user.bio }}</p>
                        {% endif %}
                        {% if user.location %}
                            <p class="text-sm">
                                <i class="fas fa-map-marker-alt mr-2"></i>{{ user.location }}
                            </p>
                        {% endif %}
                        {% if user.website %}
                            <p class="text-sm">
                                <i class="fas fa-globe mr-2"></i>
                                <a href="{{ user.website }}" target="_blank" class="hover:text-white">{{ user.website }}</a>
                            </p>
                        {% endif %}
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="flex justify-center md:justify-start space-x-6 mt-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold">{{ user.total_sessions }}</p>
                            <p class="text-sm text-blue-200">Sessions</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold">{{ user.followers_count }}</p>
                            <p class="text-sm text-blue-200">Followers</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold">{{ user.following_count }}</p>
                            <p class="text-sm text-blue-200">Following</p>
                        </div>
                        {% if user.is_mentor %}
                        <div class="text-center">
                            <p class="text-2xl font-bold">â‚¹{{ user.total_earnings|default:0 }}</p>
                            <p class="text-sm text-blue-200">Earned</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col space-y-3">
                    <button @click="activeTab = 'edit'" 
                            class="bg-white bg-opacity-20 text-white px-6 py-3 rounded-xl font-semibold hover:bg-opacity-30 transition-all duration-300 flex items-center space-x-2">
                        <i class="fas fa-edit"></i>
                        <span>Edit Profile</span>
                    </button>
                    
                    <div class="flex space-x-2">
                        <!-- Bell Notification -->
                        <button @click="showNotifications = !showNotifications" 
                                class="bg-white bg-opacity-20 text-white p-3 rounded-xl hover:bg-opacity-30 transition-all duration-300 relative">
                            <i class="fas fa-bell"></i>
                            <span x-show="unreadCount > 0" 
                                  x-text="unreadCount"
                                  class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-pulse"></span>
                        </button>
                        
                        <!-- Settings -->
                        <button @click="activeTab = 'settings'" 
                                class="bg-white bg-opacity-20 text-white p-3 rounded-xl hover:bg-opacity-30 transition-all duration-300">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8">
        <!-- Navigation Tabs -->
        <div class="bg-white rounded-2xl shadow-lg mb-8 p-2">
            <div class="flex flex-wrap gap-2">
                <button @click="activeTab = 'overview'"
                        :class="activeTab === 'overview' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-chart-pie"></i>
                    <span>Overview</span>
                </button>
                
                <button @click="activeTab = 'sessions'"
                        :class="activeTab === 'sessions' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-video"></i>
                    <span>Sessions</span>
                </button>
                
                <button @click="activeTab = 'payments'"
                        :class="activeTab === 'payments' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
                
                <button @click="activeTab = 'activity'"
                        :class="activeTab === 'activity' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-history"></i>
                    <span>Activity</span>
                </button>
                
                <button @click="activeTab = 'followers'"
                        :class="activeTab === 'followers' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-users"></i>
                    <span>Social</span>
                </button>
                
                <button @click="activeTab = 'edit'"
                        :class="activeTab === 'edit' ? 'tab-active' : 'tab-inactive'"
                        class="px-6 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center space-x-2">
                    <i class="fas fa-edit"></i>
                    <span>Edit Profile</span>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'" class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="stats-card p-6 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Sessions</p>
                                    <p class="text-3xl font-bold text-gray-900">{{ user.total_sessions }}</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-video text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        {% if user.is_mentor %}
                        <div class="stats-card p-6 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Earnings</p>
                                    <p class="text-3xl font-bold text-gray-900">â‚¹{{ user.total_earnings|default:0 }}</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="stats-card p-6 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Followers</p>
                                    <p class="text-3xl font-bold text-gray-900">{{ user.followers_count }}</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-heart text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card p-6 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Profile Views</p>
                                    <p class="text-3xl font-bold text-gray-900" x-text="profileViews">0</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-eye text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Skills/Interests -->
                    <div class="profile-card p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4">
                            {% if user.is_mentor %}Skills{% else %}Interests{% endif %}
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            {% if user.is_mentor and user.skills %}
                                {% for skill in user.get_skills_list %}
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ skill }}
                                    </span>
                                {% endfor %}
                            {% elif user.is_learner and user.interests %}
                                {% for interest in user.get_interests_list %}
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ interest }}
                                    </span>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-500">No {{ user.is_mentor|yesno:"skills,interests" }} added yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sessions Tab -->
                <div x-show="activeTab === 'sessions'" class="space-y-6">
                    <div class="profile-card p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4">Session History</h3>
                        <div class="space-y-4" id="sessionsContainer">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading sessions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div x-show="activeTab === 'payments'" class="space-y-6">
                    <div class="profile-card p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4">Payment History</h3>
                        <div class="space-y-4" id="paymentsContainer">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading payment history...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div x-show="activeTab === 'activity'" class="space-y-6">
                    <div class="profile-card p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                        <div class="space-y-3" id="activityContainer">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading activity...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Social Tab -->
                <div x-show="activeTab === 'followers'" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Followers -->
                        <div class="profile-card p-6 rounded-xl">
                            <h3 class="text-lg font-semibold mb-4">Followers ({{ user.followers_count }})</h3>
                            <div class="space-y-3" id="followersContainer">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading followers...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Following -->
                        <div class="profile-card p-6 rounded-xl">
                            <h3 class="text-lg font-semibold mb-4">Following ({{ user.following_count }})</h3>
                            <div class="space-y-3" id="followingContainer">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading following...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Profile Tab -->
                <div x-show="activeTab === 'edit'" class="space-y-6">
                    <div class="profile-card p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4">Edit Profile</h3>
                        <form @submit.prevent="updateProfile()" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                    <input type="text" x-model="editForm.first_name" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                    <input type="text" x-model="editForm.last_name" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                                <textarea x-model="editForm.bio" rows="3"
                                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                    <input type="text" x-model="editForm.location" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                    <input type="url" x-model="editForm.website" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            {% if user.is_mentor %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Skills (comma-separated)</label>
                                <input type="text" x-model="editForm.skills" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            {% elif user.is_learner %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Interests (comma-separated)</label>
                                <input type="text" x-model="editForm.interests" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            {% endif %}
                            
                            <div class="flex space-x-4">
                                <button type="submit" 
                                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                    <i class="fas fa-save"></i>
                                    <span>Save Changes</span>
                                </button>
                                <button type="button" @click="resetForm()" 
                                        class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                                    Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Quick Actions -->
                <div class="profile-card p-6 rounded-xl">
                    <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        {% if user.is_mentor %}
                            <a href="{% url 'create_session' %}" 
                               class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Create Session</span>
                            </a>
                        {% endif %}
                        
                        <a href="{% url 'session_list' %}" 
                           class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                            <i class="fas fa-search"></i>
                            <span>Browse Sessions</span>
                        </a>
                        
                        <button @click="activeTab = 'settings'" 
                                class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center space-x-2">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Notifications -->
                <div class="profile-card p-6 rounded-xl">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        Recent Notifications
                        <span x-show="unreadCount > 0" 
                              x-text="unreadCount"
                              class="bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"></span>
                    </h3>
                    <div class="space-y-3" id="notificationsContainer">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-bell text-2xl mb-2"></i>
                            <p class="text-sm">No new notifications</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div x-show="showImageUpload" 
         x-transition 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Update Profile Image</h3>
            
            <div class="image-upload-area p-6 rounded-lg text-center mb-4">
                <input type="file" 
                       id="profileImageInput" 
                       accept="image/*" 
                       @change="handleImageUpload($event)"
                       class="hidden">
                
                <label for="profileImageInput" class="cursor-pointer">
                    <div class="space-y-2">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                        <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                        <p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
                    </div>
                </label>
            </div>
            
            <div x-show="imagePreview" class="mb-4">
                <img :src="imagePreview" alt="Preview" class="w-32 h-32 rounded-full mx-auto object-cover">
            </div>
            
            <div class="flex space-x-3">
                <button @click="uploadImage()" 
                        :disabled="!selectedImage"
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Upload
                </button>
                <button @click="showImageUpload = false; resetImageUpload()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function advancedProfile() {
    return {
        activeTab: 'overview',
        showImageUpload: false,
        showNotifications: false,
        unreadCount: 0,
        profileViews: 1247,
        
        // Image upload
        selectedImage: null,
        imagePreview: null,
        
        // Edit form
        editForm: {
            first_name: '{{ user.first_name }}',
            last_name: '{{ user.last_name }}',
            bio: '{{ user.bio }}',
            location: '{{ user.location }}',
            website: '{{ user.website }}',
            {% if user.is_mentor %}
            skills: '{{ user.skills }}',
            {% elif user.is_learner %}
            interests: '{{ user.interests }}',
            {% endif %}
        },
        
        init() {
            this.loadTabData();
            this.loadNotifications();
            this.setupRealTimeUpdates();
        },
        
        loadTabData() {
            switch(this.activeTab) {
                case 'sessions':
                    this.loadSessions();
                    break;
                case 'payments':
                    this.loadPayments();
                    break;
                case 'activity':
                    this.loadActivity();
                    break;
                case 'followers':
                    this.loadSocial();
                    break;
            }
        },
        
        async loadSessions() {
            try {
                const response = await fetch('/api/user/sessions/');
                const data = await response.json();
                this.renderSessions(data.sessions || []);
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        },
        
        async loadPayments() {
            try {
                const response = await fetch('/api/user/payments/');
                const data = await response.json();
                this.renderPayments(data.payments || []);
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        },
        
        async loadActivity() {
            try {
                const response = await fetch('/api/user/activity/');
                const data = await response.json();
                this.renderActivity(data.activities || []);
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        },
        
        async loadSocial() {
            try {
                const [followersRes, followingRes] = await Promise.all([
                    fetch('/api/user/followers/'),
                    fetch('/api/user/following/')
                ]);
                
                const followers = await followersRes.json();
                const following = await followingRes.json();
                
                this.renderFollowers(followers.users || []);
                this.renderFollowing(following.users || []);
            } catch (error) {
                console.error('Error loading social data:', error);
            }
        },
        
        async loadNotifications() {
            try {
                const response = await fetch('/api/notifications/');
                const data = await response.json();
                this.unreadCount = data.unread_count || 0;
                this.renderNotifications(data.notifications || []);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        },
        
        setupRealTimeUpdates() {
            // WebSocket connection for real-time updates
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
            
            const socket = new WebSocket(wsUrl);
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'notification') {
                    this.unreadCount++;
                    this.loadNotifications();
                }
            };
        },
        
        handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedImage = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imagePreview = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },
        
        async uploadImage() {
            if (!this.selectedImage) return;
            
            const formData = new FormData();
            formData.append('profile_image', this.selectedImage);
            
            try {
                const response = await fetch('/api/user/profile-image/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                    },
                    body: formData
                });
                
                if (response.ok) {
                    location.reload(); // Refresh to show new image
                } else {
                    alert('Error uploading image');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Error uploading image');
            }
        },
        
        resetImageUpload() {
            this.selectedImage = null;
            this.imagePreview = null;
            document.getElementById('profileImageInput').value = '';
        },
        
        async updateProfile() {
            try {
                const response = await fetch('/api/user/profile/', {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.editForm)
                });
                
                if (response.ok) {
                    alert('Profile updated successfully!');
                    location.reload();
                } else {
                    alert('Error updating profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile');
            }
        },
        
        resetForm() {
            this.editForm = {
                first_name: '{{ user.first_name }}',
                last_name: '{{ user.last_name }}',
                bio: '{{ user.bio }}',
                location: '{{ user.location }}',
                website: '{{ user.website }}',
                {% if user.is_mentor %}
                skills: '{{ user.skills }}',
                {% elif user.is_learner %}
                interests: '{{ user.interests }}',
                {% endif %}
            };
        },
        
        renderSessions(sessions) {
            const container = document.getElementById('sessionsContainer');
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No sessions found.</p>';
                return;
            }
            
            container.innerHTML = sessions.map(session => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-900">${session.title}</h4>
                            <p class="text-sm text-gray-600">${session.date}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${session.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            ${session.status}
                        </span>
                    </div>
                </div>
            `).join('');
        },
        
        renderPayments(payments) {
            const container = document.getElementById('paymentsContainer');
            if (payments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No payment history found.</p>';
                return;
            }
            
            container.innerHTML = payments.map(payment => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-900">â‚¹${payment.amount}</h4>
                            <p class="text-sm text-gray-600">${payment.description}</p>
                            <p class="text-xs text-gray-500">${payment.date}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${payment.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${payment.status}
                        </span>
                    </div>
                </div>
            `).join('');
        },
        
        renderActivity(activities) {
            const container = document.getElementById('activityContainer');
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No recent activity.</p>';
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-item border-l-4 border-blue-500 pl-4 py-2">
                    <p class="text-sm font-medium text-gray-900">${activity.description}</p>
                    <p class="text-xs text-gray-500">${activity.time_ago}</p>
                </div>
            `).join('');
        },
        
        renderFollowers(users) {
            const container = document.getElementById('followersContainer');
            this.renderUserList(container, users, 'No followers yet.');
        },
        
        renderFollowing(users) {
            const container = document.getElementById('followingContainer');
            this.renderUserList(container, users, 'Not following anyone yet.');
        },
        
        renderUserList(container, users, emptyMessage) {
            if (users.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessage}</p>`;
                return;
            }
            
            container.innerHTML = users.map(user => `
                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                        ${user.avatar_letter}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${user.name}</p>
                        <p class="text-xs text-gray-500">${user.role}</p>
                    </div>
                </div>
            `).join('');
        },
        
        renderNotifications(notifications) {
            const container = document.getElementById('notificationsContainer');
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-bell text-2xl mb-2"></i>
                        <p class="text-sm">No new notifications</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notifications.slice(0, 5).map(notif => `
                <div class="p-3 hover:bg-gray-50 rounded-lg border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-900">${notif.title}</p>
                    <p class="text-xs text-gray-600">${notif.message}</p>
                    <p class="text-xs text-gray-500 mt-1">${notif.time_ago}</p>
                </div>
            `).join('');
        },
        
        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        }
    }
}
</script>
{% endblock %}