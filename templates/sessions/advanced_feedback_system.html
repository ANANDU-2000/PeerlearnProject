<!-- Advanced WebRTC Feedback & Inbox System -->
<div id="feedbackInbox" class="fixed top-4 right-4 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-40 hidden transform transition-all duration-300">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-t-xl">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                </svg>
                <h3 class="font-semibold">Session Feedback</h3>
            </div>
            <div class="flex items-center space-x-2">
                <span id="unreadCount" class="hidden bg-red-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                <button onclick="closeFeedbackInbox()" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b border-gray-200">
        <button onclick="switchFeedbackTab('quick')" id="quickTab" class="flex-1 px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50">
            Quick Feedback
        </button>
        <button onclick="switchFeedbackTab('inbox')" id="inboxTab" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            Inbox <span id="inboxBadge" class="ml-1 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full hidden">3</span>
        </button>
    </div>

    <!-- Quick Feedback Tab -->
    <div id="quickFeedbackTab" class="p-4 space-y-4 max-h-96 overflow-y-auto">
        <!-- Live Rating -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
            <h4 class="font-medium text-gray-800 mb-2">Rate Current Session</h4>
            <div class="flex justify-center space-x-1 mb-2">
                <button onclick="setLiveRating(1)" class="live-star w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors">‚≠ê</button>
                <button onclick="setLiveRating(2)" class="live-star w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors">‚≠ê</button>
                <button onclick="setLiveRating(3)" class="live-star w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors">‚≠ê</button>
                <button onclick="setLiveRating(4)" class="live-star w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors">‚≠ê</button>
                <button onclick="setLiveRating(5)" class="live-star w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors">‚≠ê</button>
            </div>
            <p id="liveRatingText" class="text-xs text-gray-600 text-center">Rate how the session is going</p>
        </div>

        <!-- Quick Actions -->
        <div class="space-y-2">
            <h4 class="font-medium text-gray-800">Quick Actions</h4>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="sendQuickFeedback('thumbs_up')" class="flex items-center justify-center p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                    üëç Great!
                </button>
                <button onclick="sendQuickFeedback('question')" class="flex items-center justify-center p-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                    ‚ùì Question
                </button>
                <button onclick="sendQuickFeedback('slow_down')" class="flex items-center justify-center p-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors">
                    ‚èØÔ∏è Slow Down
                </button>
                <button onclick="sendQuickFeedback('repeat')" class="flex items-center justify-center p-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors">
                    üîÑ Repeat
                </button>
            </div>
        </div>

        <!-- Live Message -->
        <div class="border-t pt-4">
            <h4 class="font-medium text-gray-800 mb-2">Send Message</h4>
            <div class="space-y-2">
                <textarea 
                    id="liveFeedbackMessage" 
                    placeholder="Ask a question or share feedback..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="3"></textarea>
                <button onclick="sendLiveFeedback()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                    Send to Mentor
                </button>
            </div>
        </div>
    </div>

    <!-- Inbox Tab -->
    <div id="inboxTab" class="hidden p-4 space-y-3 max-h-96 overflow-y-auto">
        <!-- Message List -->
        <div id="messageList" class="space-y-3">
            <!-- Messages will be dynamically loaded -->
        </div>
        
        <!-- Empty State -->
        <div id="emptyInbox" class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
            </svg>
            <p class="text-sm">No messages yet</p>
        </div>
    </div>
</div>

<!-- Floating Feedback Button -->
<button id="feedbackToggle" onclick="toggleFeedbackInbox()" class="fixed top-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 z-30">
    <div class="relative">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
        </svg>
        <span id="feedbackNotification" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
    </div>
</button>

<!-- Reply Modal -->
<div id="replyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 w-96 max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Reply to Message</h3>
            <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
        
        <!-- Original Message -->
        <div id="originalMessage" class="bg-gray-50 p-3 rounded-lg mb-4 border-l-4 border-blue-500">
            <p class="text-sm text-gray-600 mb-1">Original message:</p>
            <p id="originalMessageText" class="text-sm text-gray-800"></p>
        </div>
        
        <!-- Reply Input -->
        <div class="space-y-3">
            <textarea 
                id="replyMessage" 
                placeholder="Type your reply..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                rows="4"></textarea>
            <div class="flex space-x-2">
                <button onclick="closeReplyModal()" class="flex-1 px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <button onclick="sendReply()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Advanced Feedback System
let feedbackInboxOpen = false;
let currentTab = 'quick';
let currentLiveRating = 0;
let currentReplyId = null;
let messages = [];
let unreadMessages = 0;

// Toggle Feedback Inbox
function toggleFeedbackInbox() {
    const inbox = document.getElementById('feedbackInbox');
    const toggle = document.getElementById('feedbackToggle');
    
    if (feedbackInboxOpen) {
        closeFeedbackInbox();
    } else {
        inbox.classList.remove('hidden');
        inbox.classList.add('transform', 'scale-100', 'opacity-100');
        toggle.classList.add('hidden');
        feedbackInboxOpen = true;
        
        // Load messages when opening inbox
        if (currentTab === 'inbox') {
            loadMessages();
        }
    }
}

function closeFeedbackInbox() {
    const inbox = document.getElementById('feedbackInbox');
    const toggle = document.getElementById('feedbackToggle');
    
    inbox.classList.add('hidden');
    toggle.classList.remove('hidden');
    feedbackInboxOpen = false;
}

// Switch Tabs
function switchFeedbackTab(tab) {
    currentTab = tab;
    
    // Update tab appearance
    const quickTab = document.getElementById('quickTab');
    const inboxTab = document.getElementById('inboxTab');
    const quickContent = document.getElementById('quickFeedbackTab');
    const inboxContent = document.getElementById('inboxTab');
    
    if (tab === 'quick') {
        quickTab.className = 'flex-1 px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50';
        inboxTab.className = 'flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700';
        quickContent.classList.remove('hidden');
        inboxContent.classList.add('hidden');
    } else {
        inboxTab.className = 'flex-1 px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50';
        quickTab.className = 'flex-1 px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700';
        inboxContent.classList.remove('hidden');
        quickContent.classList.add('hidden');
        loadMessages();
    }
}

// Live Rating System
function setLiveRating(rating) {
    currentLiveRating = rating;
    
    // Update star display
    const stars = document.querySelectorAll('.live-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.style.color = '#fbbf24'; // yellow-400
        } else {
            star.style.color = '#d1d5db'; // gray-300
        }
    });
    
    // Update text
    const ratingTexts = {
        1: 'Needs improvement',
        2: 'Fair session',
        3: 'Good session',
        4: 'Great session!',
        5: 'Excellent session! üéâ'
    };
    
    document.getElementById('liveRatingText').textContent = ratingTexts[rating];
    
    // Send live rating to mentor
    sendLiveRating(rating);
}

// Send Quick Feedback
function sendQuickFeedback(type) {
    const feedbackMessages = {
        'thumbs_up': 'üëç Great job! Keep it up!',
        'question': '‚ùì I have a question about this topic',
        'slow_down': '‚èØÔ∏è Could you please slow down a bit?',
        'repeat': 'üîÑ Could you repeat that part?'
    };
    
    const message = feedbackMessages[type];
    showFeedbackToast(message, 'sent');
    
    // Send to backend
    sendFeedbackToMentor({
        type: 'quick_action',
        action: type,
        message: message,
        timestamp: new Date().toISOString()
    });
}

// Send Live Feedback Message
function sendLiveFeedback() {
    const message = document.getElementById('liveFeedbackMessage').value.trim();
    
    if (!message) {
        alert('Please enter a message');
        return;
    }
    
    showFeedbackToast('Message sent to mentor', 'sent');
    
    // Send to backend
    sendFeedbackToMentor({
        type: 'live_message',
        message: message,
        timestamp: new Date().toISOString()
    });
    
    // Clear input
    document.getElementById('liveFeedbackMessage').value = '';
}

// Send Live Rating
function sendLiveRating(rating) {
    sendFeedbackToMentor({
        type: 'live_rating',
        rating: rating,
        timestamp: new Date().toISOString()
    });
}

// Send Feedback to Mentor (Backend Integration)
async function sendFeedbackToMentor(feedbackData) {
    try {
        const response = await fetch(`/sessions/api/sessions/{{ session.id }}/live-feedback/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                ...feedbackData,
                session_id: '{{ session.id }}',
                sender_id: '{{ user.id }}'
            })
        });
        
        if (response.ok) {
            console.log('Feedback sent successfully');
        }
    } catch (error) {
        console.error('Error sending feedback:', error);
    }
}

// Load Messages
async function loadMessages() {
    try {
        const response = await fetch(`/sessions/api/sessions/{{ session.id }}/feedback-messages/`);
        if (response.ok) {
            const data = await response.json();
            messages = data.messages || [];
            renderMessages();
            updateUnreadCount();
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Render Messages
function renderMessages() {
    const messageList = document.getElementById('messageList');
    const emptyInbox = document.getElementById('emptyInbox');
    
    if (messages.length === 0) {
        messageList.innerHTML = '';
        emptyInbox.classList.remove('hidden');
        return;
    }
    
    emptyInbox.classList.add('hidden');
    
    messageList.innerHTML = messages.map(message => `
        <div class="bg-gray-50 p-3 rounded-lg border ${message.unread ? 'border-blue-300 bg-blue-50' : 'border-gray-200'}">
            <div class="flex justify-between items-start mb-2">
                <div class="text-sm font-medium text-gray-800">
                    ${message.sender_name}
                    ${message.unread ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded-full">New</span>' : ''}
                </div>
                <div class="text-xs text-gray-500">${formatTime(message.timestamp)}</div>
            </div>
            <p class="text-sm text-gray-700 mb-2">${message.message}</p>
            <div class="flex space-x-2">
                <button onclick="replyToMessage(${message.id}, '${message.message}')" class="text-xs text-blue-600 hover:text-blue-800">
                    Reply
                </button>
                <button onclick="markAsRead(${message.id})" class="text-xs text-gray-500 hover:text-gray-700">
                    Mark Read
                </button>
            </div>
        </div>
    `).join('');
}

// Reply to Message
function replyToMessage(messageId, originalMessage) {
    currentReplyId = messageId;
    document.getElementById('originalMessageText').textContent = originalMessage;
    document.getElementById('replyModal').classList.remove('hidden');
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.add('hidden');
    document.getElementById('replyMessage').value = '';
    currentReplyId = null;
}

function sendReply() {
    const replyText = document.getElementById('replyMessage').value.trim();
    
    if (!replyText) {
        alert('Please enter a reply');
        return;
    }
    
    // Send reply to backend
    sendFeedbackToMentor({
        type: 'reply',
        reply_to: currentReplyId,
        message: replyText,
        timestamp: new Date().toISOString()
    });
    
    showFeedbackToast('Reply sent successfully', 'sent');
    closeReplyModal();
}

// Mark Message as Read
async function markAsRead(messageId) {
    try {
        const response = await fetch(`/sessions/api/messages/${messageId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            // Update message in local array
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.unread = false;
                renderMessages();
                updateUnreadCount();
            }
        }
    } catch (error) {
        console.error('Error marking message as read:', error);
    }
}

// Update Unread Count
function updateUnreadCount() {
    const unreadCount = messages.filter(m => m.unread).length;
    const badge = document.getElementById('inboxBadge');
    const notification = document.getElementById('feedbackNotification');
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
        notification.textContent = unreadCount;
        notification.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
        notification.classList.add('hidden');
    }
}

// Show Feedback Toast
function showFeedbackToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 p-3 rounded-lg text-white z-50 transform transition-all duration-300 ${
        type === 'sent' ? 'bg-green-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transform = 'translateY(100px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

// Utility Functions
function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Initialize feedback system
document.addEventListener('DOMContentLoaded', function() {
    // Load initial messages if needed
    loadMessages();
    
    // Set up periodic message checking
    setInterval(loadMessages, 10000); // Check every 10 seconds
});

// WebSocket integration for real-time updates
if (typeof socket !== 'undefined') {
    socket.addEventListener('message', function(event) {
        const data = JSON.parse(event.data);
        
        if (data.type === 'feedback_message') {
            // Add new message to list
            messages.unshift(data.message);
            renderMessages();
            updateUnreadCount();
            
            // Show notification if inbox is closed
            if (!feedbackInboxOpen) {
                showFeedbackToast('New message received', 'received');
            }
        }
    });
}
</script>

<style>
/* Custom styles for feedback system */
.live-star {
    transition: color 0.2s ease, transform 0.1s ease;
}

.live-star:hover {
    transform: scale(1.1);
}

#feedbackInbox {
    max-height: calc(100vh - 2rem);
}

/* Animation classes */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.animate-slide-in {
    animation: slideInRight 0.3s ease-out;
}
</style>