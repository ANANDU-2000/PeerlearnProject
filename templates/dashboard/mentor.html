{% extends 'base.html' %}

{% block title %}Mentor Dashboard - PeerLearn{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" 
     x-data="mentorDashboard()" 
     x-init="initDashboard()">
    
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Mentor Dashboard</h1>
        <p class="mt-2 text-gray-600">Manage your sessions and connect with learners</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-feather="calendar" class="h-8 w-8 text-blue-600"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Sessions</dt>
                        <dd class="text-lg font-medium text-gray-900" x-text="stats.totalSessions">0</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-feather="users" class="h-8 w-8 text-green-600"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Learners</dt>
                        <dd class="text-lg font-medium text-gray-900" x-text="stats.totalLearners">0</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-feather="clock" class="h-8 w-8 text-yellow-600"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Upcoming Sessions</dt>
                        <dd class="text-lg font-medium text-gray-900" x-text="stats.upcomingSessions">0</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-feather="star" class="h-8 w-8 text-purple-600"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Average Rating</dt>
                        <dd class="text-lg font-medium text-gray-900" x-text="stats.averageRating">0.0</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Session Button -->
    <div class="mb-6">
        <a href="{% url 'create_session' %}" 
           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i data-feather="plus" class="h-5 w-5 mr-2"></i>
            Create New Session
        </a>
    </div>
    
    <!-- Tabs -->
    <div class="bg-white shadow rounded-lg">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button @click="activeTab = 'today'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'today', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'today'}"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Today
                </button>
                <button @click="activeTab = 'upcoming'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'upcoming', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'upcoming'}"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Upcoming
                </button>
                <button @click="activeTab = 'past'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'past', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'past'}"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Past Sessions
                </button>
                <button @click="activeTab = 'drafts'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'drafts', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'drafts'}"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Drafts
                </button>
            </nav>
        </div>
        
        <!-- Tab Content -->
        <div class="p-6">
            <!-- Today's Sessions -->
            <div x-show="activeTab === 'today'" x-cloak>
                <div x-show="sessions.today.length === 0" class="text-center py-12">
                    <i data-feather="calendar" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No sessions today</h3>
                    <p class="mt-1 text-sm text-gray-500">Create a new session to get started.</p>
                </div>
                
                <div class="space-y-4" x-show="sessions.today.length > 0">
                    <template x-for="session in sessions.today" :key="session.id">
                        <div class="border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900" x-text="session.title"></h3>
                                    <p class="mt-1 text-sm text-gray-500" x-text="session.description"></p>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                        <span x-text="formatTime(session.schedule)"></span>
                                        <span x-text="`${session.current_participants}/${session.max_participants} participants`"></span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full"
                                              :class="getStatusClass(session.status)"
                                              x-text="session.status.toUpperCase()"></span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button x-show="session.can_start" 
                                            @click="startSession(session.id)"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                        <i data-feather="play" class="h-4 w-4 mr-1"></i>
                                        Go Live
                                    </button>
                                    <button x-show="session.status === 'live'" 
                                            @click="joinRoom(session.id)"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <i data-feather="video" class="h-4 w-4 mr-1"></i>
                                        Join Room
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Upcoming Sessions -->
            <div x-show="activeTab === 'upcoming'" x-cloak>
                <div x-show="sessions.upcoming.length === 0" class="text-center py-12">
                    <i data-feather="clock" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No upcoming sessions</h3>
                    <p class="mt-1 text-sm text-gray-500">Schedule sessions to meet with learners.</p>
                </div>
                
                <div class="space-y-4" x-show="sessions.upcoming.length > 0">
                    <template x-for="session in sessions.upcoming" :key="session.id">
                        <div class="border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900" x-text="session.title"></h3>
                                    <p class="mt-1 text-sm text-gray-500" x-text="session.description"></p>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                        <span x-text="formatDateTime(session.schedule)"></span>
                                        <span x-text="`${session.current_participants}/${session.max_participants} participants`"></span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i data-feather="edit" class="h-4 w-4 mr-1"></i>
                                        Edit
                                    </button>
                                    <button @click="cancelSession(session.id)"
                                            class="inline-flex items-center px-3 py-2 border border-red-300 text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                                        <i data-feather="x" class="h-4 w-4 mr-1"></i>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Past Sessions -->
            <div x-show="activeTab === 'past'" x-cloak>
                <div x-show="sessions.past.length === 0" class="text-center py-12">
                    <i data-feather="archive" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No past sessions</h3>
                    <p class="mt-1 text-sm text-gray-500">Your completed sessions will appear here.</p>
                </div>
                
                <div class="space-y-4" x-show="sessions.past.length > 0">
                    <template x-for="session in sessions.past" :key="session.id">
                        <div class="border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900" x-text="session.title"></h3>
                                    <p class="mt-1 text-sm text-gray-500" x-text="session.description"></p>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                        <span x-text="formatDateTime(session.schedule)"></span>
                                        <span x-text="`${session.current_participants} participants`"></span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                            COMPLETED
                                        </span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i data-feather="bar-chart" class="h-4 w-4 mr-1"></i>
                                        Analytics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Draft Sessions -->
            <div x-show="activeTab === 'drafts'" x-cloak>
                <div x-show="sessions.drafts.length === 0" class="text-center py-12">
                    <i data-feather="edit" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No draft sessions</h3>
                    <p class="mt-1 text-sm text-gray-500">Draft sessions will appear here before publishing.</p>
                </div>
                
                <div class="space-y-4" x-show="sessions.drafts.length > 0">
                    <template x-for="session in sessions.drafts" :key="session.id">
                        <div class="border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900" x-text="session.title"></h3>
                                    <p class="mt-1 text-sm text-gray-500" x-text="session.description"></p>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                        <span x-text="formatDateTime(session.schedule)"></span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                            DRAFT
                                        </span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i data-feather="edit" class="h-4 w-4 mr-1"></i>
                                        Edit
                                    </button>
                                    <button @click="publishSession(session.id)"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <i data-feather="send" class="h-4 w-4 mr-1"></i>
                                        Publish
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function mentorDashboard() {
    return {
        activeTab: 'today',
        sessions: {
            today: [],
            upcoming: [],
            past: [],
            drafts: []
        },
        stats: {
            totalSessions: 0,
            totalLearners: 0,
            upcomingSessions: 0,
            averageRating: 0.0
        },
        
        async initDashboard() {
            await this.loadSessions();
            this.connectWebSocket();
        },
        
        async loadSessions() {
            try {
                const response = await fetch('/sessions/api/list/');
                const sessions = await response.json();
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                this.sessions.today = sessions.filter(session => {
                    const sessionDate = new Date(session.schedule);
                    return sessionDate >= today && sessionDate < tomorrow && session.status === 'scheduled';
                });
                
                this.sessions.upcoming = sessions.filter(session => {
                    const sessionDate = new Date(session.schedule);
                    return sessionDate >= tomorrow && session.status === 'scheduled';
                });
                
                this.sessions.past = sessions.filter(session => 
                    session.status === 'completed' || session.status === 'cancelled'
                );
                
                this.sessions.drafts = sessions.filter(session => 
                    session.status === 'draft'
                );
                
                // Update stats
                this.stats.totalSessions = sessions.length;
                this.stats.upcomingSessions = this.sessions.today.length + this.sessions.upcoming.length;
                
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        },
        
        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
            
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'session_update') {
                    this.loadSessions(); // Refresh sessions on update
                }
            };
        },
        
        async startSession(sessionId) {
            try {
                const response = await fetch(`/sessions/${sessionId}/start/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    await this.loadSessions();
                    window.location.href = `/sessions/${sessionId}/room/`;
                }
            } catch (error) {
                console.error('Error starting session:', error);
            }
        },
        
        async publishSession(sessionId) {
            // TODO: Implement publish session
            console.log('Publishing session:', sessionId);
        },
        
        async cancelSession(sessionId) {
            if (confirm('Are you sure you want to cancel this session?')) {
                // TODO: Implement cancel session
                console.log('Cancelling session:', sessionId);
            }
        },
        
        joinRoom(sessionId) {
            window.location.href = `/sessions/${sessionId}/room/`;
        },
        
        formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        },
        
        formatDateTime(dateString) {
            return new Date(dateString).toLocaleString([], {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        getStatusClass(status) {
            const classes = {
                'scheduled': 'bg-blue-100 text-blue-800',
                'live': 'bg-green-100 text-green-800',
                'completed': 'bg-gray-100 text-gray-800',
                'cancelled': 'bg-red-100 text-red-800',
                'draft': 'bg-yellow-100 text-yellow-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    }
}
</script>
{% endblock %}
