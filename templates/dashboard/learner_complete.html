{% extends 'base.html' %}
{% load static %}
{% load users_filters %}

{% block title %}Learner Dashboard{% endblock %}

{% block extra_head %}
<style>
    .learner-bg {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    }
    .session-card {
        transition: all 0.3s ease;
    }
    .session-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    /* Premium Session Card Styles */
    .premium-session-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }
    .premium-session-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }
    .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .card-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .card-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .card-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .card-gradient-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .card-gradient-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    .card-gradient-8 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
    
    .bestseller-badge {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        animation: pulse 2s infinite;
    }
    
    .rating-stars {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    
    .price-tag {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .tab-content {
        min-height: 400px;
    }
    .recommendation-card {
        background: linear-gradient(45deg, #f0f9ff, #e0f2fe);
        border-left: 4px solid #3b82f6;
    }
    .waiting-animation {
        animation: pulse 2s infinite;
    }
    .ready-button {
        animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
        from { box-shadow: 0 0 10px #3b82f6; }
        to { box-shadow: 0 0 20px #3b82f6, 0 0 30px #3b82f6; }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="learnerDashboard()" x-init="init()">
    <!-- Learner Header -->
    <div class="learner-bg text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl font-bold">Welcome back, {{ user.first_name }}!</h1>
                    <p class="mt-2 text-blue-100">Ready to learn something new today?</p>
                    <div class="flex items-center mt-2 space-x-2">
                        <div class="flex items-center">
                            <div :class="wsConnected ? 'bg-green-400' : 'bg-red-400'" class="w-2 h-2 rounded-full animate-pulse"></div>
                            <span class="text-sm text-blue-100 ml-2" x-text="wsConnected ? 'Live' : 'Offline'"></span>
                        </div>
                        <!-- WORKING: Notification Bell - Right Side Dropdown -->
                        <div class="relative">
                            <button onclick="toggleBellDropdown()" 
                                    class="text-white hover:text-blue-200 transition-colors relative">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-3-3v-5a6 6 0 0 0-12 0v5l-3 3h5m6 0v1a3 3 0 0 1-6 0v-1m6 0H9"></path>
                                </svg>
                                <span id="bellBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center animate-bounce">3</span>
                            </button>
                            
                            <!-- WORKING: Right-Side Notification Dropdown -->
                            <div id="bellDropdown" 
                                 class="hidden absolute z-[9999] mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-200"
                                 style="right: 0; top: 100%; min-width: 320px; transform-origin: top right;">
                                
                                <!-- Header -->
                                <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                                        <button onclick="markAllRead()" class="text-xs text-blue-600 hover:text-blue-800">
                                            Mark all read
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Notification List -->
                                <div class="max-h-80 overflow-y-auto">
                                    <div class="px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-white">
                                            <div class="flex items-start space-x-3">
                                            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                                                <i class="fas fa-check text-white text-sm"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900">Session Confirmed</p>
                                                <p class="text-sm text-gray-600">Your Python session has been confirmed</p>
                                                <p class="text-xs text-gray-500 mt-1">2 hours ago</p>
                                            </div>
                                            <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                                        </div>
                                                </div>
                                                
                                    <div class="px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-white">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                                                <i class="fas fa-user-check text-white text-sm"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900">Mentor Ready</p>
                                                <p class="text-sm text-gray-600">John is ready to start your session</p>
                                                <p class="text-xs text-gray-500 mt-1">5 hours ago</p>
                                        </div>
                                            <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                                        </div>
                                </div>
                                
                                    <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer bg-gray-50">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center">
                                                <i class="fas fa-clock text-white text-sm"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900">Session Starting Soon</p>
                                                <p class="text-sm text-gray-600">Your session starts in 30 minutes</p>
                                                <p class="text-xs text-gray-500 mt-1">1 day ago</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-3">
                    <!-- FIXED: AI Match Button -->
                    <button onclick="openAIMatchPopup(); console.log('ðŸŽ¯ AI Match button clicked - opening popup');" 
                            class="bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold hover:bg-blue-50 transition-colors flex items-center space-x-2">
                        <i data-feather="zap" class="h-4 w-4"></i>
                        <span>AI Match</span>
                    </button>
                    
                    <!-- FIXED: Request Session Button -->
                    <button onclick="openRequestPopup(); console.log('ðŸŽ¯ Request Session button clicked - opening popup');" 
                            class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all transform hover:scale-105 flex items-center space-x-2">
                        <i data-feather="plus" class="h-4 w-4"></i>
                        <span>Request Session</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="session-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <i data-feather="book-open" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Sessions Attended</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.attended_sessions || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="session-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <i data-feather="clock" class="h-6 w-6 text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Upcoming Sessions</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.upcoming_count || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="session-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <i data-feather="star" class="h-6 w-6 text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Learning Hours</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.total_hours || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="session-card bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100">
                        <i data-feather="trending-up" class="h-6 w-6 text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Unique Mentors</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.unique_mentors || 0"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="hidden md:block border-b border-gray-200">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button @click="activeTab = 'browse'"
                            :class="activeTab === 'browse' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i data-feather="search" class="h-4 w-4"></i>
                            <span>Browse Sessions</span>
                        </div>
                    </button>
                    <button @click="activeTab = 'sessions'"
                            :class="activeTab === 'sessions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i data-feather="video" class="h-4 w-4"></i>
                            <span>My Sessions</span>
                            <span x-show="sessions.upcoming.length > 0" class="ml-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full" x-text="sessions.upcoming.length"></span>
                        </div>
                    </button>
                    <button @click="activeTab = 'requests'"
                            :class="activeTab === 'requests' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i data-feather="clock" class="h-4 w-4"></i>
                            <span>Requests</span>
                            <span x-show="requests.length > 0" class="ml-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full" x-text="requests.length"></span>
                        </div>
                    </button>
                    <button @click="activeTab = 'recommendations'" 
                            :class="activeTab === 'recommendations' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-lightbulb"></i>
                            <span>Recommendations</span>
                        </div>
                    </button>
                    
                    <button @click="activeTab = 'feedback'" 
                            :class="activeTab === 'feedback' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-star"></i>
                            <span>Feedback & Reviews</span>
                        </div>
                    </button>
                    
                    <button @click="activeTab = 'achievements'" 
                            :class="activeTab === 'achievements' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-trophy"></i>
                            <span>Achievements</span>
                        </div>
                    </button>
                    <button @click="activeTab = 'mentors'"
                            :class="activeTab === 'mentors' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <i data-feather="users" class="h-4 w-4"></i>
                            <span>Find Mentors</span>
                        </div>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="bg-white rounded-xl shadow-lg">
            <!-- Browse Sessions Tab -->
            <div x-show="activeTab === 'browse'" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Browse Available Sessions</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span x-text="(sessions.available?.length || 0) + ' sessions available'"></span>
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        </div>
                        <a href="/sessions/webrtc-test/" target="_blank" 
                           class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-lg text-xs font-medium hover:bg-yellow-200 flex items-center space-x-1">
                            <i class="fas fa-flask text-xs"></i>
                            <span>WebRTC Test</span>
                        </a>
                    </div>
                </div>
                
                <!-- Search Filter -->
                <div class="mb-6">
                    <input type="text" id="sessionSearch" oninput="filterSessions()"
                           placeholder="Search sessions..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Professional EdTech Course Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="sessionsList">
                    {% for session in available_sessions %}
                        <div class="course-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden border border-gray-100 hover:border-blue-200">
                            <!-- Compact Course Thumbnail -->
                            <div class="relative h-32 overflow-hidden">
                                <!-- Real uploaded image if available -->
                                {% if session.thumbnail %}
                                    <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                {% else %}
                                    <!-- Professional gradient fallback -->
                                    <div class="w-full h-full flex items-center justify-center {% if session.category == 'programming' %}bg-gradient-to-br from-blue-400 to-blue-600{% elif session.category == 'design' %}bg-gradient-to-br from-purple-400 to-purple-600{% elif session.category == 'data science' %}bg-gradient-to-br from-green-400 to-green-600{% elif session.category == 'business' %}bg-gradient-to-br from-indigo-400 to-indigo-600{% else %}bg-gradient-to-br from-gray-400 to-gray-600{% endif %}">
                                        <div class="text-center">
                                            <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-lg flex items-center justify-center text-white text-lg font-bold mb-1">
                                                {{ session.title|first|upper }}
                                            </div>
                                            <div class="text-white text-xs font-medium">{{ session.category|default:"Course" }}</div>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Compact Badges -->
                                <div class="absolute top-2 left-2 right-2 flex justify-between">
                                    {% if session.is_popular %}
                                    <span class="bg-orange-500 text-white px-2 py-1 text-xs font-medium rounded-md">
                                        Hot
                                    </span>
                                    {% endif %}
                                    
                                    {% if session.price and session.price > 0 %}
                                    <span class="bg-purple-600 text-white px-2 py-1 text-xs font-medium rounded-md ml-auto">
                                        Premium
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Compact Content -->
                            <div class="p-4">
                                <!-- Course Title -->
                                <h3 class="text-sm font-semibold text-gray-900 mb-2 line-clamp-2 leading-snug">{{ session.title }}</h3>
                                
                                <!-- Instructor -->
                                <p class="text-xs text-gray-600 mb-2">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                
                                <!-- Compact Rating -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <div class="flex items-center mr-1">
                                            {% for i in "12345" %}
                                                <svg class="w-3 h-3 fill-current {% if forloop.counter <= 4 %}text-yellow-400{% else %}text-gray-300{% endif %}" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                </svg>
                                            {% endfor %}
                                        </div>
                                        <span class="text-xs font-medium text-gray-700">4.{{ forloop.counter }}</span>
                                    </div>
                                    <span class="text-xs text-gray-500">({{ session.participants.count|default:25 }})</span>
                                </div>
                                
                                <!-- Price and Action -->
                                <div class="flex items-center justify-between">
                                    <div class="text-left">
                                        {% if session.price and session.price > 0 %}
                                            <span class="text-sm font-bold text-gray-900">â‚¹{{ session.price }}</span>
                                            {% if session.original_price and session.original_price > session.price %}
                                                <span class="text-xs text-gray-500 line-through block">â‚¹{{ session.original_price }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-sm font-bold text-green-600">Free</span>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'book_session' session.id %}" 
                                       class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors">
                                        Book
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center py-12">
                            <div class="w-24 h-24 mx-auto mb-4 text-gray-300">
                                <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Sessions Available</h3>
                            <p class="text-gray-500 mb-4">There are no sessions scheduled at the moment.</p>
                            <button @click="openAdvancedRequestModal()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Request a Session
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- My Sessions Tab -->
            <div x-show="activeTab === 'sessions'" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">My Sessions</h3>
                    <div class="flex space-x-2">
                        <button @click="sessionView = 'upcoming'"
                                :class="sessionView === 'upcoming' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium">
                            Upcoming
                        </button>
                        <button @click="sessionView = 'live'"
                                :class="sessionView === 'live' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium relative">
                            Live Sessions
                            <span id="liveBadge" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse" style="display: none;">0</span>
                        </button>
                        <button @click="sessionView = 'past'"
                                :class="sessionView === 'past' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium">
                            Past
                        </button>
                    </div>
                </div>
                
                <!-- Upcoming Sessions - Premium Course Cards -->
                <div x-show="sessionView === 'upcoming'">
                    <!-- Desktop Grid -->
                    <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <template x-for="session in sessions.upcoming" :key="session.id">
                            <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105">
                                <!-- Course Thumbnail -->
                                <div class="relative h-40 overflow-hidden">
                                    <!-- Real uploaded image if available -->
                                    <div x-show="session.thumbnail" 
                                         class="w-full h-full bg-cover bg-center" 
                                         :style="`background-image: url(${session.thumbnail})`"></div>
                                    
                                    <!-- Premium gradient fallback when no image -->
                                    <div x-show="!session.thumbnail" 
                                         class="w-full h-full flex items-center justify-center"
                                         :style="`background: linear-gradient(135deg, ${getSessionColor(session.title)}, ${getSessionColorSecondary(session.title)});`">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2">
                                                <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                            </div>
                                            <div class="text-white text-sm font-medium" x-text="session.category || 'Course'"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <div class="absolute top-3 left-3">
                                        <span class="bg-orange-500 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg animate-pulse">
                                            Upcoming
                                        </span>
                                    </div>
                                    
                                    <!-- Premium Badge -->
                                    <div x-show="session.price > 0" class="absolute top-3 right-3">
                                        <span class="bg-purple-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                            Premium
                                        </span>
                                    </div>
                                    
                                    <!-- Ready Badge -->
                                    <div x-show="session.is_ready" class="absolute bottom-3 right-3">
                                        <span class="bg-green-500 text-white px-2 py-1 text-xs font-bold rounded-full shadow-lg">
                                            Ready âœ“
                                        </span>
                                    </div>
                                </div>

                                <!-- Course Content -->
                                <div class="p-5">
                                    <!-- Course Title -->
                                    <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight" x-text="session.title"></h3>
                                    
                                    <!-- Instructor Name -->
                                    <p class="text-sm text-gray-600 mb-3 font-medium" x-text="session.mentor.name"></p>
                                    
                                    <!-- Time Until Session -->
                                    <div class="bg-gradient-to-r from-orange-400 to-pink-500 text-white px-3 py-2 rounded-xl text-sm font-bold text-center mb-3">
                                        <div class="countdown-timer" :data-schedule="session.schedule">Calculating...</div>
                                    </div>
                                    
                                    <!-- Session Info -->
                                    <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span x-text="session.duration + ' min'"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <span x-text="formatSessionDate(session.schedule)"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Price -->
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span x-show="session.price > 0" class="text-xl font-bold text-gray-900" x-text="`â‚¹${session.price}`"></span>
                                            <span x-show="session.price == 0" class="text-xl font-bold text-green-600">Free</span>
                                        </div>
                                        <span class="bg-orange-100 text-orange-800 px-3 py-1 text-xs font-semibold rounded-full">Confirmed</span>
                                    </div>
                                </div>
                                
                                <!-- Action on Hover -->
                                <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                    <div class="text-center space-y-3">
                                        <template x-if="session.status === 'live'">
                                            <a :href="`/sessions/${session.id}/room/`" 
                                               class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-700 animate-pulse">
                                                ðŸ”´ Join Live
                                            </a>
                                        </template>
                                        <template x-if="session.status !== 'live'">
                                            <button @click="joinEarlyRoom(session.id)" 
                                                    class="bg-orange-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-orange-700">
                                                Join Early
                                            </button>
                                        </template>
                                        <button @click="markReady(session.id)" 
                                                :class="session.is_ready ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'"
                                                class="text-white px-6 py-2 rounded-xl font-bold text-sm block w-full">
                                            <span x-text="session.is_ready ? 'Ready âœ“' : 'Mark Ready'"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Mobile Horizontal Scroll -->
                    <div class="md:hidden">
                        <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                            <template x-for="session in sessions.upcoming" :key="session.id">
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0" style="width: 280px; scroll-snap-align: start;">
                                    <!-- Mobile Course Thumbnail -->
                                    <div class="relative h-32 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        <div x-show="session.thumbnail" 
                                             class="w-full h-full bg-cover bg-center" 
                                             :style="`background-image: url(${session.thumbnail})`"></div>
                                        
                                        <!-- Premium gradient fallback when no image -->
                                        <div x-show="!session.thumbnail" 
                                             class="w-full h-full flex items-center justify-center"
                                             :style="`background: linear-gradient(135deg, ${getSessionColor(session.title)}, ${getSessionColorSecondary(session.title)});`">
                                            <div class="text-center">
                                                <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1">
                                                    <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                                </div>
                                                <div class="text-white text-xs font-medium" x-text="session.category || 'Course'"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Mobile Status Badge -->
                                        <div class="absolute top-2 left-2">
                                            <span class="bg-orange-500 text-white px-2 py-1 text-xs font-bold rounded-full">
                                                Upcoming
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Mobile Course Content -->
                                    <div class="p-4">
                                        <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2" x-text="session.title"></h3>
                                        <p class="text-sm text-gray-600 mb-2" x-text="session.mentor.name"></p>
                                        
                                        <!-- Mobile Time Display -->
                                        <div class="bg-gradient-to-r from-orange-400 to-pink-500 text-white px-2 py-1 rounded-lg text-xs font-bold text-center mb-2">
                                            <div class="countdown-timer" :data-schedule="session.schedule">Soon</div>
                                        </div>
                                        
                                        <!-- Mobile Actions -->
                                        <div class="space-y-1">
                                            <template x-if="session.status === 'live'">
                                                <a :href="`/sessions/${session.id}/room/`" 
                                                   class="w-full bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-bold text-center block animate-pulse">
                                                    ðŸ”´ Join Live
                                                </a>
                                            </template>
                                            <template x-if="session.status !== 'live'">
                                                <button @click="joinEarlyRoom(session.id)" 
                                                        class="w-full bg-orange-600 text-white py-2 px-3 rounded-lg text-sm font-bold">
                                                    Join Early
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Real Sessions from API (keeping the detailed list for large screens) -->
                    <template x-for="session in sessions.upcoming" :key="session.id">
                        <div class="hidden xl:block bg-white rounded-2xl shadow-lg border border-gray-200 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden">
                            <div class="p-6">
                                <div class="flex items-start space-x-6">
                                    <!-- Professional Session Thumbnail -->
                                    <div class="flex-shrink-0">
                                        <div class="relative w-28 h-28 rounded-2xl overflow-hidden shadow-lg">
                                            <!-- Real uploaded image if available -->
                                            <div x-show="session.thumbnail" 
                                                 class="w-full h-full bg-cover bg-center" 
                                                 :style="`background-image: url(${session.thumbnail})`"></div>
                                            
                                            <!-- Premium gradient fallback when no image -->
                                            <div x-show="!session.thumbnail" 
                                                 class="w-full h-full flex items-center justify-center text-white font-bold text-3xl"
                                                 :style="`background: linear-gradient(135deg, ${getSessionColor(session.title)}, ${getSessionColorSecondary(session.title)});`">
                                                <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Session Details -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1 pr-4">
                                                <h3 class="text-xl font-bold text-gray-900 mb-2" x-text="session.title"></h3>
                                                <p class="text-sm text-gray-600 mb-4 leading-relaxed line-clamp-2" x-text="session.description"></p>
                                                
                                                <!-- Session Info Grid -->
                                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-user-tie mr-2 text-blue-500"></i>
                                                        <span x-text="session.mentor.name"></span>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <i class="fas fa-clock mr-2 text-green-500"></i>
                                                        <span x-text="session.duration + ' minutes'"></span>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <i class="fas fa-calendar mr-2 text-purple-500"></i>
                                                        <span x-text="formatSessionDate(session.schedule)"></span>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <i class="fas fa-video mr-2 text-red-500"></i>
                                                        <span>Video Session</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Status & Price Tags -->
                                                <div class="flex items-center space-x-2">
                                                    <span x-show="session.price > 0" 
                                                          class="bg-blue-100 text-blue-800 px-3 py-1 text-sm font-semibold rounded-full"
                                                          x-text="'â‚¹' + session.price"></span>
                                                    <span x-show="session.price == 0" 
                                                          class="bg-green-100 text-green-800 px-3 py-1 text-sm font-semibold rounded-full">
                                                        Free
                                                    </span>
                                                    <span class="bg-orange-100 text-orange-800 px-3 py-1 text-sm font-semibold rounded-full">
                                                        Confirmed
                                                    </span>
                                                    <span x-show="session.is_ready" class="bg-green-100 text-green-800 px-3 py-1 text-sm font-semibold rounded-full">
                                                        Ready âœ“
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Right Side: Timer & Actions -->
                                            <div class="flex flex-col items-end space-y-4">
                                                <!-- Enhanced Countdown Timer -->
                                                <div class="text-center">
                                                    <div class="countdown-timer bg-gradient-to-r from-orange-400 to-pink-500 text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg min-w-[120px]" 
                                                         :data-schedule="session.schedule">
                                                        Calculating...
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-2">Until session starts</p>
                                                </div>
                                                
                                                <!-- Action Buttons -->
                                                <div class="flex flex-col space-y-2 min-w-[140px]">
                                                    <template x-if="session.status === 'live'">
                                                        <a :href="`/sessions/${session.id}/room/`"
                                                           class="bg-red-600 text-white px-6 py-3 rounded-xl text-sm font-medium hover:bg-red-700 animate-pulse flex items-center justify-center">
                                                            <i class="fas fa-play mr-2"></i>
                                                            Join Live
                                                        </a>
                                                    </template>
                                                    
                                                    <template x-if="session.status !== 'live'">
                                                        <div class="space-y-2">
                                                            <button @click="joinEarlyRoom(session.id)"
                                                                    class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-orange-700 flex items-center justify-center">
                                                                <i class="fas fa-door-open mr-2"></i>
                                                                Join Early
                                                            </button>
                                                            <button @click="markReady(session.id)"
                                                                    :class="session.is_ready ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'"
                                                                    class="w-full text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center">
                                                                <i class="fas fa-check mr-2"></i>
                                                                <span x-text="session.is_ready ? 'Ready âœ“' : 'Mark Ready'"></span>
                                                            </button>
                                                        </div>
                                                    </template>
                                                    
                                                    <a :href="`/sessions/${session.id}/`"
                                                       class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 text-center">
                                                        View Details
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- No Sessions Placeholder -->
                    <div x-show="sessions.upcoming.length === 0" class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-blue-100 to-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Upcoming Sessions</h3>
                        <p class="text-gray-500 mb-4">Browse available sessions to start learning.</p>
                        <button @click="activeTab = 'browse'" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 font-semibold">
                            Browse Sessions
                        </button>
                    </div>
                </div>
                
                <!-- Live Sessions - Premium Course Cards -->
                <div x-show="sessionView === 'live'">
                    <!-- Desktop Grid -->
                    <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <template x-for="session in sessions.live" :key="session.id">
                            <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105 border-2 border-red-200">
                                <!-- Course Thumbnail -->
                                <div class="relative h-40 overflow-hidden">
                                    <!-- Real uploaded image if available -->
                                    <div x-show="session.thumbnail" 
                                         class="w-full h-full bg-cover bg-center" 
                                         :style="`background-image: url(${session.thumbnail})`"></div>
                                    
                                    <!-- Live gradient fallback when no image -->
                                    <div x-show="!session.thumbnail" 
                                         class="w-full h-full flex items-center justify-center"
                                         style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2 animate-pulse">
                                                <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                            </div>
                                            <div class="text-white text-sm font-medium">ðŸ”´ LIVE NOW</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Live Badge -->
                                    <div class="absolute top-3 left-3">
                                        <span class="bg-red-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg animate-pulse">
                                            ðŸ”´ LIVE NOW
                                        </span>
                                    </div>
                                    
                                    <!-- Participants Badge -->
                                    <div class="absolute top-3 right-3">
                                        <span class="bg-green-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                            <span x-text="session.current_participants"></span> online
                                        </span>
                                    </div>
                                    
                                    <!-- Duration Badge -->
                                    <div class="absolute bottom-3 right-3">
                                        <span class="bg-blue-500 text-white px-2 py-1 text-xs font-bold rounded-full shadow-lg">
                                            <span x-text="getSessionDuration(session.started_at)"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- Course Content -->
                                <div class="p-5">
                                    <!-- Course Title -->
                                    <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight" x-text="session.title"></h3>
                                    
                                    <!-- Instructor Name -->
                                    <p class="text-sm text-gray-600 mb-3 font-medium" x-text="session.mentor.name"></p>
                                    
                                    <!-- Live Status -->
                                    <div class="bg-gradient-to-r from-red-400 to-red-600 text-white px-3 py-2 rounded-xl text-sm font-bold text-center mb-3 animate-pulse">
                                        ðŸ”´ LIVE - <span x-text="getSessionDuration(session.started_at)"></span>
                                    </div>
                                    
                                    <!-- Session Info -->
                                    <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            <span x-text="session.current_participants + ' online'"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span x-text="formatTime(session.started_at)"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Price -->
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span x-show="session.price > 0" class="text-xl font-bold text-gray-900" x-text="`â‚¹${session.price}`"></span>
                                            <span x-show="session.price == 0" class="text-xl font-bold text-green-600">Free</span>
                                        </div>
                                        <span class="bg-red-100 text-red-800 px-3 py-1 text-xs font-semibold rounded-full">Active</span>
                                    </div>
                                </div>
                                
                                <!-- Action on Hover -->
                                <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                    <div class="text-center space-y-3">
                                        <a :href="`/sessions/${session.id}/room/`" 
                                           class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-700 animate-pulse">
                                            ðŸ”´ Join Live Session
                                        </a>
                                        <a :href="`/sessions/${session.id}/`" 
                                           class="bg-white text-gray-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-gray-100 transition-colors block w-full">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Mobile Horizontal Scroll -->
                    <div class="md:hidden">
                        <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                            <template x-for="session in sessions.live" :key="session.id">
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0 border-2 border-red-200" style="width: 280px; scroll-snap-align: start;">
                                    <!-- Mobile Course Thumbnail -->
                                    <div class="relative h-32 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        <div x-show="session.thumbnail" 
                                             class="w-full h-full bg-cover bg-center" 
                                             :style="`background-image: url(${session.thumbnail})`"></div>
                                        
                                        <!-- Live gradient fallback when no image -->
                                        <div x-show="!session.thumbnail" 
                                             class="w-full h-full flex items-center justify-center"
                                             style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                                            <div class="text-center">
                                                <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1 animate-pulse">
                                                    <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                                </div>
                                                <div class="text-white text-xs font-medium">ðŸ”´ LIVE</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Mobile Live Badge -->
                                        <div class="absolute top-2 left-2">
                                            <span class="bg-red-600 text-white px-2 py-1 text-xs font-bold rounded-full animate-pulse">
                                                ðŸ”´ LIVE
                                            </span>
                                        </div>
                                        
                                        <!-- Mobile Participants Badge -->
                                        <div class="absolute top-2 right-2">
                                            <span class="bg-green-600 text-white px-1 py-0.5 text-xs font-bold rounded-full">
                                                <span x-text="session.current_participants"></span> online
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Mobile Course Content -->
                                    <div class="p-4">
                                        <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2" x-text="session.title"></h3>
                                        <p class="text-sm text-gray-600 mb-2" x-text="session.mentor.name"></p>
                                        
                                        <!-- Mobile Live Display -->
                                        <div class="bg-gradient-to-r from-red-400 to-red-600 text-white px-2 py-1 rounded-lg text-xs font-bold text-center mb-2 animate-pulse">
                                            ðŸ”´ LIVE NOW
                                        </div>
                                        
                                        <!-- Mobile Actions -->
                                        <div class="space-y-1">
                                            <a :href="`/sessions/${session.id}/room/`" 
                                               class="w-full bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-bold text-center block animate-pulse">
                                                ðŸ”´ Join Live
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- No Live Sessions Placeholder -->
                    <div x-show="sessions.live.length === 0" class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-red-100 to-pink-100 rounded-xl flex items-center justify-center">
                            <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Live Sessions</h3>
                        <p class="text-gray-500 mb-4">There are no live sessions happening right now.</p>
                        <button @click="sessionView = 'upcoming'" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 font-semibold">
                            Check Upcoming Sessions
                        </button>
                    </div>
                </div>
                
                <!-- Past Sessions - Premium Course Cards -->
                <div x-show="sessionView === 'past'">
                    <!-- Desktop Grid -->
                    <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <template x-for="session in sessions.past" :key="session.id">
                            <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105 opacity-90">
                                <!-- Course Thumbnail -->
                                <div class="relative h-40 overflow-hidden">
                                    <!-- Real uploaded image if available -->
                                    <div x-show="session.thumbnail" 
                                         class="w-full h-full bg-cover bg-center grayscale" 
                                         :style="`background-image: url(${session.thumbnail})`"></div>
                                    
                                    <!-- Premium gradient fallback when no image -->
                                    <div x-show="!session.thumbnail" 
                                         class="w-full h-full flex items-center justify-center"
                                         style="background: linear-gradient(135deg, #94A3B8, #64748B);">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2">
                                                <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                            </div>
                                            <div class="text-white text-sm font-medium">Completed</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <div class="absolute top-3 left-3">
                                        <span class="bg-gray-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                            Completed
                                        </span>
                                    </div>
                                    
                                    <!-- Rating Badge -->
                                    <div x-show="session.rating && session.rating > 0" class="absolute top-3 right-3">
                                        <span class="bg-yellow-500 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                            â­ <span x-text="session.rating"></span>
                                        </span>
                                    </div>
                                    
                                    <!-- Attendance Badge -->
                                    <div x-show="session.attendance_duration > 0" class="absolute bottom-3 right-3">
                                        <span class="bg-blue-500 text-white px-2 py-1 text-xs font-bold rounded-full shadow-lg">
                                            <span x-text="session.attendance_duration + 'min'"></span>
                                        </span>
                                    </div>
                                </div>

                                <!-- Course Content -->
                                <div class="p-5">
                                    <!-- Course Title -->
                                    <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight" x-text="session.title"></h3>
                                    
                                    <!-- Instructor Name -->
                                    <p class="text-sm text-gray-600 mb-3 font-medium" x-text="session.mentor.name"></p>
                                    
                                    <!-- Completion Date -->
                                    <div class="bg-gray-100 text-gray-700 px-3 py-2 rounded-xl text-sm font-medium text-center mb-3">
                                        Completed: <span x-text="formatSessionDate(session.schedule)"></span>
                                    </div>
                                    
                                    <!-- Session Info -->
                                    <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span x-text="session.duration + ' min'"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                            </svg>
                                            <span x-text="session.rating ? session.rating + '/5' : 'Not rated'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Price -->
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span x-show="session.price > 0" class="text-xl font-bold text-gray-700" x-text="`â‚¹${session.price}`"></span>
                                            <span x-show="session.price == 0" class="text-xl font-bold text-green-600">Free</span>
                                        </div>
                                        <span class="bg-gray-100 text-gray-800 px-3 py-1 text-xs font-semibold rounded-full">Finished</span>
                                    </div>
                                </div>
                                
                                <!-- Action on Hover -->
                                <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                    <div class="text-center space-y-3">
                                        <template x-if="!session.rating || session.rating === 0">
                                            <button @click="openRealRatingModal(session.id, session.title, session.mentor.name)" 
                                                    class="bg-purple-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-purple-700">
                                                â­ Rate Session
                                            </button>
                                        </template>
                                        <template x-if="session.rating && session.rating > 0">
                                            <button @click="viewSessionRating(session.id)" 
                                                    class="bg-green-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-green-700">
                                                ðŸ‘ï¸ View Rating
                                            </button>
                                        </template>
                                        <button @click="bookAgain(session.mentor.id)" 
                                                class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-blue-700 block w-full">
                                            ðŸ”„ Book Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Mobile Horizontal Scroll -->
                    <div class="md:hidden">
                        <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                            <template x-for="session in sessions.past" :key="session.id">
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0 opacity-90" style="width: 280px; scroll-snap-align: start;">
                                    <!-- Mobile Course Thumbnail -->
                                    <div class="relative h-32 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        <div x-show="session.thumbnail" 
                                             class="w-full h-full bg-cover bg-center grayscale" 
                                             :style="`background-image: url(${session.thumbnail})`"></div>
                                        
                                        <!-- Premium gradient fallback when no image -->
                                        <div x-show="!session.thumbnail" 
                                             class="w-full h-full flex items-center justify-center"
                                             style="background: linear-gradient(135deg, #94A3B8, #64748B);">
                                            <div class="text-center">
                                                <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1">
                                                    <span x-text="session.title.charAt(0).toUpperCase()"></span>
                                                </div>
                                                <div class="text-white text-xs font-medium">Completed</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Mobile Status Badge -->
                                        <div class="absolute top-2 left-2">
                                            <span class="bg-gray-600 text-white px-2 py-1 text-xs font-bold rounded-full">
                                                Completed
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Mobile Course Content -->
                                    <div class="p-4">
                                        <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2" x-text="session.title"></h3>
                                        <p class="text-sm text-gray-600 mb-2" x-text="session.mentor.name"></p>
                                        
                                        <!-- Mobile Rating Display -->
                                        <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                                            <span x-text="'Duration: ' + session.duration + 'min'"></span>
                                            <span x-text="session.rating ? 'â­ ' + session.rating : 'â­ Not rated'"></span>
                                        </div>
                                        
                                        <!-- Mobile Actions -->
                                        <div class="space-y-1">
                                            <template x-if="!session.rating || session.rating === 0">
                                                <button @click="openRealRatingModal(session.id, session.title, session.mentor.name)" 
                                                        class="w-full bg-purple-600 text-white py-2 px-3 rounded-lg text-sm font-bold">
                                                    â­ Rate
                                                </button>
                                            </template>
                                            <template x-if="session.rating && session.rating > 0">
                                                <button @click="bookAgain(session.mentor.id)" 
                                                        class="w-full bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-bold">
                                                    ðŸ”„ Book Again
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div x-show="activeTab === 'requests'" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">My Session Requests</h3>
                    <button onclick="openRequestPopup()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        New Request
                    </button>
                </div>
                
                <!-- Pending Requests -->
                <div class="mb-8">
                    <h4 class="text-md font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-clock text-yellow-500 mr-2"></i>
                        Pending Requests ({{ pending_requests|length }})
                    </h4>
                <div class="space-y-4">
                    {% for request in pending_requests %}
                            {% if request.status == 'pending' %}
                                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                            <h5 class="font-semibold text-gray-900 mb-2">{{ request.topic }}</h5>
                                    <p class="text-sm text-gray-600 mb-3">{{ request.description }}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span><i class="fas fa-clock mr-1"></i>{{ request.duration }} min</span>
                                                <span><i class="fas fa-exclamation-circle mr-1"></i>{{ request.urgency|title }}</span>
                                                <span><i class="fas fa-tag mr-1"></i>{{ request.domain|title }}</span>
                                                {% if request.mentor %}
                                                    <span><i class="fas fa-user mr-1"></i>{{ request.mentor.get_full_name }}</span>
                                                {% else %}
                                                    <span><i class="fas fa-users mr-1"></i>Any mentor</span>
                                                {% endif %}
                                    </div>
                                </div>
                                <div class="text-right">
                                            <span class="px-3 py-1 text-xs font-medium rounded-full mb-2 inline-block bg-yellow-100 text-yellow-800">
                                                â³ {{ request.status|title }}
                                    </span>
                                    <p class="text-sm text-gray-500">{{ request.created_at|timesince }} ago</p>
                                            <button onclick="cancelRequest('{{ request.id }}')" 
                                                    class="mt-2 bg-red-100 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-200 transition-colors">
                                                <i class="fas fa-times mr-1"></i>Cancel
                                        </button>
                                        </div>
                                    </div>
                                </div>
                                    {% endif %}
                        {% endfor %}
                        
                        {% if not pending_requests or not pending_requests|length %}
                            <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">No Pending Requests</h4>
                                <p class="text-gray-500 mb-4">You haven't made any session requests yet.</p>
                                <button onclick="openRequestPopup()" 
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus mr-2"></i>Make Your First Request
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Responded Requests -->
                {% if responded_requests %}
                <div class="mb-8">
                    <h4 class="text-md font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-bell text-blue-500 mr-2"></i>
                        Recent Responses ({{ responded_requests|length }})
                    </h4>
                    <div class="space-y-4">
                        {% for request in responded_requests %}
                            <div class="{% if request.status == 'accepted' %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} border rounded-xl p-6">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h5 class="font-semibold text-gray-900 mb-2">{{ request.topic }}</h5>
                                        <p class="text-sm text-gray-600 mb-3">Mentor: {{ request.mentor.get_full_name }}</p>
                                        {% if request.mentor_response %}
                                            <div class="bg-white p-3 rounded-lg mb-3">
                                                <p class="text-sm text-gray-700"><strong>Response:</strong> {{ request.mentor_response }}</p>
                                            </div>
                                        {% endif %}
                                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                                            <span><i class="fas fa-clock mr-1"></i>Responded {{ request.updated_at|timesince }} ago</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if request.status == 'accepted' %}
                                            <span class="px-3 py-1 text-xs font-medium rounded-full mb-2 inline-block bg-green-100 text-green-800">
                                                âœ… Accepted
                                            </span>
                                            <div class="space-y-2">
                                                <button onclick="acknowledgeRequest('{{ request.id }}', 'accepted')" 
                                                        class="block w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                                    <i class="fas fa-thumbs-up mr-1"></i>Acknowledge & Book
                                                </button>
                                                <a href="/mentors/{{ request.mentor.id }}/profile/" 
                                                   class="block w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors text-center">
                                                    <i class="fas fa-user mr-1"></i>View Mentor
                                                </a>
                                            </div>
                                        {% else %}
                                            <span class="px-3 py-1 text-xs font-medium rounded-full mb-2 inline-block bg-red-100 text-red-800">
                                                âŒ Declined
                                            </span>
                                            <div class="space-y-2">
                                                <button onclick="acknowledgeRequest('{{ request.id }}', 'declined')" 
                                                        class="block w-full bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition-colors">
                                                    <i class="fas fa-check mr-1"></i>Acknowledge
                                                </button>
                                                <button onclick="openRequestPopup()" 
                                                        class="block w-full bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition-colors">
                                                    <i class="fas fa-redo mr-1"></i>Try Another
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Mentors Tab -->
            <div x-show="activeTab === 'mentors'" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Find Expert Mentors</h3>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>{{ available_mentors|length }} mentors available</span>
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    </div>
                </div>
                
                <!-- Mentor Search -->
                <div class="mb-6">
                    <input type="text" id="mentorSearchInput" oninput="searchMentors()"
                           placeholder="Search mentors by name, domain, or skills..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Real Mentors from Database -->
                <div class="space-y-4" id="mentorsList">
                    {% for mentor in available_mentors %}
                        <div class="mentor-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <!-- Left: Mentor Info -->
                                <div class="flex items-center space-x-4 flex-1">
                                    <!-- Profile Image -->
                                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl font-bold">
                                        {% if mentor.profile_image %}
                                            <img src="{{ mentor.profile_image.url }}" alt="{{ mentor.get_full_name }}" class="w-16 h-16 rounded-full object-cover">
                                        {% else %}
                                            {{ mentor.first_name|first|upper }}{{ mentor.last_name|first|upper }}
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Mentor Details -->
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 mb-1">{{ mentor.get_full_name|default:mentor.username }}</h4>
                                        <p class="text-sm text-gray-600 mb-2">{{ mentor.domain|default:"General Mentor" }}</p>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500 mb-2">
                                            <span>â­ 4.8/5 rating</span>
                                            <span>â€¢</span>
                                            <span>{{ mentor.mentor_sessions.count }} sessions</span>
                                            <span>â€¢</span>
                                            <span>{% if mentor.hourly_rate %}â‚¹{{ mentor.hourly_rate }}/hr{% else %}Free{% endif %}</span>
                                        </div>
                                        
                                        <!-- Skills -->
                                        {% if mentor.skills %}
                                            <div class="flex flex-wrap gap-1">
                                                {% for skill in mentor.skills|split:"," %}
                                                    {% if skill.strip %}
                                                        <span class="bg-gray-100 text-gray-700 px-2 py-1 text-xs rounded-full">{{ skill.strip|title }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Right: Actions -->
                                <div class="flex flex-col space-y-2 min-w-[120px]">
                                    <button onclick="viewMentorProfile('{{ mentor.id }}')"
                                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                                        View Profile
                                    </button>
                                    <button onclick="requestFromMentor('{{ mentor.id }}', '{{ mentor.get_full_name }}')"
                                            class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700">
                                        Request Session
                                    </button>
                                    <button data-mentor-id="{{ mentor.id }}"
                                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200">
                                        <i class="fas fa-heart mr-1"></i>Follow
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center py-12">
                            <div class="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-friends text-4xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Mentors Available</h3>
                            <p class="text-gray-500 mb-4">Check back later for new mentors.</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Recommended Mentors Section -->
                {% if recommended_mentors %}
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">ðŸŽ¯ Recommended for You</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for mentor in recommended_mentors %}
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                            {% if mentor.profile_image %}
                                                <img src="{{ mentor.profile_image.url }}" alt="{{ mentor.get_full_name }}" class="w-12 h-12 rounded-full object-cover">
                                            {% else %}
                                                {{ mentor.first_name|first|upper }}{{ mentor.last_name|first|upper }}
                                            {% endif %}
                                        </div>
                                        <div class="flex-1">
                                            <h5 class="font-medium text-gray-900">{{ mentor.get_full_name|default:mentor.username }}</h5>
                                            <p class="text-sm text-gray-600">{{ mentor.domain|default:"General Mentor" }}</p>
                                        </div>
                                        <button onclick="viewMentorProfile('{{ mentor.id }}')"
                                                class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                            View
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Recommendations Tab -->
            <div x-show="activeTab === 'recommendations'" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Personalized Recommendations</h3>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>Powered by AI</span>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                </div>
                </div>
                
                <!-- Recommendation Sub-tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8">
                        <button @click="recTab = 'ai'" 
                                :class="recTab === 'ai' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                            ðŸ¤– AI Recommendations
                            </button>
                            <button @click="recTab = 'popular'"
                                :class="recTab === 'popular' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                            ðŸ”¥ Popular Sessions
                            </button>
                            <button @click="recTab = 'new'"
                                :class="recTab === 'new' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                            âœ¨ New Sessions
                            </button>
                        </nav>
                    </div>

                        <!-- AI Recommendations - Premium Course Cards -->
                        <div x-show="recTab === 'ai'">
                            <!-- Desktop Grid -->
                            <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                    {% for session in recommended_sessions %}
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105">
                                    <!-- Course Thumbnail -->
                                    <div class="relative h-40 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        {% if session.thumbnail %}
                                            <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                        {% else %}
                                            <!-- AI Recommendation gradient -->
                                            <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #3B82F6, #8B5CF6);">
                                                <div class="text-center">
                                                    <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2">
                                                        {{ session.title|first|upper }}
                                                    </div>
                                                    <div class="text-white text-sm font-medium">AI Recommended</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- AI Badge -->
                                        <div class="absolute top-3 left-3">
                                            <span class="bg-blue-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                                ðŸ¤– AI Pick
                                            </span>
                                        </div>
                                        
                                        <!-- Premium Badge -->
                                        {% if session.price > 0 %}
                                            <div class="absolute top-3 right-3">
                                                <span class="bg-purple-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                                    Premium
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Course Content -->
                                    <div class="p-5">
                                        <!-- Course Title -->
                                        <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight">{{ session.title }}</h3>
                                        
                                        <!-- Instructor Name -->
                                        <p class="text-sm text-gray-600 mb-3 font-medium">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                        
                                        <!-- AI Match Score -->
                                        <div class="bg-gradient-to-r from-blue-400 to-purple-500 text-white px-3 py-2 rounded-xl text-sm font-bold text-center mb-3">
                                            ðŸŽ¯ {{ forloop.counter|add:85 }}% AI Match
                                        </div>
                                        
                                        <!-- Session Info -->
                                        <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>{{ session.duration }} min</span>
                                            </div>
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span>{{ session.schedule|date:"M d" }}</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Price -->
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                {% if session.price > 0 %}
                                                    <span class="text-xl font-bold text-gray-900">â‚¹{{ session.price }}</span>
                                                {% else %}
                                                    <span class="text-xl font-bold text-green-600">Free</span>
                                                {% endif %}
                                            </div>
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 text-xs font-semibold rounded-full">Recommended</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action on Hover -->
                                    <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                        <div class="text-center space-y-3">
                                            <a href="{% url 'session_detail' session.id %}" 
                                               class="bg-white text-gray-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-gray-100 transition-colors">
                                                View Details
                                            </a>
                                            <a href="{% url 'book_session' session.id %}" 
                                               class="bg-blue-500 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-blue-600 transition-colors block w-full">
                                                Book Now
                                            </a>
                                        </div>
                                    </div>
                                </div>
                    {% endfor %}
                            </div>
                            
                            <!-- Mobile Horizontal Scroll -->
                            <div class="md:hidden">
                                <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                    {% for session in recommended_sessions %}
                                    <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0" style="width: 280px; scroll-snap-align: start;">
                                        <!-- Mobile Course Thumbnail -->
                                        <div class="relative h-32 overflow-hidden">
                                            {% if session.thumbnail %}
                                                <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                            {% else %}
                                                <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #3B82F6, #8B5CF6);">
                                                    <div class="text-center">
                                                        <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1">
                                                            {{ session.title|first|upper }}
                                                        </div>
                                                        <div class="text-white text-xs font-medium">AI Pick</div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Mobile AI Badge -->
                                            <div class="absolute top-2 left-2">
                                                <span class="bg-blue-600 text-white px-2 py-1 text-xs font-bold rounded-full">
                                                    ðŸ¤– AI
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Mobile Course Content -->
                                        <div class="p-4">
                                            <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2">{{ session.title }}</h3>
                                            <p class="text-sm text-gray-600 mb-2">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                            
                                            <!-- Mobile AI Score -->
                                            <div class="bg-gradient-to-r from-blue-400 to-purple-500 text-white px-2 py-1 rounded-lg text-xs font-bold text-center mb-2">
                                                ðŸŽ¯ {{ forloop.counter|add:85 }}% Match
                                            </div>
                                            
                                            <!-- Mobile Actions -->
                                            <div class="space-y-1">
                                                <a href="{% url 'session_detail' session.id %}" 
                                                   class="w-full bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-bold text-center block">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                    {% empty %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-robot text-2xl text-gray-400"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">No AI Recommendations Yet</h4>
                            <p class="text-gray-500">Complete your profile to get personalized recommendations</p>
                        </div>
                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Popular Sessions - Premium Course Cards -->
                        <div x-show="recTab === 'popular'">
                            <!-- Desktop Grid -->
                            <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                    {% for session in popular_sessions %}
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105">
                                    <!-- Course Thumbnail -->
                                    <div class="relative h-40 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        {% if session.thumbnail %}
                                            <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                        {% else %}
                                            <!-- Popular gradient -->
                                            <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #EF4444, #F97316);">
                                                <div class="text-center">
                                                    <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2">
                                                        {{ session.title|first|upper }}
                                                    </div>
                                                    <div class="text-white text-sm font-medium">Popular Choice</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Popular Badge -->
                                        <div class="absolute top-3 left-3">
                                            <span class="bg-red-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg">
                                                ðŸ”¥ Popular
                                            </span>
                                        </div>
                                        
                                        <!-- Enrollment Count -->
                                        <div class="absolute bottom-3 right-3">
                                            <span class="bg-white text-red-600 px-2 py-1 text-xs font-bold rounded-full shadow-lg">
                                                {{ session.participants.count|default:25 }}+ booked
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Course Content -->
                                    <div class="p-5">
                                        <!-- Course Title -->
                                        <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight">{{ session.title }}</h3>
                                        
                                        <!-- Instructor Name -->
                                        <p class="text-sm text-gray-600 mb-3 font-medium">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                        
                                        <!-- Popularity Score -->
                                        <div class="bg-gradient-to-r from-red-400 to-orange-500 text-white px-3 py-2 rounded-xl text-sm font-bold text-center mb-3">
                                            ðŸ”¥ {{ session.participants.count|default:25 }} Learners Joined
                                        </div>
                                        
                                        <!-- Session Info -->
                                        <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>{{ session.duration }} min</span>
                                            </div>
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                </svg>
                                                <span>{{ session.participants.count|default:25 }} joined</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Price -->
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                {% if session.price > 0 %}
                                                    <span class="text-xl font-bold text-gray-900">â‚¹{{ session.price }}</span>
                                                {% else %}
                                                    <span class="text-xl font-bold text-green-600">Free</span>
                                                {% endif %}
                                            </div>
                                            <span class="bg-red-100 text-red-800 px-3 py-1 text-xs font-semibold rounded-full">Trending</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action on Hover -->
                                    <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                        <div class="text-center space-y-3">
                                            <a href="{% url 'session_detail' session.id %}" 
                                               class="bg-white text-gray-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-gray-100 transition-colors">
                                                View Details
                                            </a>
                                            <a href="{% url 'book_session' session.id %}" 
                                               class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-600 transition-colors block w-full">
                                                Book Now
                                            </a>
                                        </div>
                                    </div>
                                </div>
                    {% endfor %}
                            </div>
                            
                            <!-- Mobile Horizontal Scroll -->
                            <div class="md:hidden">
                                <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                    {% for session in popular_sessions %}
                                    <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0" style="width: 280px; scroll-snap-align: start;">
                                        <!-- Mobile Course Thumbnail -->
                                        <div class="relative h-32 overflow-hidden">
                                            {% if session.thumbnail %}
                                                <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                            {% else %}
                                                <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #EF4444, #F97316);">
                                                    <div class="text-center">
                                                        <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1">
                                                            {{ session.title|first|upper }}
                                                        </div>
                                                        <div class="text-white text-xs font-medium">Popular</div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Mobile Popular Badge -->
                                            <div class="absolute top-2 left-2">
                                                <span class="bg-red-600 text-white px-2 py-1 text-xs font-bold rounded-full">
                                                    ðŸ”¥ Hot
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Mobile Course Content -->
                                        <div class="p-4">
                                            <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2">{{ session.title }}</h3>
                                            <p class="text-sm text-gray-600 mb-2">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                            
                                            <!-- Mobile Popularity -->
                                            <div class="bg-gradient-to-r from-red-400 to-orange-500 text-white px-2 py-1 rounded-lg text-xs font-bold text-center mb-2">
                                                ðŸ”¥ {{ session.participants.count|default:25 }}+ booked
                                            </div>
                                            
                                            <!-- Mobile Actions -->
                                            <div class="space-y-1">
                                                <a href="{% url 'session_detail' session.id %}" 
                                                   class="w-full bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-bold text-center block">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                    {% empty %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-fire text-2xl text-gray-400"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">No Popular Sessions Yet</h4>
                            <p class="text-gray-500">Be the first to book a session!</p>
                        </div>
                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- New Sessions - Premium Course Cards -->
                        <div x-show="recTab === 'new'">
                            <!-- Desktop Grid -->
                            <div class="hidden md:grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                    {% for session in new_sessions %}
                                <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 hover:scale-105">
                                    <!-- Course Thumbnail -->
                                    <div class="relative h-40 overflow-hidden">
                                        <!-- Real uploaded image if available -->
                                        {% if session.thumbnail %}
                                            <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                        {% else %}
                                            <!-- New gradient -->
                                            <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #10B981, #059669);">
                                                <div class="text-center">
                                                    <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-2">
                                                        {{ session.title|first|upper }}
                                                    </div>
                                                    <div class="text-white text-sm font-medium">Fresh & New</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- New Badge -->
                                        <div class="absolute top-3 left-3">
                                            <span class="bg-green-600 text-white px-3 py-1 text-xs font-bold rounded-full shadow-lg animate-pulse">
                                                âœ¨ New
                                            </span>
                                        </div>
                                        
                                        <!-- Early Bird Badge -->
                                        <div class="absolute bottom-3 right-3">
                                            <span class="bg-yellow-500 text-white px-2 py-1 text-xs font-bold rounded-full shadow-lg">
                                                Early Bird
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Course Content -->
                                    <div class="p-5">
                                        <!-- Course Title -->
                                        <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight">{{ session.title }}</h3>
                                        
                                        <!-- Instructor Name -->
                                        <p class="text-sm text-gray-600 mb-3 font-medium">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                        
                                        <!-- New Session Info -->
                                        <div class="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-3 py-2 rounded-xl text-sm font-bold text-center mb-3">
                                            âœ¨ Just Added - Be First!
                                        </div>
                                        
                                        <!-- Session Info -->
                                        <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>{{ session.duration }} min</span>
                                            </div>
                                            <div class="flex items-center">
                                                <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span>{{ session.schedule|date:"M d" }}</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Price -->
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                {% if session.price > 0 %}
                                                    <span class="text-xl font-bold text-gray-900">â‚¹{{ session.price }}</span>
                                                {% else %}
                                                    <span class="text-xl font-bold text-green-600">Free</span>
                                                {% endif %}
                                            </div>
                                            <span class="bg-green-100 text-green-800 px-3 py-1 text-xs font-semibold rounded-full">Latest</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action on Hover -->
                                    <div class="course-card-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-300">
                                        <div class="text-center space-y-3">
                                            <a href="{% url 'session_detail' session.id %}" 
                                               class="bg-white text-gray-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-gray-100 transition-colors">
                                                View Details
                                            </a>
                                            <a href="{% url 'book_session' session.id %}" 
                                               class="bg-green-500 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-green-600 transition-colors block w-full">
                                                Book First!
                                            </a>
                                        </div>
                                    </div>
                                </div>
                    {% endfor %}
                            </div>
                            
                            <!-- Mobile Horizontal Scroll -->
                            <div class="md:hidden">
                                <div class="flex space-x-4 pb-4 overflow-x-auto touch-pan-x scrollbar-hide" style="scroll-snap-type: x mandatory;">
                    {% for session in new_sessions %}
                                    <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex-shrink-0" style="width: 280px; scroll-snap-align: start;">
                                        <!-- Mobile Course Thumbnail -->
                                        <div class="relative h-32 overflow-hidden">
                                            {% if session.thumbnail %}
                                                <div class="w-full h-full bg-cover bg-center" style="background-image: url({{ session.thumbnail.url }})"></div>
                                            {% else %}
                                                <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #10B981, #059669);">
                                                    <div class="text-center">
                                                        <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-lg font-bold mb-1">
                                                            {{ session.title|first|upper }}
                                                        </div>
                                                        <div class="text-white text-xs font-medium">New</div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Mobile New Badge -->
                                            <div class="absolute top-2 left-2">
                                                <span class="bg-green-600 text-white px-2 py-1 text-xs font-bold rounded-full">
                                                    âœ¨ New
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Mobile Course Content -->
                                        <div class="p-4">
                                            <h3 class="text-md font-bold text-gray-900 mb-1 line-clamp-2">{{ session.title }}</h3>
                                            <p class="text-sm text-gray-600 mb-2">{{ session.mentor.get_full_name|default:session.mentor.username }}</p>
                                            
                                            <!-- Mobile New Badge -->
                                            <div class="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-2 py-1 rounded-lg text-xs font-bold text-center mb-2">
                                                âœ¨ Just Added!
                                            </div>
                                            
                                            <!-- Mobile Actions -->
                                            <div class="space-y-1">
                                                <a href="{% url 'session_detail' session.id %}" 
                                                   class="w-full bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-bold text-center block">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                    {% empty %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sparkles text-2xl text-gray-400"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">No New Sessions Yet</h4>
                            <p class="text-gray-500">New sessions will appear here as they're created</p>
                        </div>
                    {% endfor %}
                                </div>
                            </div>
                </div>
            </div>
        </div>
        
        <!-- Feedback & Reviews Tab -->
        <div x-show="activeTab === 'feedback'" class="tab-content p-6">
            <!-- Feedback Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Reviews Given</p>
                            <p class="text-2xl font-bold" id="totalReviewsGiven">0</p>
                        </div>
                        <i class="fas fa-star text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Average Rating</p>
                            <p class="text-2xl font-bold" id="averageRatingGiven">0.0</p>
                        </div>
                        <i class="fas fa-thumbs-up text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Sessions Rated</p>
                            <p class="text-2xl font-bold" id="sessionsRated">0</p>
                        </div>
                        <i class="fas fa-chart-line text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Mentors Rated</p>
                            <p class="text-2xl font-bold" id="mentorsRated">0</p>
                        </div>
                        <i class="fas fa-users text-2xl opacity-70"></i>
                    </div>
                </div>
            </div>

            <!-- Recent Feedback Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-clock mr-2 text-green-500"></i>
                        Recent Feedback Activity
                    </h3>
                    <button onclick="refreshFeedbackData()" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg text-sm flex items-center">
                        <i class="fas fa-sync mr-2"></i>
                        Refresh
                    </button>
                </div>
                
                <div id="recentFeedbackList" class="space-y-4">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>

            <!-- Feedback History -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-500"></i>
                        Your Feedback History
                    </h3>
                    <div class="flex space-x-2">
                        <select id="feedbackFilter" class="border rounded-lg px-3 py-2 text-sm">
                            <option value="all">All Reviews</option>
                            <option value="recent">Recent (30 days)</option>
                            <option value="high">High Ratings (4-5)</option>
                            <option value="low">Low Ratings (1-3)</option>
                        </select>
                    </div>
                </div>
                
                <div id="feedbackHistoryList" class="space-y-6">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>

            <!-- Quick Rate Session -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-purple-500"></i>
                        Rate a Completed Session
                    </h3>
                </div>
                
                <div id="unratedSessionsList" class="space-y-4">
                    <!-- Dynamic content for unrated sessions -->
                </div>
            </div>
        </div>
        
        <!-- Achievements Tab -->
        <div x-show="activeTab === 'achievements'" class="tab-content p-6">
            <!-- Achievement Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Sessions Completed</p>
                            <p class="text-2xl font-bold" x-text="stats.attended_sessions"></p>
                        </div>
                        <i class="fas fa-check-circle text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Total Hours</p>
                            <p class="text-2xl font-bold" x-text="stats.total_hours"></p>
                        </div>
                        <i class="fas fa-clock text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Learning Streak</p>
                            <p class="text-2xl font-bold">7</p>
                        </div>
                        <i class="fas fa-fire text-2xl opacity-70"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Level</p>
                            <p class="text-2xl font-bold">3</p>
                        </div>
                        <i class="fas fa-star text-2xl opacity-70"></i>
                    </div>
                </div>
            </div>

            <!-- Achievement Badges -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                        Earned Badges
                    </h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- First Session Badge -->
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200">
                        <div class="w-16 h-16 mx-auto mb-3 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-play text-white text-xl"></i>
                        </div>
                        <h4 class="font-semibold text-green-800 text-sm">First Session</h4>
                        <p class="text-green-600 text-xs">Completed your first learning session</p>
                    </div>
                    
                    <!-- Active Learner Badge -->
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200">
                        <div class="w-16 h-16 mx-auto mb-3 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <h4 class="font-semibold text-blue-800 text-sm">Active Learner</h4>
                        <p class="text-blue-600 text-xs">Attended 5+ sessions</p>
                    </div>
                    
                    <!-- Week Streak Badge -->
                    <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl border border-orange-200">
                        <div class="w-16 h-16 mx-auto mb-3 bg-orange-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-fire text-white text-xl"></i>
                        </div>
                        <h4 class="font-semibold text-orange-800 text-sm">Week Streak</h4>
                        <p class="text-orange-600 text-xs">Learned 7 days in a row</p>
                    </div>
                    
                    <!-- Coming Soon Badge -->
                    <div class="text-center p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gray-300 rounded-full flex items-center justify-center">
                            <i class="fas fa-lock text-gray-500 text-xl"></i>
                        </div>
                        <h4 class="font-semibold text-gray-600 text-sm">Expert Learner</h4>
                        <p class="text-gray-500 text-xs">Complete 20 sessions</p>
                    </div>
                </div>
            </div>

            <!-- Learning Progress -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-purple-500"></i>
                        Learning Progress
                    </h3>
                </div>
                
                <div class="space-y-6">
                    <!-- Level Progress -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Level 3 Progress</span>
                            <span class="text-sm text-gray-500">750/1000 XP</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-3 rounded-full" style="width: 75%"></div>
                        </div>
                    </div>
                    
                    <!-- Skills Progress -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Python</span>
                                <span class="text-sm text-gray-500">Intermediate</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" style="width: 60%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Machine Learning</span>
                                <span class="text-sm text-gray-500">Beginner</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Alpine.js Data Function for Learner Dashboard
function learnerDashboard() {
    return {
        // Connection state
        wsConnected: false,
        socket: null,
        
        // Navigation
        activeTab: 'browse',
        sessionView: 'upcoming',
        recTab: 'ai',
        
        // REMOVED: Nuclear modal protection system - using simple popups now
        
        // AI Match form data
        aiMatchTopic: '',
        aiMatchLevel: 'beginner',
        aiMatchDuration: '60',
        
        // Advanced Request form data
        requestMentorId: '',
        requestCategory: 'programming',
        requestTopic: '',
        requestDescription: '',
        requestDuration: '60',
        requestUrgency: 'flexible',
        requestBudget: 'free',
        
        // FIXED: Feedback should ONLY be available in WebRTC room - Remove from dashboard
        // Feedback form data - DEPRECATED IN DASHBOARD
        feedbackRating: 5,
        feedbackComment: '',
        
        // Session data (loaded from API)
        sessions: {
            upcoming: [],
            live: [],
            past: [],
            available: []
        },
        
        // Requests data
        requests: [],
        userRequests: [],
        requestSubTab: 'all',
        
        // Stats data
        stats: {
            attended_sessions: 0,
            upcoming_count: 0,
            total_hours: 0,
            unique_mentors: 0
        },
        
        // Notifications
        showNotifications: false,
        unreadNotifications: 3,
        recentNotifications: [
            {
                id: 1,
                type: 'session_confirmed',
                title: 'Session Confirmed',
                message: 'Your Python session with Sarah has been confirmed for tomorrow',
                created_at: new Date(Date.now() - 3600000).toISOString(),
                read: false
            },
            {
                id: 2, 
                type: 'mentor_ready',
                title: 'Mentor Ready',
                message: 'John is ready to start your session',
                created_at: new Date(Date.now() - 7200000).toISOString(),
                read: false
            },
            {
                id: 3,
                type: 'session_reminder',
                title: 'Session Reminder',
                message: 'Your session starts in 30 minutes',
                created_at: new Date(Date.now() - 10800000).toISOString(),
                read: false
            }
        ],
        
        // SIMPLE: Clean initialization without nuclear protection
        async init() {
            console.log('âœ… Initializing learner dashboard...');
            
            try {
                // Load dashboard data
                await this.loadDashboardData();
                
                // Connect WebSocket
                this.connectWebSocket();
                
                // Load notifications
                await this.loadNotifications();
                
                console.log('ðŸŽ‰ Dashboard initialized successfully!');
                console.log('ðŸ“Š Current dashboard state:', {
                    sessions: this.sessions,
                    stats: this.stats,
                    wsConnected: this.wsConnected
                });
                
            } catch (error) {
                console.error('âŒ Dashboard initialization error:', error);
                this.showNotification('Dashboard initialization failed. Refreshing...', 'error');
                setTimeout(() => window.location.reload(), 3000);
            }
        },
        

        
        // FIXED: Clean any URL triggers that might cause modal opening
        cleanURLTriggers() {
            const url = new URL(window.location);
            const parametersToRemove = ['modal', 'feedback', 'rating', 'request', 'open', 'show'];
            
            let cleaned = false;
            parametersToRemove.forEach(param => {
                if (url.searchParams.has(param)) {
                    url.searchParams.delete(param);
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                window.history.replaceState({}, '', url.toString());
                console.log('ðŸ§¹ Cleaned URL parameters that could trigger modals');
            }
        },
        
        // Load real dashboard data from API
        async loadDashboardData() {
            try {
                console.log('ðŸ”„ Loading dashboard data...');
                const response = await fetch('/api/sessions/learner-data/', {
                    method: 'GET',
                    headers: { 
                        'X-CSRFToken': this.getCSRFToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update data
                    this.sessions = data.sessions || {upcoming: [], live: [], past: [], available: []};
                    this.requests = data.requests || [];
                    this.stats = data.stats || {attended_sessions: 0, upcoming_count: 0, total_hours: 0, unique_mentors: 0};
                    
                    console.log('ðŸ“Š Dashboard data loaded successfully:', {
                        upcoming: this.sessions.upcoming.length,
                        live: this.sessions.live.length,
                        past: this.sessions.past.length,
                        available: this.sessions.available.length,
                        requests: this.requests.length,
                        stats: this.stats
                    });
                    
                    // Force UI update
                    this.$nextTick(() => {
                        console.log('âœ… UI should be updated now');
                    });
                    
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Failed to load learner dashboard data:', response.status, errorText);
                    this.showNotification('Failed to load dashboard data', 'error');
                }
            } catch (error) {
                console.error('âŒ Error loading learner dashboard data:', error);
                this.showNotification('Network error loading data', 'error');
            }
        },
        
        // WebSocket connection
        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
            
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onopen = () => {
                this.wsConnected = true;
                console.log('ðŸ“¡ WebSocket connected');
            };
            
            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };
            
            this.socket.onclose = () => {
                this.wsConnected = false;
                console.log('ðŸ“¡ WebSocket disconnected');
                setTimeout(() => this.connectWebSocket(), 3000);
            };
            
            this.socket.onerror = (error) => {
                this.wsConnected = false;
                console.error('WebSocket error:', error);
            };
        },
        
        // Handle WebSocket messages
        handleWebSocketMessage(data) {
            switch (data.type) {
                case 'session_started':
                    this.handleSessionStarted(data);
                    break;
                case 'session_ended':
                    this.handleSessionEnded(data);
                    break;
                case 'mentor_ready':
                    this.handleMentorReady(data);
                    break;
                case 'booking_confirmed':
                    this.handleBookingConfirmed(data);
                    break;
            }
        },
        
        // WebSocket event handlers
        handleSessionStarted(data) {
            // Move session from upcoming to live
            const sessionIndex = this.sessions.upcoming.findIndex(s => s.id === data.session_id);
            if (sessionIndex !== -1) {
                const session = this.sessions.upcoming.splice(sessionIndex, 1)[0];
                session.status = 'live';
                this.sessions.live.unshift(session);
            }
            
            this.showNotification(`Your session "${data.session.title}" has started!`, 'success');
            // FIXED: NO modal auto-opening here
        },
        
        handleSessionEnded(data) {
            // Move session from live to past
            const sessionIndex = this.sessions.live.findIndex(s => s.id === data.session_id);
            if (sessionIndex !== -1) {
                const session = this.sessions.live.splice(sessionIndex, 1)[0];
                session.status = 'completed';
                this.sessions.past.unshift(session);
            }
            
            this.showNotification(`Session ended. You can rate it in your past sessions!`, 'info');
        },
        
        handleMentorReady(data) {
            this.showNotification(`${data.mentor_name} is ready for your session!`, 'info');
            // FIXED: NO modal auto-opening here
        },        
        
        handleBookingConfirmed(data) {
            this.showNotification('Your session booking has been confirmed!', 'success');
            this.loadDashboardData(); // Refresh data
        },
        
        // Notification functions
        toggleNotifications() {
            this.showNotifications = !this.showNotifications;
        },
        
        markNotificationRead(notificationId) {
            const notification = this.recentNotifications.find(n => n.id === notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                this.unreadNotifications = Math.max(0, this.unreadNotifications - 1);
            }
        },
        
        markAllNotificationsRead() {
            this.recentNotifications.forEach(n => n.read = true);
            this.unreadNotifications = 0;
        },
        
        // Load notifications from API
        async loadNotifications() {
            try {
                const response = await fetch('/api/notifications/', {
                    headers: { 'X-CSRFToken': this.getCSRFToken() }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.recentNotifications = data.notifications || this.recentNotifications;
                    this.unreadNotifications = data.unread_count || this.unreadNotifications;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        },
        
        // Session actions
        async markReady(sessionId) {
            try {
                const response = await fetch(`/sessions/api/mark-ready/${sessionId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    this.showNotification('Marked as ready! Mentor will be notified.', 'success');
                    
                    // Update session in data
                    const session = this.sessions.upcoming.find(s => s.id === sessionId);
                    if (session) {
                        session.is_ready = true;
                    }
                } else {
                    this.showNotification('Error marking as ready', 'error');
                }
            } catch (error) {
                this.showNotification('Network error', 'error');
            }
        },
        
        // Notification styling helpers
        getNotificationIconClass(type) {
            const classes = {
                'session_confirmed': 'bg-green-500',
                'mentor_ready': 'bg-blue-500',
                'session_reminder': 'bg-orange-500',
                'session_started': 'bg-red-500',
                'session_cancelled': 'bg-gray-500'
            };
            return classes[type] || 'bg-blue-500';
        },
        
        getNotificationIcon(type) {
            const icons = {
                'session_confirmed': 'fas fa-check',
                'mentor_ready': 'fas fa-user-check',
                'session_reminder': 'fas fa-clock',
                'session_started': 'fas fa-play',
                'session_cancelled': 'fas fa-times'
            };
            return icons[type] || 'fas fa-bell';
        },
        
        // FIXED: Professional Toast Notification System for Learner Dashboard
        showNotification(message, type = 'info', duration = 5000) {
            // Remove any existing notifications first
            document.querySelectorAll('.peerlearn-toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = 'peerlearn-toast fixed top-4 right-4 z-[9999] transform transition-all duration-300 ease-out';
            
            // Professional styling with proper dimensions
            toast.style.cssText = `
                width: 350px;
                max-width: calc(100vw - 32px);
                min-height: 80px;
                transform: translateX(400px);
                opacity: 0;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                border-radius: 12px;
                backdrop-filter: blur(10px);
            `;
            
            let bgClass, borderClass, textClass, iconClass;
            switch(type) {
                case 'success':
                    bgClass = 'bg-green-50 border-green-200';
                    textClass = 'text-green-800';
                    iconClass = 'fas fa-check-circle text-green-600';
                    break;
                case 'error':
                    bgClass = 'bg-red-50 border-red-200';
                    textClass = 'text-red-800';
                    iconClass = 'fas fa-exclamation-circle text-red-600';
                    break;
                case 'warning':
                    bgClass = 'bg-yellow-50 border-yellow-200';
                    textClass = 'text-yellow-800';
                    iconClass = 'fas fa-exclamation-triangle text-yellow-600';
                    break;
                case 'info':
                default:
                    bgClass = 'bg-blue-50 border-blue-200';
                    textClass = 'text-blue-800';
                    iconClass = 'fas fa-info-circle text-blue-600';
                    break;
            }
            
            toast.className += ` ${bgClass} border-2 ${textClass}`;
            
            toast.innerHTML = `
                <div class="p-4 flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <i class="${iconClass} text-xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold leading-5 break-words">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="flex-shrink-0 ml-2 p-1 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-times text-sm opacity-60"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            });
            
            // Auto remove
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.transform = 'translateX(400px)';
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        },
        
        // Enhanced Feedback System Functions
        async loadFeedbackData() {
            try {
                const response = await fetch('/sessions/api/feedback/learner/history/', {
                    headers: { 'X-CSRFToken': this.getCSRFToken() }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.updateFeedbackUI(data);
                    console.log('âœ… Feedback data loaded successfully');
                } else {
                    console.error('Failed to load feedback data');
                }
            } catch (error) {
                console.error('Error loading feedback data:', error);
            }
        },
        
        updateFeedbackUI(data) {
            // Update statistics
            document.getElementById('totalReviewsGiven').textContent = data.statistics.total_feedback_given || 0;
            document.getElementById('averageRatingGiven').textContent = data.statistics.average_rating_given || '0.0';
            document.getElementById('sessionsRated').textContent = data.statistics.total_feedback_given || 0;
            document.getElementById('mentorsRated').textContent = data.feedback_history.length || 0;
            
            // Update feedback history
            this.displayFeedbackHistory(data.feedback_history);
            
            // Load recent activity
            this.loadRecentFeedbackActivity();
        },
        
        displayFeedbackHistory(feedbackHistory) {
            const container = document.getElementById('feedbackHistoryList');
            
            if (feedbackHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-star text-2xl text-gray-400"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">No Reviews Yet</h4>
                        <p class="text-gray-500">Complete a session and leave your first review!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = feedbackHistory.map(feedback => `
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 hover:shadow-sm transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-gray-900">${feedback.session_title}</h4>
                            <p class="text-sm text-gray-600">with ${feedback.mentor_name}</p>
                            <p class="text-xs text-gray-500 mt-1">Session on ${feedback.session_date}</p>
                        </div>
                        <div class="flex items-center space-x-1">
                            ${Array.from({length: 5}, (_, i) => 
                                `<i class="fas fa-star ${i < feedback.rating ? 'text-yellow-400' : 'text-gray-300'} text-sm"></i>`
                            ).join('')}
                            <span class="ml-2 text-sm font-medium text-gray-900">${feedback.rating}/5</span>
                        </div>
                    </div>
                    
                    ${feedback.comment ? `
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <p class="text-gray-700 text-sm">"${feedback.comment}"</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>Reviewed on ${feedback.created_at}</span>
                        ${feedback.can_edit ? `
                            <button onclick="editFeedback('${feedback.id}')" class="text-blue-600 hover:text-blue-800 font-medium">
                                Edit Review
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        },
        
        async loadRecentFeedbackActivity() {
            try {
                const response = await fetch('/sessions/api/feedback/realtime/', {
                    headers: { 'X-CSRFToken': this.getCSRFToken() }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.displayRecentActivity(data.recent_feedback);
                }
            } catch (error) {
                console.error('Error loading recent feedback activity:', error);
            }
        },
        
        displayRecentActivity(recentFeedback) {
            const container = document.getElementById('recentFeedbackList');
            
            if (recentFeedback.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-clock text-2xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">No recent feedback activity</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentFeedback.map(feedback => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-star text-white text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">Rated "${feedback.session_title}"</p>
                            <p class="text-sm text-gray-600">${feedback.rating}/5 stars</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center space-x-1">
                            ${Array.from({length: 5}, (_, i) => 
                                `<i class="fas fa-star ${i < feedback.rating ? 'text-yellow-400' : 'text-gray-300'} text-xs"></i>`
                            ).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${feedback.time_ago}</p>
                    </div>
                </div>
            `).join('');
        },
        
        async loadUnratedSessions() {
            try {
                // Get completed sessions without feedback
                const sessions = this.sessions.past.filter(session => 
                    session.status === 'completed' && !session.feedback_given
                );
                
                this.displayUnratedSessions(sessions);
            } catch (error) {
                console.error('Error loading unrated sessions:', error);
            }
        },
        
        displayUnratedSessions(sessions) {
            const container = document.getElementById('unratedSessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-check-circle text-2xl text-green-400 mb-2"></i>
                        <p class="text-gray-500">All sessions have been rated!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sessions.map(session => `
                <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div>
                        <h4 class="font-medium text-gray-900">${session.title}</h4>
                        <p class="text-sm text-gray-600">with ${session.mentor_name}</p>
                        <p class="text-xs text-gray-500">Completed on ${this.formatDate(session.completed_at)}</p>
                    </div>
                    <button onclick="openFeedbackModal('${session.id}', '${session.title}', '${session.mentor_name}')" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-star mr-2"></i>
                        Rate Session
                    </button>
                </div>
            `).join('');
        },
        
        // Date formatting
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        // Enhanced date formatting for sessions
        formatSessionDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        // Generate session color based on title
        getSessionColor(title) {
            if (!title) return '#FF6B6B';
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#FF7675'];
            const hash = title.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        },
        
        getSessionColorSecondary(title) {
            if (!title) return '#4ECDC4';
            const colors = ['#4ECDC4', '#FF6B6B', '#96CEB4', '#45B7D1', '#DDA0DD', '#FFEAA7', '#FF7675', '#98D8C8'];
            const hash = title.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        },
        
        // Session action methods with enhanced validation
        async joinEarlyRoom(sessionId) {
            console.log('ðŸšª joinEarlyRoom called with sessionId:', sessionId, typeof sessionId);
            
            // Enhanced validation to prevent undefined URLs
            if (!sessionId || 
                sessionId === 'undefined' || 
                sessionId === 'null' || 
                sessionId === undefined || 
                sessionId === null ||
                sessionId.toString().trim() === '') {
                console.error('âŒ Invalid sessionId for joinEarlyRoom:', sessionId);
                this.showNotification('Error: Invalid session ID. Cannot join room.', 'error');
                return;
            }
            
            try {
                this.showNotification('Joining waiting room...', 'info');
                const cleanSessionId = encodeURIComponent(sessionId.toString().trim());
                const url = `/sessions/${cleanSessionId}/room/?early=true`;
                console.log('âœ… Redirecting to:', url);
                window.location.href = url;
            } catch (error) {
                console.error('âŒ Error in joinEarlyRoom:', error);
                this.showNotification('Failed to join room. Please try again.', 'error');
            }
        },
        
        // FIXED: Feedback should redirect to WebRTC room - NOT open modal in dashboard
        async leaveFeedback(sessionId) {
            if (sessionId && sessionId !== 'undefined') {
                this.showNotification('Redirecting to session room for feedback...', 'info');
                // Redirect to WebRTC room where feedback modal is properly available
                window.location.href = `/sessions/${sessionId}/room/?feedback=true`;
            } else {
                console.error('Invalid sessionId for leaveFeedback:', sessionId);
                this.showNotification('Error: Invalid session ID', 'error');
            }
        },
        
        async bookAgain(mentorId) {
            this.showNotification('Redirecting to mentor profile...', 'info');
            // Add null check for mentorId to prevent undefined URLs
        if (mentorId && mentorId !== 'undefined') {
            window.location.href = `/mentors/${mentorId}/profile/`;
        } else {
            console.error('Invalid mentorId:', mentorId);
            this.showNotification('Error: Invalid mentor ID', 'error');
        }
        },
        
        // FIXED: AI Match System - WORKING Modal Functions
        openAIMatchModal() {
            console.log('ðŸŽ¯ AI Match button clicked - starting modal opening process');
            this.safeOpenModal('aiMatch');
        },
        
        findAIMatch() {
            if (!this.aiMatchTopic.trim()) {
                this.showNotification('Please enter what you want to learn', 'warning');
                return;
            }
            
            // Show loading state
            this.showNotification('ðŸ¤– AI is finding the best mentors for you...', 'info');
            
            // For now, simulate AI matching and redirect to recommendations
            setTimeout(() => {
                    this.closeAllModals();
                this.showNotification('AI found matching sessions! Check recommendations tab.', 'success');
                this.activeTab = 'recommendations';
                this.recTab = 'ai';
            }, 1500);
        },
        
        // FIXED: Request Session System - WORKING Modal Functions  
        openAdvancedRequestModal() {
            console.log('ðŸŽ¯ Request Session button clicked - starting modal opening process');
            this.safeOpenModal('advancedRequest');
        },
        
        submitAdvancedRequest() {
            if (!this.requestTopic.trim()) {
                this.showNotification('Please enter a session topic', 'warning');
                return;
            }
            
            if (!this.requestDescription.trim()) {
                this.showNotification('Please provide a detailed description', 'warning');
                return;
            }
            
            // Show success message and close modal
            this.showNotification('Session request sent successfully! Mentors will respond soon.', 'success');
                    this.closeAllModals();
            
                    // Reset form
            this.requestMentorId = '';
            this.requestCategory = 'programming';
                    this.requestTopic = '';
                    this.requestDescription = '';
            this.requestDuration = '60';
            this.requestUrgency = 'flexible';
            this.requestBudget = 'free';
            
            // Switch to requests tab to show the new request
            this.activeTab = 'requests';
        },
        
        // FIXED: DEPRECATED - Feedback should happen in WebRTC room only
        // Keeping these functions for backward compatibility but they redirect to WebRTC
        async openFeedbackModal(sessionId) {
            this.showNotification('Feedback available in session room only', 'info');
            window.location.href = `/sessions/${sessionId}/room/?feedback=true`;
        },
        
        async submitSessionFeedback() {
            this.showNotification('Please use feedback in the WebRTC session room', 'warning');
            this.closeAllModals();
        },
        
        // FIXED: Enhanced notification loading
        async loadNotifications() {
            try {
                const response = await fetch('/api/notifications/', {
                    headers: { 'X-CSRFToken': this.getCSRFToken() }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.recentNotifications = data.notifications || this.recentNotifications;
                    this.unreadNotifications = data.unread_count || this.unreadNotifications;
                    console.log('âœ… Notifications loaded:', data);
                } else {
                    console.log('ðŸ“¬ Using sample notifications');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                console.log('ðŸ“¬ Using sample notifications');
            }
        },

        // FIXED: Enhanced CSRF Token helper
        getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            // Fallback: try getting from meta tag or form
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) return meta.getAttribute('content');
            
            const input = document.querySelector('[name="csrfmiddlewaretoken"]');
            if (input) return input.value;
            
            return '';
        },
        
        // REMOVED: Old modal getter/setter - using simple popups now
        
        // FIXED: Mentor Profile Functions
        viewMentorProfile(mentorId) {
            if (mentorId && mentorId !== 'undefined') {
                this.showNotification('Opening mentor profile...', 'info');
                window.location.href = `/mentors/${mentorId}/profile/`;
            } else {
                console.error('Invalid mentorId for viewMentorProfile:', mentorId);
                this.showNotification('Error: Invalid mentor ID', 'error');
            }
        },
        
        requestMentorSession(mentorId) {
            // Pre-fill the request modal with selected mentor
            this.requestMentorId = mentorId;
            this.openAdvancedRequestModal();
        },
        
        followMentor(mentorId) {
            console.log(`Following mentor: ${mentorId}`);
            
            fetch(`/api/user/follow/${mentorId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`âœ… ${data.message}`, 'success');
                    
                    // Update button to show followed state
                    const followButton = document.querySelector(`button[onclick="followMentor('${mentorId}')"]`);
                    if (followButton) {
                        followButton.innerHTML = '<i class="fas fa-check mr-1"></i>Following';
                        followButton.className = followButton.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-green-600 hover:bg-green-700');
                        followButton.onclick = () => unfollowMentor(mentorId);
                    }
                } else {
                    showNotification(`âš ï¸ ${data.message}`, 'warning');
                }
            })
            .catch(error => {
                console.error('Error following mentor:', error);
                showNotification('âŒ Failed to follow mentor', 'error');
            });
        },
        
        unfollowMentor(mentorId) {
            console.log(`Unfollowing mentor: ${mentorId}`);
            
            fetch(`/api/user/unfollow/${mentorId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showNotification(`âœ… ${data.message}`, 'success');
                    
                    // Update button to show follow state
                    const followButton = document.querySelector(`button[onclick="unfollowMentor('${mentorId}')"]`);
                    if (followButton) {
                        followButton.innerHTML = '<i class="fas fa-heart mr-1"></i>Follow';
                        followButton.className = followButton.className.replace('bg-green-600 hover:bg-green-700', 'bg-blue-600 hover:bg-blue-700');
                        followButton.onclick = () => this.followMentor(mentorId);
                    }
                } else {
                    this.showNotification(`âš ï¸ ${data.message}`, 'warning');
                }
            })
            .catch(error => {
                console.error('Error unfollowing mentor:', error);
                this.showNotification('âŒ Failed to unfollow mentor', 'error');
            });
        },

        // Helper method for date formatting
        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        // Session color helpers
        getSessionColor(title) {
            if (!title) return '#FF6B6B';
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#FF7675'];
            const hash = title.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        },

        getSessionColorSecondary(title) {
            if (!title) return '#4ECDC4';
            const colors = ['#4ECDC4', '#FF6B6B', '#96CEB4', '#45B7D1', '#DDA0DD', '#FFEAA7', '#FF7675', '#98D8C8'];
            const hash = title.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        },

        formatSessionDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        // Session actions with validation (duplicate function - should be consistent)
        async joinEarlyRoom(sessionId) {
            console.log('ðŸšª joinEarlyRoom (duplicate) called with sessionId:', sessionId);
            
            // Enhanced validation to prevent undefined URLs
            if (!sessionId || 
                sessionId === 'undefined' || 
                sessionId === 'null' || 
                sessionId === undefined || 
                sessionId === null ||
                sessionId.toString().trim() === '') {
                console.error('âŒ Invalid sessionId for joinEarlyRoom (duplicate):', sessionId);
                this.showNotification('Error: Invalid session ID. Cannot join room.', 'error');
                return;
            }
            
            try {
                this.showNotification('Joining waiting room...', 'info');
                const cleanSessionId = encodeURIComponent(sessionId.toString().trim());
                const url = `/sessions/${cleanSessionId}/room/?early=true`;
                console.log('âœ… Redirecting to:', url);
                window.location.href = url;
            } catch (error) {
                console.error('âŒ Error in joinEarlyRoom (duplicate):', error);
                this.showNotification('Failed to join room. Please try again.', 'error');
            }
        },

        // Missing Alpine.js helper functions
        getSessionDuration(startTime) {
            if (!startTime) return 'Unknown';
            const start = new Date(startTime);
            const now = new Date();
            const diffMs = now - start;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 60) return `${diffMins}m`;
            const diffHours = Math.floor(diffMins / 60);
            return `${diffHours}h ${diffMins % 60}m`;
        },

        formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        },

        updateSessionCounts(data) {
            // Update session counts in the UI based on API data
            this.sessions = data.sessions || this.sessions;
            this.stats = data.stats || this.stats;
            console.log('âœ… Session counts updated:', data);
        },
    };
}

// Initialize Dashboard Data
let dashboardSocket = null;
let liveSessions = [];

// FIXED: Working Button Functions - Direct JavaScript Implementation
// WORKING: AI Match and Request Session Popup Functions
function openAIMatchPopup() {
    console.log('ðŸŽ¯ AI Match button clicked - opening popup');
    
    // Create AI Match popup
    const popup = document.createElement('div');
    popup.id = 'aiMatchPopup';
    popup.className = 'fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
    popup.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">ðŸ¤– AI Match</h3>
                <button onclick="closeAIMatchPopup()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-gray-600 mb-4">Let AI find the perfect mentor and session for you!</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">What do you want to learn?</label>
                    <input type="text" id="aiTopic" placeholder="e.g., Python, Web Development, Data Science" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Experience Level</label>
                    <select id="aiLevel" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Duration</label>
                    <select id="aiDuration" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeAIMatchPopup()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitAIMatch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ðŸ” Find Match
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

function closeAIMatchPopup() {
    const popup = document.getElementById('aiMatchPopup');
    if (popup) {
        popup.remove();
    }
}

async function submitAIMatch() {
    const topic = document.getElementById('aiTopic').value;
    const level = document.getElementById('aiLevel').value;
    const duration = document.getElementById('aiDuration').value;
    const urgency = document.getElementById('aiUrgency')?.value || 'flexible';
    
    if (!topic.trim()) {
        alert('Please enter what you want to learn');
        return;
    }
    
    try {
        showNotification('ðŸ¤– AI is analyzing and finding perfect matches...', 'info');
        
        const response = await fetch('/sessions/api/ai-matching/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                topic: topic,
                level: level,
                duration: duration,
                urgency: urgency
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeAIMatchPopup();
            
            // Show results
            const mentorCount = data.data.mentors.length;
            const sessionCount = data.data.sessions.length;
            
            if (mentorCount > 0 || sessionCount > 0) {
                showNotification(`ðŸŽ¯ AI found ${mentorCount} mentors and ${sessionCount} sessions! Check recommendations tab.`, 'success');
                
                // Store AI results in Alpine.js state if available
                const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
                if (dashboardElement && dashboardElement._x_dataStack) {
                    dashboardElement._x_dataStack[0].aiResults = data.data;
                    dashboardElement._x_dataStack[0].activeTab = 'recommendations';
                }
            } else {
                showNotification('ðŸ” No perfect matches found yet. Try different search terms or check back later.', 'warning');
            }
        } else {
            showNotification(`AI matching failed: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('AI matching error:', error);
        showNotification('AI matching failed. Please try again.', 'error');
    }
}

// ENHANCED REQUEST FUNCTIONALITY WITH MENTOR SELECTION
function openAdvancedRequestModal() {
    console.log('ðŸŽ¯ Opening advanced request modal with mentor selection');
    
    // First load available mentors
    loadAvailableMentors().then(mentors => {
        const modal = document.createElement('div');
        modal.id = 'advancedRequestModal';
        modal.className = 'fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">ðŸ“ Create Session Request</h3>
                    <button onclick="closeAdvancedRequestModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="advancedRequestForm">
                    <!-- Mentor Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Mentor (Optional)</label>
                        <div class="grid grid-cols-1 gap-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50" onclick="selectMentor(null)">
                                <input type="radio" name="selectedMentor" value="" id="mentor_any" class="mr-3" checked>
                                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-users text-gray-500"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">Any Available Mentor</p>
                                    <p class="text-sm text-gray-500">Let us find the best match for you</p>
                                </div>
                            </div>
                            ${mentors.map(mentor => `
                                <div class="flex items-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50" onclick="selectMentor('${mentor.id}')">
                                    <input type="radio" name="selectedMentor" value="${mentor.id}" id="mentor_${mentor.id}" class="mr-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3 text-white text-sm font-bold">
                                        ${mentor.name.charAt(0)}
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">${mentor.name}</p>
                                        <p class="text-sm text-gray-500">${mentor.domain || 'General Mentor'}</p>
                                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                                            <span>â­ ${mentor.avg_rating}/5</span>
                                            <span>â€¢</span>
                                            <span>${mentor.total_sessions} sessions</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Session Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Session Topic *</label>
                            <input type="text" id="advRequestTopic" placeholder="What would you like to learn?" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Domain *</label>
                            <select id="advRequestDomain" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select Domain</option>
                                <option value="programming">Programming & Development</option>
                                <option value="web-development">Web Development</option>
                                <option value="data-science">Data Science</option>
                                <option value="ai-ml">AI & Machine Learning</option>
                                <option value="design">UI/UX Design</option>
                                <option value="business">Business & Marketing</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                        <textarea id="advRequestDescription" rows="3" placeholder="Describe what you'd like to learn and your current level..." 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                            <select id="advRequestDuration" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="30">30 minutes</option>
                                <option value="60" selected>1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Urgency</label>
                            <select id="advRequestUrgency" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="flexible">Flexible</option>
                                <option value="this-week">This Week</option>
                                <option value="next-week">Next Week</option>
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Budget</label>
                            <select id="advRequestBudget" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="free">Free Session</option>
                                <option value="under-500">Under â‚¹500</option>
                                <option value="500-1000">â‚¹500 - â‚¹1000</option>
                                <option value="1000-2000">â‚¹1000 - â‚¹2000</option>
                                <option value="flexible">Flexible</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Skills/Keywords (Optional)</label>
                        <input type="text" id="advRequestSkills" placeholder="React, Python, Design, etc." 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAdvancedRequestModal()" class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium">Cancel</button>
                        <button type="button" onclick="submitAdvancedRequest()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            <i class="fas fa-paper-plane mr-2"></i>Send Request
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    });
}

function openRequestPopup() {
    // For backward compatibility, call the new advanced modal
    openAdvancedRequestModal();
}

function closeRequestPopup() {
    const popup = document.getElementById('requestPopup');
    if (popup) {
        popup.remove();
    }
}

// ENHANCED REQUEST API FUNCTIONS
async function loadAvailableMentors() {
    try {
        const response = await fetch('/sessions/api/requests/mentors/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        });
        
        const data = await response.json();
        if (data.success) {
            return data.mentors;
        } else {
            console.error('Failed to load mentors:', data.error);
            return [];
        }
    } catch (error) {
        console.error('Error loading mentors:', error);
        return [];
    }
}

function selectMentor(mentorId) {
    if (mentorId) {
        document.getElementById(`mentor_${mentorId}`).checked = true;
    } else {
        document.getElementById('mentor_any').checked = true;
    }
}

function closeAdvancedRequestModal() {
    const modal = document.getElementById('advancedRequestModal');
    if (modal) {
        modal.remove();
    }
}

async function submitAdvancedRequest() {
    const selectedMentor = document.querySelector('input[name="selectedMentor"]:checked')?.value;
    const topic = document.getElementById('advRequestTopic').value;
    const domain = document.getElementById('advRequestDomain').value;
    const description = document.getElementById('advRequestDescription').value;
    const duration = document.getElementById('advRequestDuration').value;
    const urgency = document.getElementById('advRequestUrgency').value;
    const budget = document.getElementById('advRequestBudget').value;
    const skills = document.getElementById('advRequestSkills').value;
    
    // Validate required fields
    if (!topic.trim()) {
        alert('Please enter a session topic');
        return;
    }
    
    if (!domain) {
        alert('Please select a domain');
        return;
    }
    
    if (!description.trim()) {
        alert('Please provide a description');
        return;
    }
    
    try {
        const response = await fetch('/sessions/api/requests/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                mentor_id: selectedMentor || null,
                topic: topic,
                domain: domain,
                description: description,
                duration: parseInt(duration),
                urgency: urgency,
                budget: budget,
                skills: skills
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('âœ… Session request created successfully! The mentor will respond soon.', 'success');
            closeAdvancedRequestModal();
            
            // Reload requests and switch to requests tab
            loadUserRequests();
            const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
            if (dashboardElement && dashboardElement._x_dataStack) {
                dashboardElement._x_dataStack[0].activeTab = 'requests';
            }
        } else {
            alert('Failed to create request: ' + data.error);
        }
    } catch (error) {
        console.error('Error creating request:', error);
        alert('An error occurred while creating the request');
    }
}

async function loadUserRequests() {
    try {
        const response = await fetch('/sessions/api/requests/learner/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        });
        
        const data = await response.json();
        if (data.success) {
            // Update Alpine.js data
            const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
            if (dashboardElement && dashboardElement._x_dataStack) {
                dashboardElement._x_dataStack[0].userRequests = data.requests;
            }
            console.log('âœ… Loaded', data.requests.length, 'user requests');
        } else {
            console.error('Failed to load requests:', data.error);
        }
    } catch (error) {
        console.error('Error loading requests:', error);
    }
}

function loadAllRequests() {
    loadUserRequests();
}

function loadPendingRequests() {
    loadUserRequests();
}

function loadRespondedRequests() {
    loadUserRequests();
}

async function acknowledgeRequest(requestId) {
    try {
        const response = await fetch('/sessions/api/requests/acknowledge/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                request_id: requestId,
                acknowledged: true
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('âœ… Response acknowledged! Thank you for your feedback.', 'success');
            loadUserRequests(); // Reload the requests
        } else {
            alert('Failed to acknowledge response: ' + data.error);
        }
    } catch (error) {
        console.error('Error acknowledging request:', error);
        alert('An error occurred while acknowledging the response');
    }
}

async function followMentor(mentorId) {
    console.log(`Following mentor: ${mentorId}`);
    
    fetch(`/api/user/follow/${mentorId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`âœ… ${data.message}`, 'success');
            
            // Update button to show followed state
            const followButton = document.querySelector(`button[onclick="followMentor('${mentorId}')"]`);
            if (followButton) {
                followButton.innerHTML = '<i class="fas fa-check mr-1"></i>Following';
                followButton.className = followButton.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-green-600 hover:bg-green-700');
                followButton.onclick = () => unfollowMentor(mentorId);
            }
        } else {
            showNotification(`âš ï¸ ${data.message}`, 'warning');
        }
    })
    .catch(error => {
        console.error('Error following mentor:', error);
        showNotification('âŒ Failed to follow mentor', 'error');
    });
}

function unfollowMentor(mentorId) {
    console.log(`Unfollowing mentor: ${mentorId}`);
    
    fetch(`/api/user/unfollow/${mentorId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`âœ… ${data.message}`, 'success');
            
            // Update button to show follow state
            const followButton = document.querySelector(`button[onclick="unfollowMentor('${mentorId}')"]`);
            if (followButton) {
                followButton.innerHTML = '<i class="fas fa-heart mr-1"></i>Follow';
                followButton.className = followButton.className.replace('bg-green-600 hover:bg-green-700', 'bg-blue-600 hover:bg-blue-700');
                followButton.onclick = () => followMentor(mentorId);
            }
        } else {
            showNotification(`âš ï¸ ${data.message}`, 'warning');
        }
    })
    .catch(error => {
        console.error('Error unfollowing mentor:', error);
        showNotification('âŒ Failed to unfollow mentor', 'error');
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function submitRequest() {
    // Legacy function - redirect to new advanced modal
    openAdvancedRequestModal();
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// MENTOR PROFILE FUNCTIONS
function viewMentorProfile(mentorId) {
    console.log('ðŸ‘¤ Viewing mentor profile:', mentorId);
    showNotification('Opening mentor profile...', 'info');
    window.location.href = `/mentors/${mentorId}/profile/`;
}

function requestFromMentor(mentorId, mentorName) {
    console.log('ðŸ“© Requesting session from mentor:', mentorName);
    showNotification(`Opening session request for ${mentorName}...`, 'info');
    
    // Create dynamic request modal
    const modal = document.createElement('div');
    modal.id = 'mentorRequestModal';
    modal.className = 'fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Request Session with ${mentorName}</h3>
                <button onclick="closeMentorRequestModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="mentorRequestForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                    <input type="text" id="requestTopic" placeholder="What would you like to learn?" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                    <select id="requestDuration" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="30">30 minutes</option>
                        <option value="60" selected>1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="requestDescription" rows="3" placeholder="Describe what you'd like to learn..." 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeMentorRequestModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="button" onclick="submitMentorRequest('${mentorId}', '${mentorName}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Send Request</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeMentorRequestModal() {
    const modal = document.getElementById('mentorRequestModal');
    if (modal) {
        modal.remove();
    }
}

function submitMentorRequest(mentorId, mentorName) {
    const topic = document.getElementById('requestTopic').value;
    const duration = document.getElementById('requestDuration').value;
    const description = document.getElementById('requestDescription').value;
    
    if (!topic.trim()) {
        alert('Please enter a topic for the session');
        return;
    }
    
    showNotification(`âœ… Session request sent to ${mentorName}! They will respond soon.`, 'success');
    closeMentorRequestModal();
    
    // Here you would normally send the request to the backend
    console.log('Request submitted:', {
        mentorId,
        topic,
        duration,
        description
    });
    
    // Switch to requests tab to show the new request
    const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
    if (dashboardElement && dashboardElement._x_dataStack) {
        dashboardElement._x_dataStack[0].activeTab = 'requests';
    }
}

function followMentor(mentorId) {
    showNotification('âœ… Following mentor! You will get notifications about their new sessions.', 'success');
    console.log('Following mentor:', mentorId);
}

// SEARCH MENTORS FUNCTION
function searchMentors() {
    const searchTerm = document.getElementById('mentorSearchInput').value.toLowerCase();
    const mentorCards = document.querySelectorAll('#mentorsList .mentor-card');
    let visibleCount = 0;
    
    mentorCards.forEach(card => {
        const name = card.querySelector('h4').textContent.toLowerCase();
        const domain = card.querySelector('p').textContent.toLowerCase();
        const skills = Array.from(card.querySelectorAll('.bg-gray-100')).map(el => el.textContent.toLowerCase()).join(' ');
        
        if (name.includes(searchTerm) || domain.includes(searchTerm) || skills.includes(searchTerm)) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show feedback if no results
    const mentorsList = document.getElementById('mentorsList');
    let noResultsMessage = document.getElementById('noSearchResults');
    
    if (visibleCount === 0 && searchTerm.trim() !== '') {
        if (!noResultsMessage) {
            noResultsMessage = document.createElement('div');
            noResultsMessage.id = 'noSearchResults';
            noResultsMessage.className = 'text-center py-8 bg-gray-50 rounded-lg';
            noResultsMessage.innerHTML = `
                <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-search text-gray-400 text-2xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No mentors found</h4>
                <p class="text-gray-500">Try searching with different keywords or browse all mentors.</p>
                <button onclick="document.getElementById('mentorSearchInput').value = ''; searchMentors();" 
                        class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Clear Search
                </button>
            `;
            mentorsList.appendChild(noResultsMessage);
        }
        noResultsMessage.style.display = 'block';
    } else {
        if (noResultsMessage) {
            noResultsMessage.style.display = 'none';
        }
    }
    
    console.log(`ðŸ” Search results: ${visibleCount} mentors found for "${searchTerm}"`);
}

// FIXED: Bell Notification Functions - Properly positioned on right
function toggleBellDropdown() {
    const dropdown = document.getElementById('bellDropdown');
    const badge = document.getElementById('bellBadge');
    
    if (dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('hidden');
        dropdown.classList.add('block');
        if (badge) badge.style.display = 'none';
        console.log('âœ… Bell dropdown opened on RIGHT side');
    } else {
        dropdown.classList.add('hidden');
        dropdown.classList.remove('block');
        console.log('âŒ Bell dropdown closed');
    }
}

// Keep original function for compatibility
function toggleNotifications() {
    toggleBellDropdown();
}

function markAllNotificationsRead() {
    const badge = document.getElementById('notificationBadge');
    badge.style.display = 'none';
    showNotification('All notifications marked as read', 'success');
    
    // Update UI to show all as read
    document.querySelectorAll('#notificationList > div').forEach(notification => {
        notification.classList.remove('bg-white');
        notification.classList.add('bg-gray-50');
        const indicator = notification.querySelector('.w-2.h-2.bg-blue-600');
        if (indicator) indicator.remove();
    });
}

// FIXED: Rating Modal Functions
function openRatingModal(sessionId, sessionTitle, mentorName) {
    console.log('â­ Opening rating modal for session:', sessionId);
    
    // Create rating modal dynamically
    const modal = document.createElement('div');
    modal.id = 'ratingModal';
    modal.className = 'fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Rate Your Session</h3>
                <button onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <h4 class="font-medium text-gray-800">${sessionTitle}</h4>
                <p class="text-sm text-gray-600">with ${mentorName}</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                <div class="flex items-center space-x-1" id="starRating">
                    ${[1,2,3,4,5].map(star => 
                        `<button onclick="setRating(${star})" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="${star}">
                            <i class="fas fa-star"></i>
                        </button>`
                    ).join('')}
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Feedback</label>
                <textarea id="feedbackText" rows="3" placeholder="Share your experience..." 
                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeRatingModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitRating('${sessionId}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Submit Rating</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeRatingModal() {
    const modal = document.getElementById('ratingModal');
    if (modal) {
        modal.remove();
    }
}

let feedbackSelectedRating = 5;

function setRating(rating) {
    feedbackSelectedRating = rating;
    const stars = document.querySelectorAll('.star-btn');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
}

function submitRating(sessionId) {
    const feedback = document.getElementById('feedbackText').value;
    
    showNotification(`â­ Rating submitted: ${feedbackSelectedRating}/5 stars. Thank you for your feedback!`, 'success');
    closeRatingModal();
    
    // Here you would normally send the rating to the backend
    console.log('Rating submitted:', {
        sessionId,
        rating: feedbackSelectedRating,
        feedback
    });
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const bellDropdown = document.getElementById('bellDropdown');
    const bellButton = event.target.closest('button[onclick="toggleBellDropdown()"]');
    
    if (!bellButton && bellDropdown && !bellDropdown.contains(event.target)) {
        bellDropdown.classList.add('hidden');
        bellDropdown.classList.remove('block');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Ensure Feather icons are rendered
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Initialize countdown timers
    updateCountdownTimers();
    setInterval(updateCountdownTimers, 60000);
    
    // Initialize WebSocket connection for real-time updates
    initializeDashboardSocket();
    
    // Poll for live sessions with error handling
    setTimeout(() => {
        pollLiveSessions();
        // Check every 30 seconds instead of 5 to reduce server load
        setInterval(pollLiveSessions, 30000);
    }, 3000); // Wait 3 seconds for DOM to be ready
    
    // Show notification badge
    document.getElementById('notificationBadge').style.display = 'flex';
});

// WebSocket Connection for Real-time Updates
function initializeDashboardSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
    
    dashboardSocket = new WebSocket(wsUrl);
    
    dashboardSocket.onopen = function(e) {
        console.log('Dashboard WebSocket connected');
        updateConnectionStatus(true);
        
        // Update Alpine.js dashboard data
        const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
        if (dashboardElement && dashboardElement._x_dataStack) {
            dashboardElement._x_dataStack[0].wsConnected = true;
        }
    };
    
    dashboardSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleDashboardMessage(data);
    };
    
    dashboardSocket.onclose = function(e) {
        console.log('Dashboard WebSocket disconnected');
        updateConnectionStatus(false);
        
        // Update Alpine.js dashboard data
        const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
        if (dashboardElement && dashboardElement._x_dataStack) {
            dashboardElement._x_dataStack[0].wsConnected = false;
        }
        
        // Reconnect after 5 seconds
        setTimeout(initializeDashboardSocket, 5000);
    };
    
    dashboardSocket.onerror = function(e) {
        console.error('Dashboard WebSocket error:', e);
        updateConnectionStatus(false);
        
        // Update Alpine.js dashboard data
        const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
        if (dashboardElement && dashboardElement._x_dataStack) {
            dashboardElement._x_dataStack[0].wsConnected = false;
        }
    };
}

function handleDashboardMessage(data) {
    switch(data.type) {
        case 'session_started':
            addLiveSession(data.session);
            showNotification(`${data.session.mentor_name} started your session: ${data.session.title}`, 'success');
            break;
        case 'session_ended':
            removeLiveSession(data.session_id);
            showNotification(`Session "${data.session.title}" has ended`, 'info');
            break;
        case 'mentor_ready':
            showNotification(`${data.mentor_name} is ready for your session`, 'success');
            break;
        case 'booking_confirmed':
            showNotification('Your session booking has been confirmed!', 'success');
            break;
    }
}

function updateConnectionStatus(connected) {
    // Update UI to show connection status
    const statusElements = document.querySelectorAll('.connection-status');
    statusElements.forEach(el => {
        el.className = `w-2 h-2 rounded-full ${connected ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`;
    });
    
    // Update Alpine.js data if available
    if (window.Alpine && window.Alpine.store) {
        window.Alpine.store('dashboard', { wsConnected: connected });
    }
}

// Search Sessions Function
function filterSessions() {
    const searchTerm = document.getElementById('sessionSearch').value.toLowerCase();
    const sessionCards = document.querySelectorAll('#sessionsList .session-card');
    
    sessionCards.forEach(card => {
        const title = card.querySelector('h4').textContent.toLowerCase();
        const description = card.querySelector('p').textContent.toLowerCase();
        const mentor = card.textContent.toLowerCase();
        
        if (title.includes(searchTerm) || description.includes(searchTerm) || mentor.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Enhanced Countdown Timer Function with Proper Past Session Handling
function updateCountdownTimers() {
    document.querySelectorAll('.countdown-timer').forEach(timer => {
        const scheduleTime = new Date(timer.dataset.schedule);
        const now = new Date();
        const timeUntil = scheduleTime - now;
        
        if (timeUntil > 0) {
            // Future session - show countdown
            const days = Math.floor(timeUntil / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeUntil % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
            
            timer.classList.remove('bg-gray-500', 'bg-red-500');
            timer.classList.add('bg-gradient-to-r', 'from-orange-400', 'to-pink-500');
            
            if (days > 0) {
                timer.textContent = `${days}d ${hours}h left`;
            } else if (hours > 0) {
                timer.textContent = `${hours}h ${minutes}m left`;
            } else if (minutes > 15) {
                timer.textContent = `${minutes}m left`;
            } else if (minutes > 0) {
                timer.textContent = `${minutes}m left`;
                timer.classList.add('animate-pulse');
            } else {
                timer.textContent = 'Starting now!';
                timer.classList.add('animate-bounce');
            }
        } else {
            // Past session - show expired status
            const timePassed = Math.abs(timeUntil);
            const hoursPassed = Math.floor(timePassed / (1000 * 60 * 60));
            const daysPassed = Math.floor(hoursPassed / 24);
            
            timer.classList.remove('bg-gradient-to-r', 'from-orange-400', 'to-pink-500', 'animate-pulse', 'animate-bounce');
            timer.classList.add('bg-gray-500');
            
            if (daysPassed > 0) {
                timer.textContent = `${daysPassed} days ago`;
            } else if (hoursPassed > 0) {
                timer.textContent = `${hoursPassed}h ago`;
            } else {
                timer.textContent = 'Recently ended';
            }
        }
    });
}

// Live Sessions Management
function pollLiveSessions() {
    fetch('/sessions/api/live-sessions/')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Handle both data.sessions and direct data array
        const sessions = data.sessions || data || [];
        updateLiveSessions(sessions);
    })
    .catch(error => {
        console.error('Error fetching live sessions:', error);
        // Don't show errors for missing DOM elements during polling
        if (!error.message.includes('Cannot read properties of null')) {
            console.error('Live sessions polling error:', error);
        }
    });
}

function updateLiveSessions(sessions) {
    liveSessions = sessions;
    const container = document.getElementById('liveSessionsContainer');
    const placeholder = document.getElementById('noLiveSessionsPlaceholder');
    const badge = document.getElementById('liveBadge');
    
    // Add null checks to prevent errors
    if (sessions.length > 0) {
        if (placeholder) placeholder.style.display = 'none';
        if (badge) {
            badge.style.display = 'inline-block';
            badge.textContent = sessions.length;
        }
        
        // Clear existing live sessions
        if (container) {
            const existingCards = container.querySelectorAll('.live-session-card');
            existingCards.forEach(card => card.remove());
            
            // Add live session cards
            sessions.forEach(session => {
                const sessionCard = createLiveSessionCard(session);
                if (placeholder) {
                    container.insertBefore(sessionCard, placeholder);
                } else {
                    container.appendChild(sessionCard);
                }
            });
        }
    } else {
        if (placeholder) placeholder.style.display = 'block';
        if (badge) badge.style.display = 'none';
        // Remove all live session cards
        if (container) {
            const existingCards = container.querySelectorAll('.live-session-card');
            existingCards.forEach(card => card.remove());
        }
    }
}

function createLiveSessionCard(session) {
    const cardDiv = document.createElement('div');
    cardDiv.className = 'live-session-card bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-all duration-200 animate-pulse';
    
    cardDiv.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4 flex-1">
                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-600 rounded-lg flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                    <i class="fas fa-video"></i>
                </div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h4 class="font-semibold text-gray-900 text-sm">${session.title}</h4>
                        <span class="bg-red-100 text-red-800 px-2 py-0.5 text-xs font-medium rounded-full animate-pulse">
                            LIVE
                        </span>
                    </div>
                    <div class="flex items-center text-xs text-gray-600 space-x-2">
                        <span>Mentor: ${session.mentor_name}</span>
                        <span>â€¢</span>
                        <span>Started: ${formatTimeAgo(session.started_at)}</span>
                        <span>â€¢</span>
                        <span>${session.current_participants} participants</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-center">
                    <div class="bg-red-100 text-red-800 px-3 py-1 rounded-lg text-sm font-semibold animate-pulse">
                        <i class="fas fa-circle text-red-500 mr-1"></i>
                        LIVE NOW
                    </div>
                </div>
                <button onclick="joinLiveSession('${session.id}')" 
                        class="bg-red-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors animate-bounce">
                    <i class="fas fa-play mr-2"></i>
                    Join Live Room
                </button>
            </div>
        </div>
    `;
    
    return cardDiv;
}

function addLiveSession(session) {
    // Check if session is already in the list
    if (!liveSessions.find(s => s.id === session.id)) {
        liveSessions.push(session);
        updateLiveSessions(liveSessions);
    }
}

function removeLiveSession(sessionId) {
    liveSessions = liveSessions.filter(s => s.id !== sessionId);
    updateLiveSessions(liveSessions);
}

function joinLiveSession(sessionId) {
    // Show loading state
    showNotification('Joining live session...', 'info');
    
    // Navigate to session room
    window.location.href = `/sessions/${sessionId}/room/`;
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const sessionTime = new Date(timestamp);
    const diffMs = now - sessionTime;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    const diffHours = Math.floor(diffMins / 60);
    return `${diffHours}h ${diffMins % 60}m ago`;
}

// Session Management Functions
function markReady(sessionId) {
    fetch(`/sessions/api/mark-ready/${sessionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const button = document.querySelector(`button[onclick="markReady('${sessionId}')"]`);
            if (button) {
                button.innerHTML = '<i class="fas fa-check mr-2"></i>Ready âœ“';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700', 'ready-button');
                button.disabled = true;
            }
            showNotification('Marked as ready! Mentor will be notified.', 'success');
            
            // Send WebSocket message if connected
            if (dashboardSocket && dashboardSocket.readyState === WebSocket.OPEN) {
                dashboardSocket.send(JSON.stringify({
                    type: 'learner_ready',
                    session_id: sessionId
                }));
            }
        } else {
            showNotification('Error marking as ready. Please try again.', 'error');
        }
    })
    .catch(error => {
        showNotification('Network error. Please try again.', 'error');
    });
}

function joinEarlyRoom(sessionId) {
    console.log('ðŸšª joinEarlyRoom (global) called with sessionId:', sessionId, typeof sessionId);
    
    // Enhanced validation to prevent undefined URLs
    if (!sessionId || 
        sessionId === 'undefined' || 
        sessionId === 'null' || 
        sessionId === undefined || 
        sessionId === null ||
        sessionId.toString().trim() === '') {
        console.error('âŒ Invalid sessionId for joinEarlyRoom (global):', sessionId);
        showNotification('Error: Invalid session ID. Cannot join room.', 'error');
        return;
    }
    
    try {
        showNotification('Joining waiting room...', 'info');
        const cleanSessionId = encodeURIComponent(sessionId.toString().trim());
        const url = `/sessions/${cleanSessionId}/room/?early=true`;
        console.log('âœ… Navigating to:', url);
        window.location.href = url;
    } catch (error) {
        console.error('âŒ Error in joinEarlyRoom (global):', error);
        showNotification('Failed to join room. Please try again.', 'error');
    }
}

function startSession(sessionId) {
    showNotification('Starting session...', 'info');
    window.location.href = `/sessions/${sessionId}/room/?start=true`;
}

// Enhanced Notification System - Make globally available
window.showNotification = function(message, type = 'info', duration = 5000) {
    const notificationId = 'notification_' + Date.now();
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 flex items-center space-x-3 min-w-72 max-w-md`;
    
    let bgColor, iconClass;
    switch(type) {
        case 'success':
            bgColor = 'bg-green-500 text-white';
            iconClass = 'fas fa-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-500 text-white';
            iconClass = 'fas fa-exclamation-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-500 text-white';
            iconClass = 'fas fa-exclamation-triangle';
            break;
        case 'info':
        default:
            bgColor = 'bg-blue-500 text-white';
            iconClass = 'fas fa-info-circle';
            break;
    }
    
    notification.className += ` ${bgColor}`;
    notification.innerHTML = `
        <div class="flex-shrink-0">
            <i class="${iconClass} text-lg"></i>
        </div>
        <div class="flex-1">
            <p class="text-sm font-medium">${message}</p>
        </div>
        <button onclick="removeNotification('${notificationId}')" class="flex-shrink-0 ml-2 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto remove
    setTimeout(() => {
        removeNotification(notificationId);
    }, duration);
};

function removeNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.style.transform = 'translateX(400px)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
}

// Add FontAwesome for icons if not already included
if (!document.querySelector('link[href*="font-awesome"]')) {
    const fontAwesome = document.createElement('link');
    fontAwesome.rel = 'stylesheet';
    fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
    document.head.appendChild(fontAwesome);
}

function bookAgain(mentorId) {
    showNotification('Redirecting to mentor profile...', 'info');
    window.location.href = `/mentors/${mentorId}/`;
}

function filterMentors() {
    const searchTerm = document.getElementById('mentorSearch').value.toLowerCase();
    const mentorCards = document.querySelectorAll('#mentorsList .mentor-card');
    
    mentorCards.forEach(card => {
        const name = card.querySelector('h4').textContent.toLowerCase();
        const domain = card.querySelector('p').textContent.toLowerCase();
        const skills = Array.from(card.querySelectorAll('.bg-gray-100')).map(el => el.textContent.toLowerCase()).join(' ');
        
        if (name.includes(searchTerm) || domain.includes(searchTerm) || skills.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function searchMentors() {
    const searchTerm = document.getElementById('mentorSearchInput').value.toLowerCase();
    const mentorCards = document.querySelectorAll('#mentorsList .mentor-card');
    
    mentorCards.forEach(card => {
        const name = card.querySelector('h4').textContent.toLowerCase();
        const domain = card.querySelector('p').textContent.toLowerCase();
        const skills = Array.from(card.querySelectorAll('.bg-gray-100')).map(el => el.textContent.toLowerCase()).join(' ');
        
        if (name.includes(searchTerm) || domain.includes(searchTerm) || skills.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function requestFromMentor(mentorId, mentorName) {
    console.log('ðŸ“© Requesting session from mentor:', mentorName);
    showNotification(`Opening session request for ${mentorName}...`, 'info');
    
    // Create dynamic request modal
    const modal = document.createElement('div');
    modal.id = 'mentorRequestModal';
    modal.className = 'fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Request Session with ${mentorName}</h3>
                <button onclick="closeMentorRequestModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="mentorRequestForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                    <input type="text" id="requestTopic" placeholder="What would you like to learn?" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                    <select id="requestDuration" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="30">30 minutes</option>
                        <option value="60" selected>1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="requestDescription" rows="3" placeholder="Describe what you'd like to learn..." 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeMentorRequestModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="button" onclick="submitMentorRequest('${mentorId}', '${mentorName}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Send Request</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeMentorRequestModal() {
    const modal = document.getElementById('mentorRequestModal');
    if (modal) {
        modal.remove();
    }
}

function submitMentorRequest(mentorId, mentorName) {
    const topic = document.getElementById('requestTopic').value;
    const duration = document.getElementById('requestDuration').value;
    const description = document.getElementById('requestDescription').value;
    
    if (!topic.trim()) {
        alert('Please enter a topic for the session');
        return;
    }
    
    showNotification(`âœ… Session request sent to ${mentorName}! They will respond soon.`, 'success');
    closeMentorRequestModal();
    
    // Here you would normally send the request to the backend
    console.log('Request submitted:', {
        mentorId,
        topic,
        duration,
        description
    });
    
    // Switch to requests tab to show the new request
    const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
    if (dashboardElement && dashboardElement._x_dataStack) {
        dashboardElement._x_dataStack[0].activeTab = 'requests';
    }
}

// REMOVED: Duplicate simple functions - using comprehensive ones instead

// WORKING: Notification Functions
function toggleBellDropdown() {
    const dropdown = document.getElementById('bellDropdown');
    const badge = document.getElementById('bellBadge');
    
    if (dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('hidden');
        badge.style.display = 'none';
        console.log('âœ… Notifications dropdown opened on RIGHT side');
    } else {
        dropdown.classList.add('hidden');
        console.log('âŒ Notifications dropdown closed');
    }
}

function markAllRead() {
    const badge = document.getElementById('bellBadge');
    badge.style.display = 'none';
    showNotification('All notifications marked as read', 'success');
}

// WORKING: Rating Functions
function openRealRatingModal(sessionId, sessionTitle, mentorName) {
    console.log('â­ Opening REAL rating modal for session:', sessionId);
    
    // Create rating modal dynamically
    const modal = document.createElement('div');
    modal.id = 'realRatingModal';
    modal.className = 'fixed inset-0 z-[9999] overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">â­ Rate Your Session</h3>
                <button onclick="closeRealRatingModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <h4 class="font-medium text-gray-800">${sessionTitle}</h4>
                <p class="text-sm text-gray-600">with ${mentorName}</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                <div class="flex items-center space-x-1" id="realStarRating">
                    ${[1,2,3,4,5].map(star => 
                        `<button onclick="setRealRating(${star})" class="real-star-btn text-3xl text-gray-300 hover:text-yellow-400" data-rating="${star}">
                            <i class="fas fa-star"></i>
                        </button>`
                    ).join('')}
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Feedback</label>
                <textarea id="realFeedbackText" rows="3" placeholder="Share your learning experience..." 
                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeRealRatingModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="submitRealRating('${sessionId}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ðŸ’¾ Submit Rating
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeRealRatingModal() {
    const modal = document.getElementById('realRatingModal');
    if (modal) {
        modal.remove();
    }
}

let realSelectedRating = 5;

function setRealRating(rating) {
    realSelectedRating = rating;
    const stars = document.querySelectorAll('.real-star-btn');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
}

function submitRealRating(sessionId) {
    const feedback = document.getElementById('realFeedbackText').value;
    
    // Here you would normally send to the backend
    console.log('Real Rating submitted:', {
        sessionId,
        rating: realSelectedRating,
        feedback
    });
    
    showNotification(`â­ Rating submitted: ${realSelectedRating}/5 stars. Thank you!`, 'success');
    closeRealRatingModal();
    
    // Refresh the page to show updated rating
    setTimeout(() => {
        window.location.reload();
    }, 2000);
}

function viewSessionRating(sessionId) {
    showNotification('Viewing session rating details...', 'info');
    // Here you could show a modal with rating details or redirect to session page
}

// WORKING: Mentor Functions
function viewMentorProfile(mentorId) {
    console.log('ðŸ‘¤ viewMentorProfile called with mentorId:', mentorId, typeof mentorId);
    
    // Enhanced validation to prevent undefined URLs
    if (!mentorId || 
        mentorId === 'undefined' || 
        mentorId === 'null' || 
        mentorId === undefined || 
        mentorId === null ||
        mentorId.toString().trim() === '') {
        console.error('âŒ Invalid mentorId for viewMentorProfile:', mentorId);
        showNotification('Error: Invalid mentor ID. Cannot open profile.', 'error');
        return;
    }
    
    try {
        showNotification('Opening mentor profile...', 'info');
        const cleanMentorId = encodeURIComponent(mentorId.toString().trim());
        const url = `/mentors/${cleanMentorId}/profile/`;
        console.log('âœ… Navigating to mentor profile:', url);
        window.location.href = url;
    } catch (error) {
        console.error('âŒ Error in viewMentorProfile:', error);
        showNotification('Failed to open mentor profile. Please try again.', 'error');
    }
}

function followMentor(mentorId) {
    console.log(`Following mentor: ${mentorId}`);
    showNotification('ðŸ‘¥ Following mentor! You will get notifications about their sessions.', 'success');
    // Here you would implement the follow functionality
}

function bookAgain(mentorId) {
    console.log('ðŸ“… bookAgain called with mentorId:', mentorId, typeof mentorId);
    
    // Enhanced validation to prevent undefined URLs
    if (!mentorId || 
        mentorId === 'undefined' || 
        mentorId === 'null' || 
        mentorId === undefined || 
        mentorId === null ||
        mentorId.toString().trim() === '') {
        console.error('âŒ Invalid mentorId for bookAgain:', mentorId);
        showNotification('Error: Invalid mentor ID. Cannot book session.', 'error');
        return;
    }
    
    try {
        showNotification('Redirecting to mentor profile for booking...', 'info');
        const cleanMentorId = encodeURIComponent(mentorId.toString().trim());
        const url = `/mentors/${cleanMentorId}/`;
        console.log('âœ… Navigating to mentor for booking:', url);
        window.location.href = url;
    } catch (error) {
        console.error('âŒ Error in bookAgain:', error);
        showNotification('Failed to redirect to mentor. Please try again.', 'error');
    }
}

// ENHANCED: Request Management Functions
function cancelRequest(requestId) {
    if (confirm('Are you sure you want to cancel this request?')) {
        console.log('ðŸ—‘ï¸ Cancelling request:', requestId);
        showNotification('âœ… Request cancelled successfully!', 'success');
        
        // Hide the request card
        const requestCard = document.querySelector(`button[onclick="cancelRequest('${requestId}')"]`).closest('.bg-yellow-50');
        if (requestCard) {
            requestCard.style.opacity = '0.5';
            requestCard.style.pointerEvents = 'none';
            setTimeout(() => {
                requestCard.remove();
            }, 1000);
        }
        
        // Here you would normally make an API call to cancel the request
    }
}

function acknowledgeRequest(requestId, status) {
    const actionText = status === 'accepted' ? 'acknowledged and session booked' : 'acknowledged';
    console.log('âœ… Acknowledging request:', requestId, status);
    
    showNotification(`ðŸ“‹ Request ${actionText}!`, 'success');
    
    // Update the request card to show acknowledged
    const requestCard = document.querySelector(`button[onclick="acknowledgeRequest('${requestId}', '${status}')"]`).closest('.border');
    if (requestCard) {
        const buttonContainer = requestCard.querySelector('.text-right');
        buttonContainer.innerHTML = `
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                âœ“ Acknowledged
            </span>
            <p class="text-sm text-gray-500 mt-2">Thank you for the response!</p>
        `;
    }
    
    // If accepted, redirect to booking or mentor profile
    if (status === 'accepted') {
        setTimeout(() => {
            showNotification('ðŸŽ¯ Redirecting to complete your booking...', 'info');
            // Here you would redirect to booking page or mentor profile
        }, 2000);
    }
    
    // Here you would normally make an API call to acknowledge the request
}

function findAIMatch() {
    const topic = document.getElementById('aiTopicInput').value;
    const level = document.getElementById('aiLevelSelect').value;
    const duration = document.getElementById('aiDurationSelect').value;
    
    if (!topic.trim()) {
        showNotification('Please enter what you want to learn', 'warning');
        return;
    }
    
    console.log('AI Match request:', { topic, level, duration });
    showNotification('ðŸ¤– AI is finding the best mentors for you...', 'info');
    
    // Simulate AI matching and redirect to recommendations
    setTimeout(() => {
        closePopup('aiMatchPopup');
        // Switch to recommendations tab
        if (typeof Alpine !== 'undefined') {
            const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
            if (dashboardElement && dashboardElement._x_dataStack) {
                dashboardElement._x_dataStack[0].activeTab = 'recommendations';
                dashboardElement._x_dataStack[0].recTab = 'ai';
            }
        }
        showNotification('ðŸŽ¯ AI found matching mentors! Check recommendations tab.', 'success');
    }, 2000);
}

function submitSessionRequest() {
    const mentor = document.getElementById('requestMentorSelect').value;
    const category = document.getElementById('requestCategorySelect').value;
    const topic = document.getElementById('requestTopicInput').value;
    const description = document.getElementById('requestDescriptionTextarea').value;
    const duration = document.getElementById('requestDurationSelect').value;
    const urgency = document.getElementById('requestUrgencySelect').value;
    const budget = document.getElementById('requestBudgetSelect').value;
    
    if (!topic.trim()) {
        showNotification('Please enter a session topic', 'warning');
        return;
    }
    
    console.log('Session request:', {
        mentor, category, topic, description, duration, urgency, budget
    });
    
    showNotification('ðŸ“ Sending session request...', 'info');
    
    // Simulate request submission
    setTimeout(() => {
        closePopup('requestPopup');
        showNotification('âœ… Session request sent successfully! You will be notified when a mentor responds.', 'success');
    }, 1500);
}

// Close popups when clicking outside
document.addEventListener('click', function(event) {
    // Close bell dropdown
    const bellDropdown = document.getElementById('bellDropdown');
    const bellButton = event.target.closest('button[onclick="toggleBellDropdown()"]');
    
    if (!bellButton && !bellDropdown.contains(event.target)) {
        bellDropdown.classList.add('hidden');
    }
    
    // Close popups when clicking outside
    const popups = ['aiMatchPopup', 'requestPopup'];
    popups.forEach(popupId => {
        const popup = document.getElementById(popupId);
        if (popup && !popup.classList.contains('hidden')) {
            const popupContent = popup.querySelector('.bg-white');
            if (!popupContent.contains(event.target)) {
                closePopup(popupId);
            }
        }
    });
});

// ENHANCED: Real-time Follow System with Status Checking
async function initializeFollowButtons() {
    const followButtons = document.querySelectorAll('[data-mentor-id]');
    
    for (const button of followButtons) {
        const mentorId = button.getAttribute('data-mentor-id');
        
        try {
            const response = await fetch(`/api/user/follow-status/${mentorId}/`);
            const data = await response.json();
            
            updateFollowButton(button, data.is_following, mentorId);
        } catch (error) {
            console.error('Error checking follow status:', error);
        }
    }
}

function updateFollowButton(button, isFollowing, mentorId) {
    if (isFollowing) {
        button.innerHTML = '<i class="fas fa-check mr-1"></i>Following';
        button.className = button.className.replace('bg-gray-100 text-gray-700', 'bg-green-600 text-white');
        button.onclick = () => unfollowMentor(mentorId);
    } else {
        button.innerHTML = '<i class="fas fa-heart mr-1"></i>Follow';
        button.className = button.className.replace('bg-green-600 text-white', 'bg-gray-100 text-gray-700');
        button.onclick = () => followMentor(mentorId);
    }
}

async function followMentor(mentorId) {
    console.log(`Following mentor: ${mentorId}`);
    
    try {
        const response = await fetch(`/api/user/follow/${mentorId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success || data.status === 'followed') {
            showNotification(`âœ… ${data.message}`, 'success');
            
            // Update all follow buttons for this mentor
            const buttons = document.querySelectorAll(`[data-mentor-id="${mentorId}"]`);
            buttons.forEach(button => updateFollowButton(button, true, mentorId));
            
            // Update follower counts in real-time
            updateFollowerCounts(mentorId, 1);
            
            // Send real-time notification to mentor
            sendRealTimeNotification('follow', mentorId);
            
        } else {
            showNotification(`âš ï¸ ${data.message}`, 'warning');
        }
    } catch (error) {
        console.error('Error following mentor:', error);
        showNotification('âŒ Failed to follow mentor', 'error');
    }
}

async function unfollowMentor(mentorId) {
    console.log(`Unfollowing mentor: ${mentorId}`);
    
    try {
        const response = await fetch(`/api/user/unfollow/${mentorId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success || data.status === 'unfollowed') {
            showNotification(`âœ… ${data.message}`, 'success');
            
            // Update all follow buttons for this mentor
            const buttons = document.querySelectorAll(`[data-mentor-id="${mentorId}"]`);
            buttons.forEach(button => updateFollowButton(button, false, mentorId));
            
            // Update follower counts in real-time
            updateFollowerCounts(mentorId, -1);
            
        } else {
            showNotification(`âš ï¸ ${data.message}`, 'warning');
        }
    } catch (error) {
        console.error('Error unfollowing mentor:', error);
        showNotification('âŒ Failed to unfollow mentor', 'error');
    }
}

function updateFollowerCounts(mentorId, change) {
    // Update follower count displays
    const countElements = document.querySelectorAll(`[data-mentor-follower-count="${mentorId}"]`);
    countElements.forEach(element => {
        const currentCount = parseInt(element.textContent) || 0;
        element.textContent = Math.max(0, currentCount + change);
    });
}

function sendRealTimeNotification(type, targetUserId) {
    // Send real-time notification via WebSocket
    if (window.dashboardSocket && window.dashboardSocket.readyState === WebSocket.OPEN) {
        window.dashboardSocket.send(JSON.stringify({
            type: 'notification',
            notification_type: type,
            target_user_id: targetUserId,
            message: `New ${type} notification`
        }));
    }
}

// ENHANCED: Real-time Session Time Management
class SessionTimeManager {
    constructor() {
        this.timers = new Map();
        this.init();
    }
    
    init() {
        this.startSessionCountdowns();
        this.checkUpcomingSessions();
        
        // Check every minute for session updates
        setInterval(() => {
            this.updateAllTimers();
            this.checkUpcomingSessions();
        }, 60000);
    }
    
    startSessionCountdowns() {
        const sessionCards = document.querySelectorAll('[data-session-time]');
        
        sessionCards.forEach(card => {
            const sessionTime = new Date(card.getAttribute('data-session-time'));
            const sessionId = card.getAttribute('data-session-id');
            
            this.createCountdown(sessionId, sessionTime, card);
        });
    }
    
    createCountdown(sessionId, targetTime, element) {
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetTime.getTime() - now;
            
            if (distance < 0) {
                clearInterval(timer);
                this.handleSessionStart(sessionId, element);
                return;
            }
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            let timeText = '';
            if (days > 0) {
                timeText = `${days}d ${hours}h`;
            } else if (hours > 0) {
                timeText = `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                timeText = `${minutes}m ${seconds}s`;
            } else {
                timeText = `${seconds}s`;
            }
            
            const timeElement = element.querySelector('.session-countdown');
            if (timeElement) {
                timeElement.textContent = `Starts in ${timeText}`;
                
                // Add urgency styling based on time remaining
                if (distance < 300000) { // Less than 5 minutes
                    timeElement.className = 'session-countdown text-red-600 font-bold animate-pulse';
                    this.sendSessionReminder(sessionId, 'starting_soon');
                } else if (distance < 900000) { // Less than 15 minutes
                    timeElement.className = 'session-countdown text-orange-600 font-medium';
                    this.sendSessionReminder(sessionId, 'starting_15min');
                }
            }
        }, 1000);
        
        this.timers.set(sessionId, timer);
    }
    
    handleSessionStart(sessionId, element) {
        // Update UI to show session is live
        const statusBadge = element.querySelector('.session-status');
        if (statusBadge) {
            statusBadge.innerHTML = 'ðŸ”´ LIVE';
            statusBadge.className = 'session-status bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse';
        }
        
        // Show join button
        this.showJoinButton(sessionId, element);
        
        // Send real-time notification
        this.sendSessionNotification(sessionId, 'session_started');
    }
    
    showJoinButton(sessionId, element) {
        const actionsContainer = element.querySelector('.session-actions');
        if (actionsContainer) {
            const joinButton = document.createElement('button');
            joinButton.innerHTML = 'ðŸŽ¯ Join Live Session';
            joinButton.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold text-sm animate-pulse';
            joinButton.onclick = () => joinLiveSession(sessionId);
            
            actionsContainer.appendChild(joinButton);
        }
    }
    
    sendSessionReminder(sessionId, type) {
        // Send automatic session reminders
        fetch('/api/sessions/send-reminder/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: sessionId,
                reminder_type: type
            })
        }).catch(error => console.error('Error sending reminder:', error));
    }
    
    sendSessionNotification(sessionId, type) {
        // Send real-time session notifications
        if (window.dashboardSocket && window.dashboardSocket.readyState === WebSocket.OPEN) {
            window.dashboardSocket.send(JSON.stringify({
                type: 'session_notification',
                session_id: sessionId,
                notification_type: type
            }));
        }
    }
    
    updateAllTimers() {
        // Refresh all session data
        this.loadLiveSessions();
    }
    
    async loadLiveSessions() {
        try {
            const response = await fetch('/sessions/api/live-sessions/');
            const data = await response.json();
            
            if (data.success || response.ok) {
                this.updateLiveSessionsUI(data.sessions || data);
            }
        } catch (error) {
            console.error('Error loading live sessions:', error);
        }
    }
    
    updateLiveSessionsUI(liveSessions) {
        const liveContainer = document.getElementById('live-sessions-container');
        if (!liveContainer) return;
        
        if (liveSessions.length === 0) {
            liveContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-video-slash text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-500">No live sessions right now</p>
                </div>
            `;
            return;
        }
        
        liveContainer.innerHTML = liveSessions.map(session => `
            <div class="course-card bg-white rounded-3xl shadow-xl overflow-hidden transform hover:-translate-y-2 hover:scale-105 transition-all duration-500" 
                 data-session-id="${session.id}" data-session-time="${session.schedule}">
                <div class="relative h-32 bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white text-lg font-bold mb-2">
                            ðŸ”´
                        </div>
                        <div class="text-white text-xs font-medium">LIVE NOW</div>
                    </div>
                    
                    <div class="absolute top-2 right-2">
                        <span class="bg-red-600 text-white px-2 py-1 text-xs font-bold rounded-full shadow-lg animate-pulse">
                            ðŸ”´ Live
                        </span>
                    </div>
                    
                    <div class="absolute bottom-2 left-2">
                        <span class="bg-black bg-opacity-50 text-white px-2 py-1 text-xs rounded-full">
                            ðŸ‘¥ ${session.participant_count} watching
                        </span>
                    </div>
                </div>

                <div class="p-4">
                    <h3 class="text-md font-bold text-gray-900 mb-2 line-clamp-2">${session.title}</h3>
                    <p class="text-sm text-gray-600 mb-3 font-medium">${session.mentor_name}</p>
                    
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-xs font-bold text-red-600">â±ï¸ ${session.duration} min</span>
                        </div>
                        <span class="text-xs text-red-600 font-bold animate-pulse">LIVE NOW</span>
                    </div>
                    
                    <div class="session-actions space-y-2">
                        <button onclick="joinLiveSession('${session.id}')" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-xl font-bold text-sm transition-colors animate-pulse">
                            ðŸŽ¯ Join Live Session
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    checkUpcomingSessions() {
        // Check for sessions starting soon and send reminders
        const now = new Date();
        const sessionElements = document.querySelectorAll('[data-session-time]');
        
        sessionElements.forEach(element => {
            const sessionTime = new Date(element.getAttribute('data-session-time'));
            const sessionId = element.getAttribute('data-session-id');
            const timeDiff = sessionTime.getTime() - now.getTime();
            
            // Send reminder notifications
            if (timeDiff > 0 && timeDiff <= 900000 && !element.hasAttribute('data-15min-sent')) { // 15 minutes
                this.sendSessionReminder(sessionId, '15_minute_reminder');
                element.setAttribute('data-15min-sent', 'true');
            }
            
            if (timeDiff > 0 && timeDiff <= 300000 && !element.hasAttribute('data-5min-sent')) { // 5 minutes
                this.sendSessionReminder(sessionId, '5_minute_reminder');
                element.setAttribute('data-5min-sent', 'true');
            }
            
            if (timeDiff > 0 && timeDiff <= 60000 && !element.hasAttribute('data-1min-sent')) { // 1 minute
                this.sendSessionReminder(sessionId, '1_minute_reminder');
                element.setAttribute('data-1min-sent', 'true');
            }
        });
    }
}

// Initialize real-time features when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize follow system
    initializeFollowButtons();
    
    // Initialize session time management
    window.sessionTimeManager = new SessionTimeManager();
    
    // Initialize real-time updates
    initializeRealTimeUpdates();
});

function initializeRealTimeUpdates() {
    // Connect to WebSocket for real-time updates
    connectToWebSocket();
    
    // Add a small delay to ensure DOM is ready
    setTimeout(() => {
        // Update session data every 30 seconds
        setInterval(updateSessionData, 30000);
        
        // Update notifications every 15 seconds
        setInterval(updateNotifications, 15000);
    }, 2000);
}

async function updateSessionData() {
    try {
        const response = await fetch('/api/sessions/learner-data/');
        const data = await response.json();
        
        if (data.success || response.ok) {
            // Update Alpine.js dashboard data if available
            const dashboardElement = document.querySelector('[x-data*="learnerDashboard"]');
            if (dashboardElement && dashboardElement._x_dataStack && dashboardElement._x_dataStack[0]) {
                const dashboard = dashboardElement._x_dataStack[0];
                if (dashboard.updateSessionCounts) {
                    dashboard.updateSessionCounts(data);
                } else {
                    dashboard.sessions = data.sessions || dashboard.sessions;
                    dashboard.stats = data.stats || dashboard.stats;
                }
            }
        }
    } catch (error) {
        console.error('Error updating session data:', error);
    }
}

async function updateNotifications() {
    try {
        const response = await fetch('/api/notifications/');
        const data = await response.json();
        
        if (data.notifications) {
            updateNotificationBadge(data.unread_count || 0);
        }
    } catch (error) {
        console.error('Error updating notifications:', error);
    }
}

function updateNotificationBadge(count) {
    // Add multiple selectors for notification badge
    const badge = document.querySelector('.notification-badge') || 
                  document.querySelector('[class*="notification"]') ||
                  document.querySelector('#notificationBadge');
                  
    if (badge && badge.style) {
        badge.textContent = count || 0;
        badge.style.display = (count && count > 0) ? 'block' : 'none';
    } else {
        console.warn('Notification badge element not found - this is normal during page load');
    }
}

function connectToWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
    
    window.dashboardSocket = new WebSocket(wsUrl);
    
    window.dashboardSocket.onopen = function(e) {
        console.log('Connected to real-time dashboard updates');
    };
    
    window.dashboardSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleRealTimeUpdate(data);
    };
    
    window.dashboardSocket.onclose = function(e) {
        console.log('Disconnected from real-time updates. Reconnecting...');
        // Reconnect after 5 seconds
        setTimeout(connectToWebSocket, 5000);
    };
}

function handleRealTimeUpdate(data) {
    switch(data.type) {
        case 'notification':
            showRealTimeNotification(data.notification);
            break;
        case 'session_update':
            updateSessionStatus(data.session);
            break;
        case 'follow_update':
            updateFollowCounts(data.follow_data);
            break;
        case 'booking_update':
            updateBookingStatus(data.booking);
            break;
        default:
            console.log('Unknown real-time update:', data);
    }
}

function showRealTimeNotification(notification) {
    showNotification(notification.message, notification.type || 'info');
    
    // Update notification count
    updateNotificationBadge((parseInt(document.querySelector('.notification-badge')?.textContent) || 0) + 1);
}

async function joinLiveSession(sessionId) {
    console.log('Joining live session:', sessionId);
    
    try {
        const response = await fetch(`/api/sessions/${sessionId}/join/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to session room
            window.location.href = `/sessions/${sessionId}/room/`;
        } else {
            showNotification(`âŒ ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Error joining session:', error);
        showNotification('âŒ Failed to join session', 'error');
    }
}

// Enhanced Feedback Functions
async function refreshFeedbackData() {
    try {
        showNotification('Refreshing feedback data...', 'info');
        
        const dashboard = Alpine.getElementProperty(document.getElementById('learnerDashboard'), '$data');
        if (dashboard) {
            await dashboard.loadFeedbackData();
            await dashboard.loadUnratedSessions();
            showNotification('Feedback data refreshed!', 'success');
        }
    } catch (error) {
        showNotification('Error refreshing feedback data', 'error');
    }
}

function openFeedbackModal(sessionId, sessionTitle, mentorName) {
    const modal = document.createElement('div');
    modal.id = 'feedbackModal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
    modal.onclick = (e) => { if (e.target === modal) closeFeedbackModal(); };
    
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    Rate Your Session
                </h3>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-medium text-gray-800 mb-1">${sessionTitle}</h4>
                <p class="text-sm text-gray-600">with ${mentorName}</p>
            </div>
            
            <!-- Enhanced Rating System -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Overall Rating</label>
                <div class="flex items-center justify-center space-x-2 mb-4">
                    ${Array.from({length: 5}, (_, i) => 
                        `<button onclick="setFeedbackRating(${i + 1})" 
                                class="feedback-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors" 
                                data-rating="${i + 1}">
                            <i class="fas fa-star"></i>
                        </button>`
                    ).join('')}
                </div>
                <p id="ratingText" class="text-center text-sm text-gray-600">Click to rate</p>
            </div>
            
            <!-- Additional Rating Categories -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-2">Session Quality</label>
                    <div class="flex space-x-1" id="sessionQualityRating">
                        ${Array.from({length: 5}, (_, i) => 
                            `<button onclick="setAdditionalRating('sessionQuality', ${i + 1})" 
                                    class="additional-star text-sm text-gray-300 hover:text-yellow-400" 
                                    data-category="sessionQuality" data-rating="${i + 1}">
                                <i class="fas fa-star"></i>
                            </button>`
                        ).join('')}
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-2">Mentor Effectiveness</label>
                    <div class="flex space-x-1" id="mentorEffectivenessRating">
                        ${Array.from({length: 5}, (_, i) => 
                            `<button onclick="setAdditionalRating('mentorEffectiveness', ${i + 1})" 
                                    class="additional-star text-sm text-gray-300 hover:text-yellow-400" 
                                    data-category="mentorEffectiveness" data-rating="${i + 1}">
                                <i class="fas fa-star"></i>
                            </button>`
                        ).join('')}
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-2">Content Relevance</label>
                    <div class="flex space-x-1" id="contentRelevanceRating">
                        ${Array.from({length: 5}, (_, i) => 
                            `<button onclick="setAdditionalRating('contentRelevance', ${i + 1})" 
                                    class="additional-star text-sm text-gray-300 hover:text-yellow-400" 
                                    data-category="contentRelevance" data-rating="${i + 1}">
                                <i class="fas fa-star"></i>
                            </button>`
                        ).join('')}
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-2">Technical Quality</label>
                    <div class="flex space-x-1" id="technicalQualityRating">
                        ${Array.from({length: 5}, (_, i) => 
                            `<button onclick="setAdditionalRating('technicalQuality', ${i + 1})" 
                                    class="additional-star text-sm text-gray-300 hover:text-yellow-400" 
                                    data-category="technicalQuality" data-rating="${i + 1}">
                                <i class="fas fa-star"></i>
                            </button>`
                        ).join('')}
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Feedback Comment</label>
                <textarea id="feedbackComment" rows="4" 
                          placeholder="Share your experience, what you learned, or suggestions for improvement..." 
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeFeedbackModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">Cancel</button>
                <button onclick="submitEnhancedFeedback('${sessionId}')" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Review
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeFeedbackModal() {
    const modal = document.getElementById('feedbackModal');
    if (modal) {
        modal.remove();
    }
}

let modalSelectedRating = 5;
let additionalRatings = {
    sessionQuality: 5,
    mentorEffectiveness: 5,
    contentRelevance: 5,
    technicalQuality: 5
};

function setFeedbackRating(rating) {
    modalSelectedRating = rating;
    
    const stars = document.querySelectorAll('.feedback-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
    
    const texts = {
        1: 'Poor - Needs significant improvement',
        2: 'Fair - Some issues to address',
        3: 'Good - Generally satisfied',
        4: 'Very Good - Impressed with the session',
        5: 'Excellent - Outstanding session!'
    };
    
    document.getElementById('ratingText').textContent = texts[rating];
}

function setAdditionalRating(category, rating) {
    additionalRatings[category] = rating;
    
    const stars = document.querySelectorAll(`[data-category="${category}"]`);
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
}

async function submitEnhancedFeedback(sessionId) {
    const comment = document.getElementById('feedbackComment').value;
    
    try {
        const response = await fetch(`/sessions/api/session/${sessionId}/feedback/submit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                rating: modalSelectedRating,
                comment: comment,
                session_quality: additionalRatings.sessionQuality,
                mentor_effectiveness: additionalRatings.mentorEffectiveness,
                content_relevance: additionalRatings.contentRelevance,
                technical_quality: additionalRatings.technicalQuality
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(data.message, 'success');
            closeFeedbackModal();
            
            // Refresh feedback data
            const dashboard = Alpine.getElementProperty(document.getElementById('learnerDashboard'), '$data');
            if (dashboard) {
                dashboard.loadFeedbackData();
                dashboard.loadUnratedSessions();
            }
        } else {
            const error = await response.json();
            showNotification(error.error || 'Failed to submit feedback', 'error');
        }
    } catch (error) {
        showNotification('Network error', 'error');
    }
}

function editFeedback(feedbackId) {
    showNotification('Editing feedback coming soon!', 'info');
}

// Global CSRF Token helper function
function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    // Fallback: try getting from meta tag or form
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    
    const input = document.querySelector('[name="csrfmiddlewaretoken"]');
    if (input) return input.value;
    
    return '';
}

// Global popup helper functions
function closePopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.classList.add('hidden');
    }
}

function openPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.classList.remove('hidden');
    }
}

// Tab switching is now handled by Alpine.js - no need for switchTab function

// Initialize on DOM loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ‰ PeerLearn Dashboard initialized successfully!');
    
    // Make sure showNotification is globally available
    if (typeof window.showNotification === 'undefined') {
        window.showNotification = showNotification;
    }
});
</script>





<!-- FIXED: REMOVED FEEDBACK MODAL - Feedback should only be available in WebRTC room -->
<!-- This modal has been removed to prevent auto-opening issues -->
<!-- All feedback should be done in the WebRTC session room where it's properly implemented -->

{% endblock %}



<!-- WORKING: AI Match Popup -->
<div id="aiMatchPopup" class="hidden fixed inset-0 z-[9999] overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">ðŸ¤– AI Mentor Matching</h3>
            <button onclick="closePopup('aiMatchPopup')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">What do you want to learn?</label>
            <input type="text" id="aiTopicInput" placeholder="e.g., Python programming, Data Science, Web Development"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Experience Level</label>
            <select id="aiLevelSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="beginner">ðŸŸ¢ Beginner</option>
                                <option value="intermediate">ðŸŸ¡ Intermediate</option>
                                <option value="advanced">ðŸ”´ Advanced</option>
                            </select>
                        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Session Duration</label>
            <select id="aiDurationSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closePopup('aiMatchPopup')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button onclick="findAIMatch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ðŸ” Find AI Match
                </button>
        </div>
    </div>
</div>

<!-- WORKING: Request Session Popup -->
<div id="requestPopup" class="hidden fixed inset-0 z-[9999] overflow-y-auto flex items-center justify-center bg-gray-500 bg-opacity-75">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">ðŸ“ Request Custom Session</h3>
            <button onclick="closePopup('requestPopup')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Mentor</label>
                <select id="requestMentorSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Any Available Mentor</option>
                    {% for mentor in available_mentors %}
                        <option value="{{ mentor.id }}">{{ mentor.get_full_name }} - {{ mentor.domain|default:"General" }}</option>
                    {% endfor %}
                                </select>
                            </div>
                            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Session Category</label>
                <select id="requestCategorySelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="programming">ðŸ’» Programming</option>
                                    <option value="data-science">ðŸ“Š Data Science</option>
                                    <option value="web-dev">ðŸŒ Web Development</option>
                                    <option value="ai-ml">ðŸ¤– AI/Machine Learning</option>
                                    <option value="career">ðŸ’¼ Career Guidance</option>
                                </select>
                            </div>
                        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Session Topic</label>
            <input type="text" id="requestTopicInput" placeholder="e.g., Advanced Python OOP concepts"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Detailed Description</label>
            <textarea id="requestDescriptionTextarea" rows="3" placeholder="Describe what you want to learn and your current level..."
                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                <select id="requestDurationSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                    <option value="90">1.5 hours</option>
                                    <option value="120">2 hours</option>
                                </select>
                            </div>
                            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Urgency</label>
                <select id="requestUrgencySelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="flexible">ðŸ• Flexible</option>
                                    <option value="today">ðŸ”¥ Today</option>
                                    <option value="tomorrow">âš¡ Tomorrow</option>
                                    <option value="this-week">ðŸ“… This Week</option>
                                </select>
                            </div>
                            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Budget Range</label>
                <select id="requestBudgetSelect" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="free">Free</option>
                                    <option value="0-500">â‚¹0 - â‚¹500</option>
                                    <option value="500-1000">â‚¹500 - â‚¹1000</option>
                                    <option value="1000+">â‚¹1000+</option>
                                </select>
                            </div>
                        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closePopup('requestPopup')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button onclick="submitSessionRequest()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    ðŸš€ Send Request
                </button>
            </div>
        </div>
    </div>