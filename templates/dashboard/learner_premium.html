{% extends 'base.html' %}

{% block title %}Learner Dashboard - PeerLearn{% endblock %}

{% block extra_head %}
<!-- Razorpay Payment Gateway -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
    .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .main-content {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .premium-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    .premium-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    .session-thumbnail {
        background: linear-gradient(45deg, #667eea, #764ba2);
    }
    .ai-badge {
        background: linear-gradient(45deg, #ff6b6b, #ffa500);
    }
    .status-ready {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
    }
    .status-waiting {
        background: linear-gradient(45deg, #f093fb, #f5576c);
    }
    .mentor-avatar {
        border: 3px solid #667eea;
    }
    .nav-item {
        transition: all 0.3s ease;
    }
    .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }
    .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        border-right: 4px solid #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100" x-data="learnerDashboard()">
    <!-- Sidebar -->
    <div class="sidebar w-64 text-white shadow-xl">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <i data-feather="user" class="h-6 w-6 text-purple-600"></i>
                </div>
                <div>
                    <h2 class="font-bold text-lg">{{ user.first_name }}</h2>
                    <p class="text-purple-200 text-sm">Learner</p>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="space-y-2">
                <a @click="activeTab = 'browse'" 
                   :class="activeTab === 'browse' ? 'active' : ''"
                   class="nav-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer">
                    <i data-feather="search" class="h-5 w-5"></i>
                    <span>Browse Sessions</span>
                </a>
                
                <a @click="activeTab = 'sessions'"
                   :class="activeTab === 'sessions' ? 'active' : ''"
                   class="nav-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer">
                    <i data-feather="calendar" class="h-5 w-5"></i>
                    <span>My Sessions</span>
                </a>
                
                <a @click="activeTab = 'recommendations'"
                   :class="activeTab === 'recommendations' ? 'active' : ''"
                   class="nav-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer">
                    <i data-feather="zap" class="h-5 w-5"></i>
                    <span>AI Recommendations</span>
                </a>
                
                <a @click="activeTab = 'payments'"
                   :class="activeTab === 'payments' ? 'active' : ''"
                   class="nav-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer">
                    <i data-feather="credit-card" class="h-5 w-5"></i>
                    <span>Payment History</span>
                </a>
                
                <a @click="activeTab = 'notifications'"
                   :class="activeTab === 'notifications' ? 'active' : ''"
                   class="nav-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer">
                    <i data-feather="bell" class="h-5 w-5"></i>
                    <span>Notifications</span>
                    <span x-show="unreadCount > 0" 
                          class="bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center ml-auto"
                          x-text="unreadCount"></span>
                </a>
            </nav>
        </div>
        
        <!-- Quick Actions -->
        <div class="p-6 border-t border-purple-400">
            <button @click="showRequestModal = true"
                    class="w-full bg-white text-purple-600 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-colors">
                <i data-feather="plus" class="h-4 w-4 inline mr-2"></i>
                Request Session
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 main-content overflow-y-auto">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
                    <p class="text-gray-600">Welcome back, {{ user.first_name }}! Ready to learn?</p>
                </div>
                <div class="flex space-x-4">
                    <div class="relative">
                        <input type="text" 
                               placeholder="Search sessions..." 
                               x-model="searchQuery"
                               @input="filterSessions()"
                               class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <i data-feather="search" class="h-4 w-4 absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="p-6">
            <!-- Browse Sessions Tab -->
            <div x-show="activeTab === 'browse'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Available Sessions</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="sessionsList">
                        {% for session in available_sessions %}
                        <div class="premium-card rounded-xl p-6 session-card">
                            <!-- Session Thumbnail -->
                            <div class="session-thumbnail w-full h-32 rounded-lg mb-4 flex items-center justify-center text-white">
                                <div class="text-center">
                                    <div class="text-2xl font-bold">{{ session.title|first|upper }}</div>
                                    <div class="text-sm opacity-80">{{ session.duration }}min</div>
                                </div>
                            </div>
                            
                            <!-- Session Info -->
                            <div class="mb-4">
                                <h3 class="font-bold text-lg text-gray-900 mb-2">{{ session.title }}</h3>
                                <p class="text-gray-600 text-sm mb-3">{{ session.description|truncatewords:15 }}</p>
                                
                                <!-- Mentor Info -->
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="mentor-avatar w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        {{ session.mentor.first_name|first }}{{ session.mentor.last_name|first }}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900 text-sm">{{ session.mentor.first_name }} {{ session.mentor.last_name }}</p>
                                        <p class="text-gray-500 text-xs">Mentor</p>
                                    </div>
                                    <button onclick="viewMentorProfile('{{ session.mentor.id }}')"
                                            class="ml-auto text-purple-600 hover:text-purple-800 text-xs">
                                        View Profile
                                    </button>
                                </div>
                                
                                <!-- Session Details -->
                                <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
                                    <span>{{ session.schedule|date:"M d, H:i" }}</span>
                                    <span>{{ session.max_participants }} spots</span>
                                </div>
                            </div>
                            
                            <!-- Price and Actions -->
                            <div class="flex justify-between items-center">
                                {% if session.price > 0 %}
                                    <span class="text-2xl font-bold text-purple-600">â‚¹{{ session.price }}</span>
                                {% else %}
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">Free</span>
                                {% endif %}
                                
                                <button onclick="enrollInSession('{{ session.id }}', '{{ session.title }}', {{ session.price }})"
                                        {% if session.is_full %}disabled{% endif %}
                                        class="{% if session.is_full %}bg-gray-300 cursor-not-allowed{% else %}bg-purple-600 hover:bg-purple-700{% endif %} text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                                    {% if session.is_full %}Full{% else %}Enroll Now{% endif %}
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-full text-center py-12">
                            <i data-feather="calendar" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Sessions Available</h3>
                            <p class="text-gray-500 mb-4">Check back later for new sessions.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- My Sessions Tab -->
            <div x-show="activeTab === 'sessions'">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">My Sessions</h2>
                        <div class="flex space-x-2">
                            <button @click="sessionView = 'upcoming'"
                                    :class="sessionView === 'upcoming' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700'"
                                    class="px-4 py-2 rounded-lg text-sm font-medium border">
                                Upcoming
                            </button>
                            <button @click="sessionView = 'completed'"
                                    :class="sessionView === 'completed' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700'"
                                    class="px-4 py-2 rounded-lg text-sm font-medium border">
                                Completed
                            </button>
                        </div>
                    </div>
                    
                    <!-- Upcoming Sessions -->
                    <div x-show="sessionView === 'upcoming'" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {% for booking in user_bookings %}
                        <div class="premium-card rounded-xl p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-900">{{ booking.session.title }}</h3>
                                    <p class="text-gray-600 text-sm">{{ booking.session.schedule|date:"M d, Y at H:i" }}</p>
                                </div>
                                {% if booking.session.status == 'live' %}
                                    <span class="status-ready text-white px-3 py-1 rounded-full text-sm font-semibold">Live</span>
                                {% elif booking.session.can_start_soon %}
                                    <span class="status-waiting text-white px-3 py-1 rounded-full text-sm font-semibold">Starting Soon</span>
                                {% else %}
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">Scheduled</span>
                                {% endif %}
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-500">
                                    <p>Mentor: {{ booking.session.mentor.first_name }} {{ booking.session.mentor.last_name }}</p>
                                    <p>Duration: {{ booking.session.duration }} minutes</p>
                                </div>
                                
                                <div class="flex space-x-2">
                                    {% if booking.session.status == 'live' %}
                                        <button onclick="joinSession('{{ booking.session.id }}')"
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">
                                            Join Now
                                        </button>
                                    {% elif booking.session.can_join_early %}
                                        <button onclick="markReady('{{ booking.session.id }}')"
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                                            Mark Ready
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-full text-center py-12">
                            <i data-feather="calendar" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Upcoming Sessions</h3>
                            <p class="text-gray-500">Browse sessions to book your first learning session.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- AI Recommendations Tab -->
            <div x-show="activeTab === 'recommendations'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <span class="ai-badge text-white px-3 py-1 rounded-full text-sm font-semibold mr-2">AI</span>
                        Recommended For You
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        <template x-for="session in aiRecommendations" :key="session.id">
                            <div class="premium-card rounded-xl p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="session-thumbnail w-16 h-16 rounded-lg flex items-center justify-center text-white text-lg font-bold"
                                         x-text="session.title.charAt(0)"></div>
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold"
                                          x-text="`${session.match_score}% Match`"></span>
                                </div>
                                
                                <h3 class="font-bold text-lg text-gray-900 mb-2" x-text="session.title"></h3>
                                <p class="text-gray-600 text-sm mb-3" x-text="session.description"></p>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-purple-600" x-text="`â‚¹${session.price}`"></span>
                                    <button @click="enrollInSession(session.id, session.title, session.price)"
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold">
                                        Enroll
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Payment History Tab -->
            <div x-show="activeTab === 'payments'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment History</h2>
                    
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-6">
                            <div class="space-y-4" x-show="paymentHistory.length > 0">
                                <template x-for="payment in paymentHistory" :key="payment.id">
                                    <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg">
                                        <div>
                                            <h4 class="font-semibold text-gray-900" x-text="payment.session_title"></h4>
                                            <p class="text-sm text-gray-500" x-text="payment.date"></p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-lg" x-text="`â‚¹${payment.amount}`"></p>
                                            <span :class="payment.status === 'completed' ? 'text-green-600' : 'text-red-600'"
                                                  class="text-sm font-semibold" x-text="payment.status"></span>
                                        </div>
                                        <button x-show="payment.can_refund" 
                                                @click="requestRefund(payment.id)"
                                                class="ml-4 text-red-600 hover:text-red-800 text-sm">
                                            Request Refund
                                        </button>
                                    </div>
                                </template>
                            </div>
                            
                            <div x-show="paymentHistory.length === 0" class="text-center py-12">
                                <i data-feather="credit-card" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Payment History</h3>
                                <p class="text-gray-500">Your payment history will appear here after booking sessions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div x-show="activeTab === 'notifications'">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Notifications</h2>
                        <button @click="markAllNotificationsRead()"
                                class="text-purple-600 hover:text-purple-800 text-sm">
                            Mark All Read
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="notification in notifications" :key="notification.id">
                            <div :class="notification.read ? 'bg-gray-50' : 'bg-purple-50'"
                                 class="premium-card rounded-xl p-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center mb-2">
                                            <i :data-feather="notification.icon" class="h-4 w-4 mr-2 text-purple-600"></i>
                                            <h4 class="font-medium text-gray-900" x-text="notification.title"></h4>
                                            <span x-show="!notification.read" class="ml-2 w-2 h-2 bg-purple-600 rounded-full"></span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2" x-text="notification.message"></p>
                                        <p class="text-xs text-gray-500" x-text="notification.time"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Session Modal -->
    <div x-show="showRequestModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity" @click="showRequestModal = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Request Custom Session</h3>
                    <form @submit.prevent="submitSessionRequest()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Mentor</label>
                                <select x-model="sessionRequest.mentor_id" required
                                        class="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-2 focus:ring-purple-500">
                                    <option value="">Choose a mentor...</option>
                                    {% for mentor in mentors %}
                                    <option value="{{ mentor.id }}">{{ mentor.first_name }} {{ mentor.last_name }} - {{ mentor.expertise }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                                <input type="text" x-model="sessionRequest.topic" required
                                       class="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-2 focus:ring-purple-500"
                                       placeholder="What would you like to learn?">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea x-model="sessionRequest.description" rows="3"
                                         class="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-2 focus:ring-purple-500"
                                         placeholder="Provide more details about what you want to learn..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Budget (â‚¹)</label>
                                <input type="number" x-model="sessionRequest.budget" min="0"
                                       class="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-2 focus:ring-purple-500"
                                       placeholder="500">
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" @click="showRequestModal = false"
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                                Send Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function learnerDashboard() {
    return {
        activeTab: 'browse',
        sessionView: 'upcoming',
        showRequestModal: false,
        searchQuery: '',
        unreadCount: 0,
        aiRecommendations: [],
        paymentHistory: [],
        notifications: [],
        sessionRequest: {
            mentor_id: '',
            topic: '',
            description: '',
            budget: ''
        },
        
        async init() {
            await this.loadAIRecommendations();
            await this.loadPaymentHistory();
            await this.loadNotifications();
            this.initFeatherIcons();
        },
        
        async loadAIRecommendations() {
            try {
                const response = await fetch('/api/recommendations/ai/');
                const data = await response.json();
                this.aiRecommendations = data.recommendations || [];
            } catch (error) {
                console.error('Failed to load AI recommendations:', error);
            }
        },
        
        async loadPaymentHistory() {
            try {
                const response = await fetch('/api/learner/payment-history/');
                const data = await response.json();
                this.paymentHistory = data.payments || [];
            } catch (error) {
                console.error('Failed to load payment history:', error);
            }
        },
        
        async loadNotifications() {
            try {
                const response = await fetch('/api/notifications/');
                const data = await response.json();
                this.notifications = data.notifications || [];
                this.unreadCount = this.notifications.filter(n => !n.read).length;
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        },
        
        async submitSessionRequest() {
            try {
                const response = await fetch('/api/session-requests/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(this.sessionRequest)
                });
                
                if (response.ok) {
                    showSuccessMessage('Session request sent successfully!');
                    this.showRequestModal = false;
                    this.sessionRequest = { mentor_id: '', topic: '', description: '', budget: '' };
                } else {
                    const error = await response.json();
                    showErrorMessage(error.message || 'Failed to send request');
                }
            } catch (error) {
                console.error('Request error:', error);
                showErrorMessage('Failed to send request. Please try again.');
            }
        },
        
        async markAllNotificationsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                if (response.ok) {
                    this.notifications.forEach(n => n.read = true);
                    this.unreadCount = 0;
                }
            } catch (error) {
                console.error('Failed to mark notifications as read:', error);
            }
        },
        
        filterSessions() {
            const searchTerm = this.searchQuery.toLowerCase();
            const sessionCards = document.querySelectorAll('.session-card');
            
            sessionCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        },
        
        initFeatherIcons() {
            this.$nextTick(() => {
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });
        }
    }
}

// Session enrollment function
async function enrollInSession(sessionId, sessionTitle, sessionPrice) {
    try {
        if (sessionPrice === 0) {
            // Free session - book directly
            const response = await fetch(`/api/sessions/${sessionId}/book/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (response.ok) {
                showSuccessMessage('Session booked successfully!');
                setTimeout(() => location.reload(), 1500);
            } else {
                const error = await response.json();
                showErrorMessage(error.message || 'Failed to book session');
            }
            return;
        }
        
        // Paid session - initiate payment
        const paymentResponse = await fetch('/api/learner/create-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const paymentData = await paymentResponse.json();
        
        if (paymentData.success) {
            const options = {
                key: paymentData.key,
                amount: paymentData.amount * 100,
                currency: paymentData.currency,
                order_id: paymentData.order_id,
                name: 'PeerLearn',
                description: `Session: ${sessionTitle}`,
                prefill: paymentData.prefill,
                theme: { color: '#667eea' },
                handler: function(response) {
                    verifyPaymentAndBook(response, sessionId);
                },
                modal: {
                    ondismiss: function() {
                        showErrorMessage('Payment cancelled');
                    }
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            showErrorMessage(paymentData.error || 'Failed to initiate payment');
        }
    } catch (error) {
        console.error('Enrollment error:', error);
        showErrorMessage('Failed to enroll in session. Please try again.');
    }
}

// Payment verification
async function verifyPaymentAndBook(response, sessionId) {
    try {
        const verifyResponse = await fetch('/api/learner/verify-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                session_id: sessionId
            })
        });
        
        const verifyData = await verifyResponse.json();
        
        if (verifyData.success) {
            showSuccessMessage('Payment successful! Session booked.');
            setTimeout(() => location.reload(), 2000);
        } else {
            showErrorMessage(verifyData.error || 'Payment verification failed');
        }
    } catch (error) {
        console.error('Payment verification error:', error);
        showErrorMessage('Payment verification failed. Please contact support.');
    }
}

// Other helper functions
function viewMentorProfile(mentorId) {
    window.location.href = `/profile/${mentorId}/`;
}

function joinSession(sessionId) {
    window.location.href = `/sessions/${sessionId}/room/`;
}

function markReady(sessionId) {
    fetch(`/api/sessions/${sessionId}/mark-ready/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    }).then(response => {
        if (response.ok) {
            showSuccessMessage('Marked as ready!');
            setTimeout(() => location.reload(), 1500);
        }
    });
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
}

function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}