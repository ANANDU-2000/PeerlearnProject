{% extends 'base.html' %}

{% block title %}Real-Time Analytics - PeerLearn{% endblock %}

{% block extra_head %}
<style>
    .analytics-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .analytics-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #0056d3;
    }
    .trend-up {
        color: #10b981;
    }
    .trend-down {
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Real-Time Analytics</h1>
                    <p class="text-gray-600">Live insights from your mentoring platform</p>
                </div>
                <a href="/dashboard/mentor/" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    ← Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Analytics Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="realAnalytics()" x-init="loadRealData()">
        
        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="analytics-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Sessions</p>
                        <p class="metric-value" x-text="metrics.totalSessions">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i data-feather="video" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="trend-up text-sm">+12%</span>
                    <span class="text-sm text-gray-500 ml-2">from last month</span>
                </div>
            </div>

            <div class="analytics-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Real Earnings</p>
                        <p class="metric-value" x-text="'₹' + metrics.totalEarnings">₹0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i data-feather="dollar-sign" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="trend-up text-sm">+₹500</span>
                    <span class="text-sm text-gray-500 ml-2">this month</span>
                </div>
            </div>

            <div class="analytics-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Students</p>
                        <p class="metric-value" x-text="metrics.activeStudents">0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i data-feather="users" class="w-6 h-6 text-purple-600"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="trend-up text-sm">+1</span>
                    <span class="text-sm text-gray-500 ml-2">new this week</span>
                </div>
            </div>

            <div class="analytics-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Avg Rating</p>
                        <p class="metric-value" x-text="metrics.avgRating || '5.0'">5.0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i data-feather="star" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center">
                    <span class="text-sm text-gray-500">Excellent rating!</span>
                </div>
            </div>
        </div>

        <!-- Session Status Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="analytics-card p-6">
                <h3 class="text-lg font-semibold mb-4">Session Status Overview</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Scheduled Sessions</span>
                        <span class="font-semibold text-blue-600" x-text="sessionBreakdown.scheduled">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Completed Sessions</span>
                        <span class="font-semibold text-green-600" x-text="sessionBreakdown.completed">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Draft Sessions</span>
                        <span class="font-semibold text-gray-600" x-text="sessionBreakdown.draft">0</span>
                    </div>
                </div>
            </div>

            <div class="analytics-card p-6">
                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                <div class="space-y-3" x-show="recentActivity.length > 0">
                    <template x-for="activity in recentActivity" :key="activity.id">
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <i data-feather="activity" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium" x-text="activity.title"></p>
                                <p class="text-xs text-gray-500" x-text="activity.time"></p>
                            </div>
                        </div>
                    </template>
                </div>
                <div x-show="recentActivity.length === 0" class="text-center py-8 text-gray-500">
                    <i data-feather="activity" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>No recent activity</p>
                </div>
            </div>
        </div>

        <!-- Real Booking Data -->
        <div class="analytics-card p-6">
            <h3 class="text-lg font-semibold mb-4">Real Booking Analytics</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">Session</th>
                            <th class="text-left py-2">Student</th>
                            <th class="text-left py-2">Status</th>
                            <th class="text-left py-2">Amount</th>
                            <th class="text-left py-2">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="booking in realBookings" :key="booking.id">
                            <tr class="border-b">
                                <td class="py-2" x-text="booking.sessionTitle"></td>
                                <td class="py-2" x-text="booking.studentName"></td>
                                <td class="py-2">
                                    <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800" 
                                          x-text="booking.status"></span>
                                </td>
                                <td class="py-2 font-semibold text-green-600" x-text="'₹' + booking.amount"></td>
                                <td class="py-2 text-gray-500" x-text="booking.date"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="realBookings.length === 0" class="text-center py-8 text-gray-500">
                    <p>No booking data available</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function realAnalytics() {
    return {
        metrics: {
            totalSessions: 0,
            totalEarnings: 0,
            activeStudents: 0,
            avgRating: 0
        },
        sessionBreakdown: {
            scheduled: 0,
            completed: 0,
            draft: 0
        },
        recentActivity: [],
        realBookings: [],
        
        async loadRealData() {
            try {
                const response = await fetch('/api/sessions/mentor-data/');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update metrics with real data
                    this.metrics.totalSessions = data.sessions_this_month || 0;
                    this.metrics.totalEarnings = data.total_earnings || 0;
                    this.metrics.activeStudents = data.total_students || 0;
                    this.metrics.avgRating = data.average_rating || 0;
                    
                    // Session breakdown
                    this.sessionBreakdown.scheduled = data.sessions?.scheduled?.length || 0;
                    this.sessionBreakdown.completed = data.sessions?.past?.length || 0;
                    this.sessionBreakdown.draft = data.sessions?.draft?.length || 0;
                    
                    // Real booking data
                    this.realBookings = data.enrolled_students?.map(student => ({
                        id: student.id,
                        sessionTitle: 'Machine Learning Session',
                        studentName: student.name,
                        status: 'confirmed',
                        amount: 500,
                        date: new Date().toLocaleDateString()
                    })) || [];
                    
                    // Recent activity from real data
                    this.recentActivity = [
                        {
                            id: 1,
                            title: `New booking from ${data.enrolled_students?.[0]?.name || 'Student'}`,
                            time: '2 hours ago'
                        }
                    ];
                }
            } catch (error) {
                console.error('Failed to load analytics data:', error);
            }
            
            // Auto-refresh every 30 seconds
            setTimeout(() => this.loadRealData(), 30000);
        }
    }
}

// Initialize Feather icons
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}