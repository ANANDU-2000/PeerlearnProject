{% extends 'base.html' %}

{% block title %}Earnings & Analytics - PeerLearn{% endblock %}

{% block extra_head %}
<style>
    .earnings-bg {
        background: linear-gradient(135deg, #0056d3 0%, #1e40af 100%);
    }
    .stats-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 86, 211, 0.1);
        transition: all 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 86, 211, 0.15);
    }
    .earning-badge {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
    }
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="earningsData()">
    
    <!-- Header -->
    <div class="earnings-bg text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-4xl font-bold mb-2">Earnings & Analytics</h1>
                    <p class="text-blue-100">Track your mentoring income and performance</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button @click="requestPayout()" 
                            class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                        <i data-feather="download" class="h-5 w-5 inline mr-2"></i>
                        Request Payout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stats-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Earnings</p>
                        <p class="text-3xl font-bold text-gray-900" x-text="`₹${totalEarnings}`">₹0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i data-feather="dollar-sign" class="h-6 w-6 text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Available for Payout</p>
                        <p class="text-3xl font-bold text-gray-900" x-text="`₹${availableEarnings}`">₹0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-feather="credit-card" class="h-6 w-6 text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">This Month</p>
                        <p class="text-3xl font-bold text-gray-900" x-text="`₹${monthlyEarnings}`">₹0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i data-feather="calendar" class="h-6 w-6 text-purple-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Sessions Completed</p>
                        <p class="text-3xl font-bold text-gray-900" x-text="completedSessions">0</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-feather="check-circle" class="h-6 w-6 text-orange-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Earnings Chart -->
        <div class="chart-container mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Monthly Earnings Trend</h3>
            <canvas id="earningsChart" width="400" height="200"></canvas>
        </div>

        <!-- Payment History & Payout Requests -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Payment History -->
            <div class="stats-card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">Recent Payments</h3>
                <div class="space-y-4">
                    <template x-for="payment in recentPayments" :key="payment.id">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-medium text-gray-900" x-text="payment.session_title"></p>
                                <p class="text-sm text-gray-500" x-text="payment.date"></p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-600" x-text="`₹${payment.amount}`"></p>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    Completed
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Payout History -->
            <div class="stats-card p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">Payout History</h3>
                <div class="space-y-4">
                    <template x-for="payout in payoutHistory" :key="payout.id">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-medium text-gray-900" x-text="`Payout #${payout.id}`"></p>
                                <p class="text-sm text-gray-500" x-text="payout.date"></p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-blue-600" x-text="`₹${payout.amount}`"></p>
                                <span :class="`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${payout.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`"
                                      x-text="payout.status">
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function earningsData() {
    return {
        totalEarnings: 0,
        availableEarnings: 0,
        monthlyEarnings: 0,
        completedSessions: 0,
        recentPayments: [],
        payoutHistory: [],
        
        init() {
            this.loadEarningsData();
            this.initChart();
        },
        
        async loadEarningsData() {
            try {
                const response = await fetch('/api/mentor/earnings-data/');
                const data = await response.json();
                
                this.totalEarnings = data.total_earnings || 0;
                this.availableEarnings = data.available_earnings || 0;
                this.monthlyEarnings = data.monthly_earnings || 0;
                this.completedSessions = data.completed_sessions || 0;
                this.recentPayments = data.recent_payments || [];
                this.payoutHistory = data.payout_history || [];
            } catch (error) {
                console.error('Failed to load earnings data:', error);
            }
        },
        
        initChart() {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Monthly Earnings (₹)',
                        data: [1200, 1900, 3000, 2500, 3200, 2800],
                        borderColor: '#0056d3',
                        backgroundColor: 'rgba(0, 86, 211, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        }
                    }
                }
            });
        },
        
        async requestPayout() {
            if (this.availableEarnings <= 0) {
                alert('No earnings available for payout');
                return;
            }
            
            try {
                const response = await fetch('/api/mentor/request-payout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        amount: this.availableEarnings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Payout request submitted successfully!');
                    this.loadEarningsData();
                } else {
                    alert('Failed to submit payout request: ' + data.error);
                }
            } catch (error) {
                alert('Error submitting payout request');
            }
        }
    }
}
</script>
{% endblock %}